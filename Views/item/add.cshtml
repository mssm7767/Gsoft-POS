@using System.Linq
@using System.Collections.Generic
@using GSoftPosNew.Models
@model GSoftPosNew.Models.AddItemViewModel

@{
    ViewData["Title"] = "Add New Item";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var existingItems = Model?.ExistingItems ?? new List<ItemModel>();

    var supplierNames = existingItems
        .Where(x => x.Supplier != null && !string.IsNullOrWhiteSpace(x.Supplier.SupplierName))
        .Select(x => x.Supplier.SupplierName)
        .Distinct()
        .OrderBy(x => x)
        .ToList();

    var categoryNames = existingItems
        .Where(x => x.Category != null && !string.IsNullOrWhiteSpace(x.Category.Name))
        .Select(x => x.Category.Name)
        .Distinct()
        .OrderBy(x => x)
        .ToList();

    var recipeIngredients = ViewBag.RecipeIngredients as List<Ingredient> ?? new List<Ingredient>();
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
<link href="~/css/item-custom.css" rel="stylesheet" />

@* ===== Center SMS toast for Save / Delete etc. ===== *@
@if (TempData["Success"] != null)
{
    <div id="centerSmsSuccess" class="sms-message success">
        @TempData["Success"]
    </div>
}
@if (TempData["Danger"] != null)
{
    <div id="centerSmsDanger" class="sms-message danger">
        @TempData["Danger"]
    </div>
}

<div class="row">
    <!-- LEFT: ~40% Add Item Form -->
    <div class="col-lg-5 col-md-6">
        <!-- TOP BAR -->
        <div class="top-info-bar mb-2">
            <div>
                <i class="fa fa-user-circle"></i> @(@ViewBag.CurrentUser ?? "Admin")
            </div>
            <div>
                <i class="fa fa-clock"></i> <span id="currentTime"></span>
                <span class="ms-3">
                    <i class="fa fa-calendar"></i> <span id="currentDate"></span>
                </span>
            </div>
        </div>

        <!-- ADD ITEM FORM -->
        <div class="add-item-container">
            <div class="d-flex align-items-center mb-3">
                <h4 class="mb-0">
                    <i class="fa fa-plus-circle me-2"></i>
                    Add New Item
                </h4>
            </div>

            <form asp-action="Add" method="post" enctype="multipart/form-data" class="row g-2" id="addItemForm">
                @Html.AntiForgeryToken()

                <!-- Hidden existing id for duplicate case -->
                <input type="hidden" id="ExistingItemId" name="ExistingItemId" />

                <!-- Duplicate notice -->
                <div id="duplicateNotice" class="alert alert-warning d-none"></div>

                <!-- Item Code -->
                <div class="col-12 col-md-6">
                    <label asp-for="ItemData.ItemCode" class="form-label form-label-sm">
                        Item Code / Barcode <span class="text-danger">*</span>
                        <span class="text-muted small">(Ctrl + A.Auto Code)</span>
                    </label>
                    <div class="input-group input-group-sm">
                        <input asp-for="ItemData.ItemCode"
                               id="Item_ItemCode"
                               class="form-control form-control-sm barcode-blink"
                               placeholder="Scan or type barcode..."
                               autocomplete="off" />

                        <button type="button"
                                id="btnAutoCode"
                                class="btn btn-outline-secondary btn-sm"
                                title="Auto-generate code (Ctrl + A)">
                            <i class="fa fa-magic"></i>
                            <span class="d-none d-md-inline">Auto</span>
                        </button>
                    </div>
                    <span id="itemCodeMessage" style="color:red; font-size:12px;"></span>
                    @if (TempData["Error"] != null)
                    {
                        <span class="text-danger small">@TempData["Error"]</span>
                    }
                    @Html.ValidationMessageFor(m => m.ItemData.ItemCode, "", new { @class = "text-danger" })
                </div>

                <!-- Reference Code -->
                <div class="col-12 col-md-6">
                    <label asp-for="ItemData.ReferenceCode" class="form-label form-label-sm">Reference Code</label>
                    <input asp-for="ItemData.ReferenceCode" id="Item_ReferenceCode" class="form-control form-control-sm" />
                </div>

                <!-- Item Name -->
                <div class="col-12 col-md-6">
                    <label asp-for="ItemData.ItemName" class="form-label form-label-sm">
                        Item Name <span class="text-danger">*</span>
                    </label>
                    <input asp-for="ItemData.ItemName" id="Item_ItemName" class="form-control form-control-sm" />
                    <span id="itemNameMessage" style="color:red; font-size:12px;"></span>
                    @Html.ValidationMessageFor(m => m.ItemData.ItemName, "", new { @class = "text-danger" })
                </div>

                <!-- Flavour -->
                <div class="col-12 col-md-6">
                    <label asp-for="ItemData.Flavour" class="form-label form-label-sm">
                        Flavour
                    </label>
                    <div class="input-group input-group-sm">
                        <input asp-for="ItemData.Flavour"
                               id="Item_Flavour"
                               class="form-control form-control-sm"
                               list="flavourList"
                               placeholder="e.g., Spicy, Cheesy, BBQ..." />
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearFlavour" title="Clear">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    @Html.ValidationMessageFor(m => m.ItemData.Flavour, "", new { @class = "text-danger" })
                    <datalist id="flavourList">
                        <option value="Spicy"></option>
                        <option value="Cheesy"></option>
                        <option value="BBQ"></option>
                        <option value="Garlic"></option>
                        <option value="Mayo"></option>
                        <option value="Chocolate"></option>
                        <option value="Vanilla"></option>
                        <option value="Strawberry"></option>
                    </datalist>
                </div>

                <!-- Category -->
                <div class="col-12 col-md-6">
                    <label class="form-label form-label-sm">
                        Category <span class="text-danger">*</span>
                    </label>
                    <div class="input-group input-group-sm">
                        <select id="CategoryId" name="ItemData.CategoryId" class="form-select form-select-sm">
                            <option value="">Select category</option>
                            @foreach (var category in ViewBag.CategoryList)
                            {
                                <option value="@category.Value">@category.Text</option>
                            }
                        </select>
                        <a asp-controller="Category" asp-action="Create" class="btn btn-success btn-sm" title="Add Category">
                            <i class="fa fa-plus"></i>
                        </a>
                    </div>
                    <span asp-validation-for="ItemData.CategoryId" class="text-danger"></span>
                </div>

                <!-- Supplier -->
                <div class="col-12 col-md-6">
                    <label class="form-label form-label-sm">
                        Supplier <span class="text-danger">*</span>
                    </label>
                    <div class="input-group input-group-sm">
                        <select id="SupplierId" name="ItemData.SupplierId" class="form-select form-select-sm">
                            <option value="">Select supplier</option>
                            @foreach (var supplier in ViewBag.SupplierList)
                            {
                                <option value="@supplier.Value">@supplier.Text</option>
                            }
                        </select>
                        <a asp-controller="Supplier" asp-action="Create" class="btn btn-success btn-sm" title="Add Supplier">
                            <i class="fa fa-plus"></i>
                        </a>
                    </div>
                    <span asp-validation-for="ItemData.SupplierId" class="text-danger"></span>
                </div>

                <!-- Prices -->
                <div class="col-12 col-md-4">
                    <label asp-for="ItemData.SalePrice" class="form-label form-label-sm">
                        MRP Price (sale price) <span class="text-danger">*</span>
                    </label>
                    <input asp-for="ItemData.SalePrice" id="mrpPrice" class="form-control form-control-sm" type="number" step="0.01" />
                    @Html.ValidationMessageFor(m => m.ItemData.SalePrice, "", new { @class = "text-danger" })
                </div>

                <div class="col-12 col-md-4">
                    <label asp-for="ItemData.MarkupPercentage" class="form-label form-label-sm">Markup %</label>
                    <input asp-for="ItemData.MarkupPercentage" id="markupPct" class="form-control form-control-sm" type="number" step="0.01" />
                </div>

                <div class="col-12 col-md-4">
                    <label asp-for="ItemData.PurchasePrice" class="form-label form-label-sm">
                        Purchase Price (cost price) <span class="text-danger">*</span>
                    </label>
                    <input asp-for="ItemData.PurchasePrice" id="purchasePrice" class="form-control form-control-sm" type="number" step="0.01" />
                    @Html.ValidationMessageFor(m => m.ItemData.PurchasePrice, "", new { @class = "text-danger" })
                </div>

                <!-- Opening Qty -->
                <div class="col-12 col-md-6">
                    <label asp-for="ItemData.Quantity" class="form-label form-label-sm">Opening Qty</label>
                    <input asp-for="ItemData.Quantity" id="Item_Quantity" class="form-control form-control-sm" type="number" min="0" value="0" />
                </div>

                <!-- Image -->
                <div class="col-md-4">
                    <label class="form-label">
                        <i class="fa-solid fa-image text-primary me-1"></i> Item Image
                    </label>
                    <input type="file" name="ImageFile" id="ImageFile" class="form-control" />
                </div>

                <!-- More details + Recipe buttons -->
                <div class="col-12 d-flex align-items-center gap-3 mt-1">
                    <button class="btn btn-link text-primary fw-bold p-0" type="button"
                            id="btnMoreDetails"
                            style="font-size:1.02rem;"
                            onclick="toggleMoreDetails()">
                        <i class="fa fa-plus-circle" id="iconMoreDetails"></i> More Details (Optional)
                    </button>

                    <button class="btn btn-link text-success fw-bold p-0" type="button"
                            id="btnRecipeToggle"
                            style="font-size:1.02rem;"
                            onclick="toggleRecipeSection()">
                        <i class="fa fa-utensils" id="iconRecipe"></i> Add Recipe
                    </button>
                </div>

                <!-- More Details -->
                <div class="col-12" id="moreDetailsSection" style="display:none;">
                    <div class="card mb-2"
                         style="background: linear-gradient(90deg,#e9f8fe 70%,#d0f9e6 100%); border:1px solid #bde4fb;">
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label class="form-label form-label-sm">Sale Price 2</label>
                                    <input name="SalePrice2" id="SalePrice2" class="form-control form-control-sm"
                                           type="number" step="0.01" placeholder="Second Sale Price" />
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="ItemData.PackSize" class="form-label form-label-sm">Pack Size</label>
                                    <input asp-for="ItemData.PackSize" class="form-control form-control-sm" id="packsize" />
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="ItemData.UnitPrice" class="form-label form-label-sm">Unit Price</label>
                                    <input asp-for="ItemData.UnitPrice" class="form-control form-control-sm"
                                           id="unitprice" readonly />
                                </div>
                                <div class="col-md-4">
                                    <label asp-for="ItemData.PackPrice" class="form-label form-label-sm">Pack Price</label>
                                    <input asp-for="ItemData.PackPrice" class="form-control form-control-sm"
                                           type="number" id="packprice" readonly />
                                </div>

                                <div class="col-12 col-sm-6 col-md-4">
                                    <label class="form-label form-label-sm">
                                        Unit <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <select name="ItemData.UnitId" id="UnitId" class="form-select form-select-sm">
                                            <option value="">Select Unit</option>
                                            @foreach (var unit in ViewBag.UnitList)
                                            {
                                                <option value="@unit.Value">@unit.Text</option>
                                            }
                                        </select>
                                        <a asp-controller="Unit" asp-action="Create"
                                           class="btn btn-success btn-sm" title="Add Unit">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                    <span asp-validation-for="ItemData.SupplierId" class="text-danger"></span>
                                </div>

                                <div class="col-md-4">
                                    <label asp-for="ItemData.LocationId" class="form-label form-label-sm">
                                        Location <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <select asp-for="ItemData.LocationId" id="LocationId"
                                                asp-items="Model.LocationList"
                                                class="form-select form-select-sm">
                                            <option value="">Select Location</option>
                                        </select>
                                        <a asp-controller="Location" asp-action="Create"
                                           class="btn btn-success btn-sm" title="Add Location">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                    <span asp-validation-for="ItemData.LocationId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RECIPE CARD -->
                <div class="col-12" id="recipeSectionWrapper" style="display:none;">
                    <div class="card mb-2"
                         style="background: linear-gradient(90deg,#e9f8fe 70%,#d0f9e6 100%); border:1px solid #bde4fb;">
                        <div class="card-body p-3">

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fa fa-utensils text-success me-1"></i>
                                    Recipe (Raw Material / Ingredients)
                                </h6>
                                <button type="button"
                                        class="btn btn-sm btn-outline-success"
                                        onclick="addRecipeRow()">
                                    <i class="fa fa-plus"></i> Add Ingredient Row
                                </button>
                            </div>

                            <div class="alert alert-info py-2 mb-2" style="font-size:0.8rem;">
                                <i class="fa fa-lightbulb me-1"></i>
                                Yahan is item ke liye jo jo <strong>ingredients</strong> use honge,
                                unki quantity aur cost add karein.
                            </div>

                            <div class="table-responsive border rounded-3"
                                 style="background:#ffffff; max-height:260px; overflow:auto;">
                                <table class="table table-sm mb-0 align-middle" id="recipeTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width:26px;"></th>
                                            <th>Ingredient</th>
                                            <th>Category</th>
                                            <th style="width:90px;">Unit</th>
                                            <th style="width:90px;" class="text-end">Avail</th>
                                            <th style="width:90px;" class="text-end">Use</th>
                                            <th style="width:110px;" class="text-end">Cost/Unit</th>
                                            <th style="width:110px;" class="text-end">Line Total</th>
                                            <th style="width:40px;" class="text-center">Del</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- JS se rows add honge -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <div class="fw-bold">
                                    Total Recipe Cost:
                                    <span id="recipeGrandTotal" class="text-primary">0.00</span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label form-label-sm">
                                    Recipe / Item Picture (optional)
                                </label>
                                <input type="file"
                                       name="RecipeImage"
                                       class="form-control form-control-sm"
                                       accept="image/*" />
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Bottom Buttons -->
                <div class="col-12 d-flex justify-content-end mt-3 gap-2">
                    <button type="reset" id="btnClearAll" class="btn btn-secondary btn-sm">Clear</button>
                    <button type="submit" id="btnSaveNext" class="btn btn-primary btn-sm">Save &amp; Next</button>
                    <a href="@Url.Action("Index", "Home")" class="btn btn-danger btn-sm ms-2">Exit to Dashboard</a>
                </div>
            </form>
        </div>
    </div>

    <!-- RIGHT: ~60% Current Stock -->
    <div class="col-lg-7 col-md-6">
        <div class="card mb-4 mt-4 stock-card">
            <div class="search-bar-row">
                <input type="text"
                       id="searchItemInput"
                       class="form-control form-control-sm"
                       placeholder="Search item / code / supplier..." />

                <select id="filterSupplier" class="form-select form-select-sm" style="max-width:180px;">
                    <option value="">All Suppliers</option>
                    @foreach (var s in supplierNames)
                    {
                        <option value="@s">@s</option>
                    }
                </select>

                <select id="filterCategory" class="form-select form-select-sm" style="max-width:180px;">
                    <option value="">All Categories</option>
                    @foreach (var c in categoryNames)
                    {
                        <option value="@c">@c</option>
                    }
                </select>

                <button class="btn btn-primary btn-sm" type="button" onclick="searchTable()">
                    <i class="fa fa-search me-1"></i> Search
                </button>

                <button class="btn btn-secondary btn-sm ms-auto" type="button"
                        onclick="window.location.href='@Url.Action("Index", "Item")'">
                    <i class="fa fa-list me-1"></i> Stock List
                </button>
            </div>

            <div class="card-header">
                Current Stock
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:480px; overflow-y:auto;">
                    <table id="stockTable" class="table table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="form-label-sm">Code</th>
                                <th class="form-label-sm">Name</th>
                                <th class="form-label-sm">Category</th>
                                <th class="form-label-sm">Supplier</th>
                                <th class="form-label-sm">Qty</th>
                                <th class="form-label-sm">Purchase PKR</th>
                                <th class="form-label-sm">Sale PKR</th>
                                <th class="form-label-sm">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stockBody">
                            @foreach (var it in existingItems)
                            {
                                var supplierName = it.Supplier?.SupplierName ?? "";
                                var categoryName = it.Category?.Name ?? "";

                                <tr data-supplier="@supplierName"
                                    data-category="@categoryName">
                                    <td class="form-label-sm">@it.ItemCode</td>
                                    <td class="form-label-sm">@it.ItemName</td>
                                    <td class="form-label-sm">@categoryName</td>
                                    <td class="form-label-sm">@supplierName</td>
                                    <td class="form-label-sm">@it.Quantity</td>
                                    <td class="form-label-sm">@it.PurchasePrice.ToString("0.00")</td>
                                    <td class="form-label-sm">@it.SalePrice.ToString("0.00")</td>
                                    <td class="form-label-sm">
                                        <a asp-action="Edit" asp-route-id="@it.Id"
                                           class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <form asp-action="Delete" asp-route-id="@it.Id" method="post" style="display:inline">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Confirm delete?');" title="Delete">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ========== Center SMS toast (Save/Delete) ==========
        document.addEventListener('DOMContentLoaded', function () {
            ['centerSmsSuccess', 'centerSmsDanger'].forEach(function (id) {
                const el = document.getElementById(id);
                if (!el) return;
                setTimeout(() => el.classList.add('show'), 50);
                setTimeout(() => el.classList.remove('show'), 1100);
                setTimeout(() => el.remove(), 1500);
            });
        });
    </script>

    <script>
        const input = document.getElementById("Item_ItemCode");
        const message = document.getElementById("itemCodeMessage");

        if (input) {
            input.addEventListener("input", function () {
                const code = input.value.trim();
                if (code.length < 1) {
                    message.textContent = "";
                    return;
                }

                fetch(`/Item/CheckItemCode?itemCode=${encodeURIComponent(code)}`)
                    .then(res => res.json())
                    .then(exists => {
                        if (exists) {
                            message.textContent = "This Item Code already exists!";
                        } else {
                            message.textContent = "";
                        }
                    });
            });
        }
    </script>

    <script>
        // =================== Time & Date ===================
        function updateDateTime() {
            const now = new Date();
            document.getElementById("currentTime")?.replaceChildren(document.createTextNode(now.toLocaleTimeString()));
            document.getElementById("currentDate")?.replaceChildren(document.createTextNode(now.toLocaleDateString()));
        }
        setInterval(updateDateTime, 1000); updateDateTime();

        // =================== Helpers ===================
        function qs(sel, root=document){ return root.querySelector(sel); }
        function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
        function byText(root, tag, text){
            return qsa(tag, root).find(b => (b.textContent||'').trim().toLowerCase() === text.trim().toLowerCase());
        }

        const addForm = qs('#addItemForm') || qs('.add-item-container form') || document.forms[0];
        const btnSaveNext = document.getElementById('btnSaveNext') || byText(addForm||document, 'button', 'Save & Next') || qs('button[type="submit"]', addForm||document);
        const btnClearAll = document.getElementById('btnClearAll') || byText(addForm||document, 'button', 'Clear') || qs('button[type="reset"]', addForm||document);

        const codeInput = document.getElementById('Item_ItemCode');
        const refInput  = document.getElementById('Item_ReferenceCode') || qs('input[name="ItemData.ReferenceCode"]');
        const nameInput2 = document.getElementById('Item_ItemName')      || qs('input[name="ItemData.ItemName"]');
        const flavInput  = document.getElementById('Item_Flavour')       || qs('input[name="ItemData.Flavour"]');
        const catSel     = document.getElementById('CategoryId')         || qs('select[name="ItemData.CategoryId"]');
        const supSel     = document.getElementById('SupplierId')         || qs('select[name="ItemData.SupplierId"]');
        const qtyInput   = document.getElementById('Item_Quantity')      || qs('input[name="ItemData.Quantity"]');
        const imgInput   = document.getElementById('ImageFile')          || qs('input[name="ImageFile"]');

        let duplicateNotice = document.getElementById('duplicateNotice');
        if(!duplicateNotice && codeInput){
            duplicateNotice = document.createElement('div');
            duplicateNotice.id = 'duplicateNotice';
            duplicateNotice.className = 'alert alert-warning d-none mt-2';
            const wrap = codeInput.closest('.col-12, .col-md-6, .mb-3') || codeInput.parentElement;
            wrap?.appendChild(duplicateNotice);
        }

        // =================== Auto-generate code (button + Ctrl+A) ===================
        (function(){
            const btn = document.getElementById('btnAutoCode');
            if (!btn || !codeInput) return;

            function generateCode() {
                fetch('@Url.Action("GetNextCode", "Item")')
                    .then(r => { if(!r.ok) throw 0; return r.json(); })
                    .then(code => {
                        codeInput.value = code;
                        codeInput.dispatchEvent(new Event('input'));
                        if (refInput) {
                            refInput.focus();
                            refInput.select?.();
                        }
                    })
                    .catch(() => alert("Cannot generate code"));
            }

            btn.addEventListener('click', generateCode);

            // Ctrl + A shortcut
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey && (e.key === 'a' || e.key === 'A')) {
                    e.preventDefault();
                    generateCode();
                }
            });
        })();

        // =================== Prices auto-calc ===================
        (function(){
            const mrpEl = document.getElementById('mrpPrice');
            const pctEl = document.getElementById('markupPct');
            const purchEl = document.getElementById('purchasePrice');

            function updatePurchasePrice() {
                const mrp = parseFloat(mrpEl?.value);
                const pct = parseFloat(pctEl?.value);
                if (!purchEl) return;
                if (!isNaN(mrp)) {
                    if (!isNaN(pct) && pct !== 0) {
                        purchEl.value = (mrp * (100 - pct) / 100).toFixed(2);
                        purchEl.readOnly = true;
                    } else {
                        purchEl.value = (mrp * (100 - (pct || 0)) / 100).toFixed(2);
                        purchEl.readOnly = false;
                    }
                } else {
                    purchEl.value = '';
                    purchEl.readOnly = false;
                }
            }
            mrpEl?.addEventListener('input', updatePurchasePrice);
            pctEl?.addEventListener('input', updatePurchasePrice);

            purchEl?.addEventListener("input", function () {
                const mrp = parseFloat(mrpEl?.value);
                const purch = parseFloat(purchEl?.value);
                if (!isNaN(mrp) && mrp > 0 && !isNaN(purch) && purch > 0) {
                    const pct = ((mrp - purch) / mrp) * 100;
                    if (pctEl) pctEl.value = pct.toFixed(0);
                } else {
                    if (pctEl) pctEl.value = "";
                }
            });

            const packSizeInput = document.getElementById("packsize")   || qs('input[name="ItemData.PackSize"]');
            const unitPriceInput = document.getElementById("unitprice") || qs('input[name="ItemData.UnitPrice"]');
            const packPriceInput = document.getElementById("packprice") || qs('input[name="ItemData.PackPrice"]');
            function calculatePrices() {
                const packSize = parseFloat(packSizeInput?.value) || 0;
                const mrpPrice = parseFloat(mrpEl?.value) || 0;
                if (packSize > 0) {
                    const unitPrice = mrpPrice / packSize;
                    const packPrice = packSize * unitPrice;
                    if (unitPriceInput) unitPriceInput.value = unitPrice.toFixed(2);
                    if (packPriceInput) packPriceInput.value = packPrice.toFixed(2);
                } else {
                    if (unitPriceInput) unitPriceInput.value = "";
                    if (packPriceInput) packPriceInput.value = "";
                }
            }
            packSizeInput?.addEventListener("keyup", calculatePrices);
            mrpEl?.addEventListener("keyup", calculatePrices);
        })();

        // =================== Flavour clear ===================
        document.getElementById('btnClearFlavour')?.addEventListener('click', () => {
            if (flavInput) { flavInput.value = ''; flavInput.focus(); }
        });

        // =================== Stock search (AJAX) ===================
        function renderStockRows(items) {
            const tbody = document.querySelector('#stockTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!items || !items.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-2">No items found</td>
                    </tr>`;
                return;
            }

            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-supplier', it.supplierName ?? '');
                tr.setAttribute('data-category', it.categoryName ?? '');

                tr.innerHTML = `
                    <td class="form-label-sm">${it.itemCode ?? ''}</td>
                    <td class="form-label-sm">${it.itemName ?? ''}</td>
                    <td class="form-label-sm">${it.categoryName ?? ''}</td>
                    <td class="form-label-sm">${it.supplierName ?? ''}</td>
                    <td class="form-label-sm">${it.quantity ?? 0}</td>
                    <td class="form-label-sm">${(it.purchasePrice ?? 0).toFixed(2)}</td>
                    <td class="form-label-sm">${(it.salePrice ?? 0).toFixed(2)}</td>
                    <td class="form-label-sm">
                        <a href="/Item/Edit/${it.id}" class="btn btn-sm btn-outline-primary me-1" title="Edit">
                            <i class="fa fa-edit"></i>
                        </a>
                        <form action="/Item/Delete/${it.id}" method="post" style="display:inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Confirm delete?');" title="Delete">
                                <i class="fa fa-trash"></i>
                            </button>
                        </form>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        function searchTable() {
            const text = (document.getElementById("searchItemInput")?.value || "").trim();
            const sup  = (document.getElementById("filterSupplier")?.value || "").trim();
            const cat  = (document.getElementById("filterCategory")?.value || "").trim();

            const url = '@Url.Action("SearchStockAjax", "Item")'
                + `?search=${encodeURIComponent(text)}`
                + `&supplier=${encodeURIComponent(sup)}`
                + `&category=${encodeURIComponent(cat)}`;

            fetch(url)
                .then(r => {
                    if (!r.ok) throw new Error("Network error");
                    return r.json();
                })
                .then(data => {
                    renderStockRows(data);
                })
                .catch(() => {
                    alert("Error loading stock items.");
                });
        }
        window.searchTable = searchTable;

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("searchItemInput")?.addEventListener("keyup", function (e) {
                if (e.key === "Enter") {
                    searchTable();
                }
            });
            document.getElementById("filterSupplier")?.addEventListener("change", searchTable);
            document.getElementById("filterCategory")?.addEventListener("change", searchTable);
        });

        // =================== More details toggle ===================
        function toggleMoreDetails() {
            const section = document.getElementById('moreDetailsSection');
            const icon = document.getElementById('iconMoreDetails');
            if (!section || !icon) return;
            if (section.style.display === "none" || section.style.display === "") {
                section.style.display = "block";
                icon.classList.remove("fa-plus-circle");
                icon.classList.add("fa-minus-circle");
            } else {
                section.style.display = "none";
                icon.classList.remove("fa-minus-circle");
                icon.classList.add("fa-plus-circle");
            }
        }
        window.toggleMoreDetails = toggleMoreDetails;

        // =================== ENTER FLOW ===================
        (function(){
            const flow = [
                'Item_ItemCode','Item_ReferenceCode','Item_ItemName','Item_Flavour',
                (catSel && catSel.id) || 'CategoryId',
                (supSel && supSel.id) || 'SupplierId',
                'mrpPrice','markupPct','purchasePrice','Item_Quantity','ImageFile','btnSaveNext'
            ].filter(Boolean);

            function focusNext(currId){
                const i = flow.indexOf(currId);
                if (i >= 0 && i < flow.length - 1) {
                    const nx = document.getElementById(flow[i+1]) ||
                               (flow[i+1]==='btnSaveNext' ? btnSaveNext : null);
                    if (nx) { nx.focus(); if (nx.select && nx.tagName === 'INPUT') nx.select(); }
                }
            }

            flow.forEach(id=>{
                const el = (id==='btnSaveNext') ? btnSaveNext : document.getElementById(id);
                if(!el) return;
                el.addEventListener('keydown', (e)=>{
                    if(e.key === 'Enter'){
                        e.preventDefault();
                        if(id === 'btnSaveNext'){ btnSaveNext?.click(); return; }
                        focusNext(id);
                    }
                });
            });
        })();

        // =================== Duplicate check (instant autofill) ===================
        (function () {
            if (!codeInput) return;

            function setVal(el, v){ if(el) el.value = (v ?? ''); }
            function fillFromItem(it){
                setVal(refInput, it.referenceCode);
                setVal(nameInput2, it.itemName);
                setVal(flavInput, it.flavour);
                setVal(document.getElementById('mrpPrice'),      it.salePrice);
                setVal(document.getElementById('markupPct'),     it.markupPercentage);
                setVal(document.getElementById('purchasePrice'), it.purchasePrice);
                setVal(qtyInput, it.quantity);
                setVal(document.getElementById('packsize'),      it.packSize);
                setVal(document.getElementById('unitprice'),     it.unitPrice);
                setVal(document.getElementById('packprice'),     it.packPrice);

                if (catSel && it.categoryId) catSel.value = String(it.categoryId);
                if (supSel && it.supplierId) supSel.value = String(it.supplierId);
            }
            function showDuplicate(it){
                if (duplicateNotice){
                    const editUrl = '@Url.Action("Edit", "Item")' + '/' + it.id;
                    duplicateNotice.innerHTML = `
                        <i class="fa fa-triangle-exclamation me-1"></i>
                        <strong>Already Saved:</strong> Item code <b>${it.itemCode}</b> is already in inventory.
                        <a href="${editUrl}" class="btn btn-sm btn-outline-primary ms-2">
                          <i class="fa fa-pen-to-square"></i> Edit This Item
                        </a>`;
                    duplicateNotice.classList.remove('d-none');
                }
                if (btnSaveNext){
                    btnSaveNext.disabled = true;
                    btnSaveNext.classList.add('disabled');
                    btnSaveNext.title = 'This code already exists. Use Edit.';
                }
            }
            function clearDuplicate(){
                if (duplicateNotice){
                    duplicateNotice.classList.add('d-none');
                    duplicateNotice.innerHTML = '';
                }
                if (btnSaveNext){
                    btnSaveNext.disabled = false;
                    btnSaveNext.classList.remove('disabled');
                    btnSaveNext.removeAttribute('title');
                }
            }

            let lastChecked = '';
            function checkCodeImmediate(){
                const code = (codeInput.value || '').trim();
                if (!code){ clearDuplicate(); lastChecked=''; return; }
                if (code === lastChecked) return;
                lastChecked = code;

                fetch('@Url.Action("CheckCode", "Item")' + '?code=' + encodeURIComponent(code))
                  .then(r=>r.json())
                  .then(res=>{
                      if(res && res.exists && res.item){
                          fillFromItem(res.item);
                          showDuplicate(res.item);
                      }else{
                          clearDuplicate();
                      }
                  })
                  .catch(()=>{/* ignore */});
            }

            codeInput.addEventListener('input',  checkCodeImmediate);
            codeInput.addEventListener('change', checkCodeImmediate);
            codeInput.addEventListener('blur',   checkCodeImmediate);
            codeInput.addEventListener('keydown', function(e){
                if (e.key === 'Enter') { e.preventDefault(); checkCodeImmediate(); }
            });

            btnClearAll?.addEventListener('click', ()=>{
                setTimeout(clearDuplicate, 0);
                lastChecked='';
            });
        })();

        // =================== Save & Next → focus barcode next load ===================
        (function(){
            btnSaveNext?.addEventListener('click', ()=>{
                sessionStorage.setItem('focusBarcodeNext','1');
            });
            document.addEventListener('DOMContentLoaded', ()=>{
                const wantFocus = sessionStorage.getItem('focusBarcodeNext') === '1';
                if (wantFocus || true){
                    codeInput?.focus(); codeInput?.select?.();
                }
                sessionStorage.removeItem('focusBarcodeNext');
            });
        })();

        // =================== Clear button → refresh, keep Supplier/Category ===================
        (function(){
            btnClearAll?.addEventListener('click', function(e){
                e.preventDefault();
                const cat = catSel?.value || '';
                const sup = supSel?.value || '';
                sessionStorage.setItem('persistCat', cat);
                sessionStorage.setItem('persistSup', sup);
                sessionStorage.setItem('focusBarcodeNext', '1');
                location.reload();
            });

            document.addEventListener('DOMContentLoaded', ()=>{
                const cat = sessionStorage.getItem('persistCat');
                const sup = sessionStorage.getItem('persistSup');
                if (cat !== null && catSel) catSel.value = cat;
                if (sup !== null && supSel) supSel.value = sup;
                sessionStorage.removeItem('persistCat');
                sessionStorage.removeItem('persistSup');
            });
        })();

        // =================== Barcode blink remove on input ===================
        (function(){
            if (codeInput) {
                function removeBlink() {
                    codeInput.classList.remove("barcode-blink");
                    codeInput.removeEventListener('input', removeBlink);
                }
                codeInput.addEventListener('input', removeBlink);
            }
        })();
    </script>

    <script>
        // ================= RECIPE SECTION TOGGLE =================
        function toggleRecipeSection() {
            const wrapper = document.getElementById('recipeSectionWrapper');
            const icon = document.getElementById('iconRecipe');
            if (!wrapper) return;

            const shouldShow = (wrapper.style.display === 'none' || wrapper.style.display === '');
            wrapper.style.display = shouldShow ? 'block' : 'none';

            if (icon) {
                if (shouldShow) {
                    icon.classList.add('fa-minus-circle');
                    icon.classList.remove('fa-utensils');
                } else {
                    icon.classList.remove('fa-minus-circle');
                    icon.classList.add('fa-utensils');
                }
            }
        }

        // ================= RECIPE ROW TEMPLATE =================
        function addRecipeRow() {
            const tbody = document.querySelector('#recipeTable tbody');
            const index = tbody.rows.length;

            const row = document.createElement('tr');

            row.innerHTML = `
                <td class="text-center">
                    <i class="fa fa-grip-vertical"></i>
                </td>

                <td>
                    <select name="RecipeIngredients[${index}].IngredientId"
                            class="form-select form-select-sm recipe-ing-select">
                        <option value="">Select...</option>
                        @foreach (var ing in recipeIngredients)
                        {
                                    var unitText = !string.IsNullOrWhiteSpace(ing.ConsumptionUnit)
                                                                                                                    ? ing.ConsumptionUnit
                                                                                                                    : ing.PurchaseUnit;
                                    var avail = ing.PurchaseQty ?? 0;
                                    var cpu = ing.CostPerUnit ?? 0;

                                    <text>
                                    <option value="@ing.Id"
                                            data-cat="@Html.Raw(ing.Category?.Name ?? "")"
                                            data-unit="@Html.Raw(unitText ?? "")"
                                            data-avail="@avail"
                                            data-cpu="@cpu">
                                        @ing.Name (@unitText)
                                    </option>
                                    </text>
                        }
                    </select>
                </td>

                <td>
                    <span class="recipe-cat small text-muted"></span>
                </td>

                <td>
                    <input name="RecipeIngredients[${index}].Unit"
                           class="form-control form-control-sm recipe-unit" readonly />
                </td>

                <td class="text-end">
                    <input name="RecipeIngredients[${index}].AvailQty"
                           class="form-control form-control-sm text-end recipe-avail" readonly />
                </td>

                <td class="text-end">
                    <input name="RecipeIngredients[${index}].UseQty"
                           class="form-control form-control-sm text-end recipe-use" value="0" />
                </td>

                <td class="text-end">
                    <input name="RecipeIngredients[${index}].CostPerUnit"
                           class="form-control form-control-sm text-end recipe-cpu" readonly />
                </td>

                <td class="text-end">
                    <input name="RecipeIngredients[${index}].LineTotal"
                           class="form-control form-control-sm text-end recipe-line-total" readonly />
                </td>

                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger"
                            onclick="deleteRecipeRow(this)">
                        <i class="fa fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);

            const sel = row.querySelector('.recipe-ing-select');
            const use = row.querySelector('.recipe-use');

            if (sel) sel.addEventListener('change', onIngredientChange);
            if (use) use.addEventListener('input', recalcRecipeRowTotal);

        }

        function deleteRecipeRow(btn) {
            const tr = btn.closest('tr');
            if (!tr) return;
            tr.remove();
            recalcRecipeGrandTotal();
        }

        function onIngredientChange(e) {
            const sel = e.target;
            const tr = sel.closest('tr');
            if (!tr) return;

            const opt = sel.selectedOptions[0];
            if (!opt) return;

            const catName = opt.getAttribute('data-cat') || '';
            const unit = opt.getAttribute('data-unit') || '';
            const avail = opt.getAttribute('data-avail') || '0';
            const cpu = opt.getAttribute('data-cpu') || '0';

            const catSpan = tr.querySelector('.recipe-cat');
            const unitInput = tr.querySelector('.recipe-unit');
            const availInput = tr.querySelector('.recipe-avail');
            const cpuInput = tr.querySelector('.recipe-cpu');

            if (catSpan) catSpan.textContent = catName;
            if (unitInput) unitInput.value = unit;
            if (availInput) availInput.value = parseFloat(avail).toFixed(2);
            if (cpuInput) cpuInput.value = parseFloat(cpu).toFixed(4);

            recalcRecipeRowTotal.call(tr);
        }

        function recalcRecipeRowTotal() {
            const tr = this.closest ? this.closest('tr') : this;
            if (!tr) return;

            const useInput = tr.querySelector('.recipe-use');
            const cpuInput = tr.querySelector('.recipe-cpu');
            const totalInput = tr.querySelector('.recipe-line-total');

            const useQty = parseFloat(useInput?.value || '0');
            const cpu = parseFloat(cpuInput?.value || '0');

            const total = (useQty > 0 && cpu > 0) ? (useQty * cpu) : 0;
            if (totalInput) totalInput.value = total.toFixed(4);

            recalcRecipeGrandTotal();
        }

        function recalcRecipeGrandTotal() {
            let sum = 0;
            document.querySelectorAll('.recipe-line-total').forEach(inp => {
                const v = parseFloat(inp.value || '0');
                if (!isNaN(v)) sum += v;
            });
            const tgt = document.getElementById('recipeGrandTotal');
            if (tgt) tgt.textContent = sum.toFixed(2);
        }

        document.addEventListener('DOMContentLoaded', function () {
            // optional: addRecipeRow();
        });
    </script>
}

