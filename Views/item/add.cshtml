@using System.Linq
@using System.Collections.Generic
@using GSoftPosNew.Models
@model GSoftPosNew.Models.AddItemViewModel

@{
    ViewData["Title"] = "Add New Item";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var existingItems = Model?.ExistingItems ?? new List<ItemModel>();

    var supplierNames = existingItems
        .Where(x => x.Supplier != null && !string.IsNullOrWhiteSpace(x.Supplier.SupplierName))
        .Select(x => x.Supplier.SupplierName)
        .Distinct()
        .OrderBy(x => x)
        .ToList();

    var categoryNames = existingItems
        .Where(x => x.Category != null && !string.IsNullOrWhiteSpace(x.Category.Name))
        .Select(x => x.Category.Name)
        .Distinct()
        .OrderBy(x => x)
        .ToList();

    var recipeIngredients = ViewBag.RecipeIngredients as List<Ingredient> ?? new List<Ingredient>();
}

@section Styles {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/css/item-custom.css" rel="stylesheet" asp-append-version="true" />
}

@if (TempData["Success"] != null)
{
    <div id="centerSmsSuccess" class="sms-message success">@TempData["Success"]</div>
}
@if (TempData["Danger"] != null)
{
    <div id="centerSmsDanger" class="sms-message danger">@TempData["Danger"]</div>
}

<!-- ✅ Confirm Modal for MultiBarcodes -->
<div class="modal fade" id="mbConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content mb-modal">
            <div class="modal-header mb-modal-header">
                <h5 class="modal-title">
                    <i class="fa fa-barcode me-2"></i> Save Multi Barcodes?
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="fw-bold">Do you want to save Multi Barcodes with this item?</div>
                <div class="text-muted small mt-1">
                    Yes = barcodes add karo, phir “Save Multi Barcodes” dabao.<br />
                    No = barcodes ignore, next item start.
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-light" id="mbNoBtn">
                    <i class="fa fa-times me-1"></i> No
                </button>
                <button type="button" class="btn btn-primary" id="mbYesBtn">
                    <i class="fa fa-check me-1"></i> Yes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ TOP AREA WRAPPER -->
<div class="additem-page">

    <!-- ✅ TOP ROW (LEFT 70% + RIGHT 30%) -->
    <div class="row g-3" id="addItemTopRow">

        <!-- LEFT -->
        <div class="col-12 col-lg-8 additem-left">
            <div class="add-item-container">

                <!-- ✅ Compact header -->
                <div class="additem-header">
                    <div class="additem-title">
                        <i class="fa fa-plus-circle me-2"></i>
                        <span>Add New Item</span>
                    </div>

                    <div class="additem-meta">
                        <span class="meta-pill">
                            <i class="fa fa-user-circle me-1"></i> @(@ViewBag.CurrentUser ?? "Admin")
                        </span>
                        <span class="meta-pill">
                            <i class="fa fa-clock me-1"></i> <span id="currentTime"></span>
                        </span>
                        <span class="meta-pill">
                            <i class="fa fa-calendar me-1"></i> <span id="currentDate"></span>
                        </span>
                    </div>
                </div>

                <div class="section-divider"></div>

                <form asp-action="Add" method="post" enctype="multipart/form-data" class="row g-2" id="addItemForm" autocomplete="off">
                    @Html.AntiForgeryToken()

                    <!-- used by AJAX flow -->
                    <input type="hidden" id="ExistingItemId" name="ExistingItemId" />
                    <input asp-for="ItemData.Id" type="hidden" id="itemId" />
                    <div id="duplicateNotice" class="alert alert-warning d-none"></div>

                    <!-- ✅ HEADING: Item Details -->
                    <div class="col-12">
                        <div class="mini-head">
                            <i class="fa fa-pen-to-square"></i>
                            <span>Item Details</span>
                        </div>
                    </div>

                    <!-- Item Code -->
                    <div class="col-12 col-md-6">
                        <label asp-for="ItemData.ItemCode" class="form-label form-label-sm">
                            Item Code / Barcode <span class="text-danger">*</span>
                            <span class="text-muted small">(Ctrl+A Auto Code)</span>
                        </label>

                        <div class="input-group input-group-sm">
                            <input asp-for="ItemData.ItemCode"
                                   id="Item_ItemCode"
                                   class="form-control form-control-sm barcode-blink"
                                   placeholder="Scan or type barcode..."
                                   autocomplete="off" />
                            <button type="button"
                                    id="btnAutoCode"
                                    class="btn btn-outline-secondary btn-sm"
                                    title="Auto-generate code (Ctrl + A)">
                                <i class="fa fa-magic"></i>
                                <span class="d-none d-md-inline">Auto</span>
                            </button>
                        </div>

                        <span id="itemCodeMessage" class="field-note text-danger"></span>
                        @Html.ValidationMessageFor(m => m.ItemData.ItemCode, "", new { @class = "text-danger small" })
                    </div>

                    <!-- Reference Code -->
                    <div class="col-12 col-md-6">
                        <label asp-for="ItemData.ReferenceCode" class="form-label form-label-sm">Reference Code</label>
                        <input asp-for="ItemData.ReferenceCode" id="Item_ReferenceCode" class="form-control form-control-sm" />
                    </div>

                    <!-- Item Name -->
                    <div class="col-12 col-md-6">
                        <label asp-for="ItemData.ItemName" class="form-label form-label-sm">
                            Item Name <span class="text-danger">*</span>
                        </label>
                        <input asp-for="ItemData.ItemName" id="Item_ItemName" class="form-control form-control-sm" />
                        <span id="itemNameMessage" class="field-note text-danger"></span>
                        @Html.ValidationMessageFor(m => m.ItemData.ItemName, "", new { @class = "text-danger small" })
                    </div>

                    <!-- Flavour -->
                    <div class="col-12 col-md-6">
                        <label asp-for="ItemData.Flavour" class="form-label form-label-sm">Flavour</label>
                        <div class="input-group input-group-sm">
                            <input asp-for="ItemData.Flavour"
                                   id="Item_Flavour"
                                   class="form-control form-control-sm"
                                   list="flavourList"
                                   placeholder="e.g., Spicy, Cheesy, BBQ..." />
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnClearFlavour" title="Clear">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                        @Html.ValidationMessageFor(m => m.ItemData.Flavour, "", new { @class = "text-danger small" })

                        <datalist id="flavourList">
                            <option value="Spicy"></option>
                            <option value="Cheesy"></option>
                            <option value="BBQ"></option>
                            <option value="Garlic"></option>
                            <option value="Mayo"></option>
                            <option value="Chocolate"></option>
                            <option value="Vanilla"></option>
                            <option value="Strawberry"></option>
                        </datalist>
                    </div>

                    <!-- Category -->
                    <div class="col-12 col-md-6">
                        <label class="form-label form-label-sm">Category <span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <select id="CategoryId" name="ItemData.CategoryId" class="form-select form-select-sm">
                                <option value="">Select category</option>
                                @foreach (var category in ViewBag.CategoryList)
                                {
                                    <option value="@category.Value">@category.Text</option>
                                }
                            </select>
                            <a asp-controller="Category" asp-action="Create" class="btn btn-success btn-sm" title="Add Category">
                                <i class="fa fa-plus"></i>
                            </a>
                        </div>
                        <span asp-validation-for="ItemData.CategoryId" class="text-danger small"></span>
                    </div>

                    <!-- Supplier -->
                    <div class="col-12 col-md-6">
                        <label class="form-label form-label-sm">Supplier <span class="text-danger">*</span></label>
                        <div class="input-group input-group-sm">
                            <select id="SupplierId" name="ItemData.SupplierId" class="form-select form-select-sm">
                                <option value="">Select supplier</option>
                                @foreach (var supplier in ViewBag.SupplierList)
                                {
                                    <option value="@supplier.Value">@supplier.Text</option>
                                }
                            </select>
                            <a asp-controller="Supplier" asp-action="Create" class="btn btn-success btn-sm" title="Add Supplier">
                                <i class="fa fa-plus"></i>
                            </a>
                        </div>
                        <span asp-validation-for="ItemData.SupplierId" class="text-danger small"></span>
                    </div>

                    <!-- ✅ HEADING: Pricing & Stock -->
                    <div class="col-12 mt-1">
                        <div class="mini-head">
                            <i class="fa fa-money-bill-wave"></i>
                            <span>Pricing & Stock</span>
                        </div>
                    </div>

                    <!-- PRICES -->
                    <div id="priceRow" class="row g-2 w-100 m-0">
                        <div id="saleWrap" class="col-12 col-md-4">
                            <label asp-for="ItemData.SalePrice" class="form-label form-label-sm">
                                MRP (Sale Price) <span class="text-danger">*</span>
                            </label>
                            <input asp-for="ItemData.SalePrice" id="mrpPrice" class="form-control form-control-sm" type="number" step="0.01" />
                            @Html.ValidationMessageFor(m => m.ItemData.SalePrice, "", new { @class = "text-danger small" })
                        </div>

                        <div id="markupWrap" class="col-12 col-md-4">
                            <label asp-for="ItemData.MarkupPercentage" class="form-label form-label-sm">Markup %</label>
                            <input asp-for="ItemData.MarkupPercentage" id="markupPct" class="form-control form-control-sm" type="number" step="0.01" />
                        </div>

                        <div id="costWrap" class="col-12 col-md-4">
                            <label asp-for="ItemData.PurchasePrice" class="form-label form-label-sm">
                                Purchase (Cost) <span class="text-danger">*</span>
                            </label>
                            <input asp-for="ItemData.PurchasePrice" id="purchasePrice" class="form-control form-control-sm" type="number" step="0.01" />
                            @Html.ValidationMessageFor(m => m.ItemData.PurchasePrice, "", new { @class = "text-danger small" })
                        </div>
                    </div>

                    <!-- Markup Type -->
                    <div class="col-12">
                        <div class="markup-bar">
                            <div class="small fw-bold text-muted">Markup Type:</div>

                            <label class="d-flex align-items-center gap-1 small mb-0">
                                <input type="radio" name="MarkupType" id="mtSale" value="sale" checked />
                                On Sale (MRP)
                            </label>

                            <label class="d-flex align-items-center gap-1 small mb-0">
                                <input type="radio" name="MarkupType" id="mtCost" value="cost" />
                                On Cost (Purchase)
                            </label>
                        </div>
                    </div>

                    <!-- Opening Qty -->
                    <div class="col-12 col-md-6">
                        <label asp-for="ItemData.Quantity" class="form-label form-label-sm">Opening Qty</label>
                        <input asp-for="ItemData.Quantity" id="Item_Quantity" class="form-control form-control-sm" type="number" min="0" value="0" />
                    </div>

                    <!-- Image -->
                    <div class="col-12 col-md-6">
                        <label class="form-label form-label-sm">
                            <i class="fa-solid fa-image text-primary me-1"></i> Item Image
                        </label>
                        <input type="file" name="ImageFile" id="ImageFile" class="form-control form-control-sm" />
                    </div>

                    <!-- More details + Recipe buttons -->
                    <div class="col-12 d-flex align-items-center gap-3 mt-1">
                        <button class="btn btn-link text-primary fw-bold p-0" type="button"
                                id="btnMoreDetails"
                                onclick="toggleMoreDetails()">
                            <i class="fa fa-plus-circle" id="iconMoreDetails"></i> More Details (Optional)
                        </button>

                        <button class="btn btn-link text-success fw-bold p-0" type="button"
                                id="btnRecipeToggle"
                                onclick="toggleRecipeSection()">
                            <i class="fa fa-utensils" id="iconRecipe"></i> Add Recipe
                        </button>
                    </div>

                    <!-- More Details -->
                    <div class="col-12" id="moreDetailsSection" style="display:none;">
                        <div class="card mb-2 soft-card">
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label form-label-sm">Sale Price 2</label>
                                        <input name="SalePrice2" id="SalePrice2" class="form-control form-control-sm"
                                               type="number" step="0.01" placeholder="Second Sale Price" />
                                    </div>

                                    <div class="col-md-4">
                                        <label asp-for="ItemData.PackSize" class="form-label form-label-sm">Pack Size</label>
                                        <input asp-for="ItemData.PackSize" class="form-control form-control-sm" id="packsize" />
                                    </div>

                                    <div class="col-md-4">
                                        <label asp-for="ItemData.UnitPrice" class="form-label form-label-sm">Unit Price</label>
                                        <input asp-for="ItemData.UnitPrice" class="form-control form-control-sm" id="unitprice" readonly />
                                    </div>

                                    <div class="col-md-4">
                                        <label asp-for="ItemData.PackPrice" class="form-label form-label-sm">Pack Price</label>
                                        <input asp-for="ItemData.PackPrice" class="form-control form-control-sm"
                                               type="number" id="packprice" readonly />
                                    </div>

                                    <div class="col-12 col-sm-6 col-md-4">
                                        <label class="form-label form-label-sm">Unit <span class="text-danger">*</span></label>
                                        <div class="input-group input-group-sm">
                                            <select name="ItemData.UnitId" id="UnitId" class="form-select form-select-sm">
                                                <option value="">Select Unit</option>
                                                @foreach (var unit in ViewBag.UnitList)
                                                {
                                                    <option value="@unit.Value">@unit.Text</option>
                                                }
                                            </select>
                                            <a asp-controller="Unit" asp-action="Create" class="btn btn-success btn-sm" title="Add Unit">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </div>
                                        <span class="text-danger small" id="UnitIdError"></span>
                                    </div>

                                    <div class="col-md-4">
                                        <label asp-for="ItemData.LocationId" class="form-label form-label-sm">
                                            Location <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group input-group-sm">
                                            <select asp-for="ItemData.LocationId" id="LocationId"
                                                    asp-items="Model.LocationList"
                                                    class="form-select form-select-sm">
                                                <option value="">Select Location</option>
                                            </select>
                                            <a asp-controller="Location" asp-action="Create" class="btn btn-success btn-sm" title="Add Location">
                                                <i class="fa fa-plus"></i>
                                            </a>
                                        </div>
                                        <span asp-validation-for="ItemData.LocationId" class="text-danger small"></span>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RECIPE -->
                    <div class="col-12" id="recipeSectionWrapper" style="display:none;">
                        <div class="card mb-2 soft-card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">
                                        <i class="fa fa-utensils text-success me-1"></i>
                                        Recipe (Raw Material / Ingredients)
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="addRecipeRow()">
                                        <i class="fa fa-plus"></i> Add Ingredient Row
                                    </button>
                                </div>

                                <div class="alert alert-info py-2 mb-2" style="font-size:0.8rem;">
                                    <i class="fa fa-lightbulb me-1"></i>
                                    Yahan ingredients + qty add karein.
                                </div>

                                <div class="table-responsive border rounded-3" style="background:#ffffff; max-height:260px; overflow:auto;">
                                    <table class="table table-sm mb-0 align-middle" id="recipeTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width:26px;"></th>
                                                <th>Ingredient</th>
                                                <th>Category</th>
                                                <th style="width:90px;">Unit</th>
                                                <th style="width:90px;" class="text-end">Avail</th>
                                                <th style="width:90px;" class="text-end">Use</th>
                                                <th style="width:110px;" class="text-end">Cost/Unit</th>
                                                <th style="width:110px;" class="text-end">Line Total</th>
                                                <th style="width:40px;" class="text-center">Del</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>

                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="fw-bold">
                                        Total Recipe Cost:
                                        <span id="recipeGrandTotal" class="text-primary">0.00</span>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <label class="form-label form-label-sm">Recipe / Item Picture (optional)</label>
                                    <input type="file" name="RecipeImage" class="form-control form-control-sm" accept="image/*" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="col-12 d-flex justify-content-end mt-3 gap-2">
                        <button type="reset" id="btnClearAll" class="btn btn-secondary btn-sm">Clear</button>
                        <button type="submit" id="btnSaveNext" class="btn btn-primary btn-sm">
                            Save &amp; Next
                        </button>
                        <a href="@Url.Action("Index", "Home")" class="btn btn-danger btn-sm ms-2">Exit to Dashboard</a>
                    </div>

                </form>
            </div>
        </div>

        <!-- RIGHT -->
        <div class="col-12 col-lg-4 additem-right">
            <div class="mb-card">
                <div class="mb-card-header">
                    <div class="d-flex align-items-center gap-2">
                        <span class="mb-icon"><i class="fa fa-barcode"></i></span>
                        <div>
                            <div class="mb-title">Multi Barcodes</div>
                            <div class="mb-subtitle">Scan / type extra barcodes for this item</div>
                        </div>
                    </div>

                    <div id="mbToastBox" class="mb-toast d-none"></div>
                </div>

                <div class="mb-card-body">
                    <div class="mb-input-row">
                        <input type="text" id="mbInput" class="form-control form-control-sm"
                               placeholder="Scan/Type barcode and press Enter" autocomplete="off" />
                        <button type="button" class="btn btn-outline-primary btn-sm" id="mbAddBtn">
                            <i class="fa fa-plus"></i> Add
                        </button>
                    </div>

                    <div class="mb-table-wrap mt-2">
                        <table class="table table-sm mb-0 align-middle" id="mbTable">
                            <thead>
                                <tr>
                                    <th style="width:40px;"></th>
                                    <th>Barcode</th>
                                    <th style="width:120px;" class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mbTbody"></tbody>
                        </table>

                        <div id="mbEmpty" class="mb-empty">
                            <i class="fa fa-circle-info me-1"></i>
                            No multi barcodes added yet.
                        </div>
                    </div>

                    <div id="mbHidden"></div>

                    <button type="button" id="mbSaveBtn" class="btn btn-success btn-sm w-100 mt-2 d-none">
                        <i class="fa fa-save me-1"></i> Save Multi Barcodes
                    </button>

                    <small class="text-muted d-block mt-2">
                        Tip: Item save ke baad modal me “Yes” karo, phir barcodes add karke ye button dabao.
                    </small>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ✅ STOCK SECTION WRAPPER -->
<div class="stock-section">
    <div class="row g-3 stock-fullwidth">
        <div class="col-12">
            <div class="card mb-4 stock-card">

                <div class="search-bar-row stock-toolbar">
                    <div class="stock-search">
                        <i class="fa fa-magnifying-glass"></i>
                        <input type="text"
                               id="searchItemInput"
                               class="form-control form-control-sm"
                               placeholder="Search by code / name / supplier..." />
                    </div>

                    <div class="stock-select">
                        <i class="fa fa-truck"></i>
                        <select id="filterSupplier" class="form-select form-select-sm">
                            <option value="">All Suppliers</option>
                            @foreach (var s in supplierNames)
                            {
                                <option value="@s">@s</option>
                            }
                        </select>
                    </div>

                    <div class="stock-select">
                        <i class="fa fa-tags"></i>
                        <select id="filterCategory" class="form-select form-select-sm">
                            <option value="">All Categories</option>
                            @foreach (var c in categoryNames)
                            {
                                <option value="@c">@c</option>
                            }
                        </select>
                    </div>

                    <button class="btn btn-primary btn-sm stock-btn" type="button" onclick="searchTable(300,false)">
                        <i class="fa fa-search me-1"></i> Search
                    </button>

                    <button class="btn btn-light btn-sm stock-btn-clear" type="button" onclick="clearStockSearch()">
                        <i class="fa fa-rotate-left me-1"></i> Clear
                    </button>

                    <button class="btn btn-secondary btn-sm ms-auto stock-btn" type="button"
                            onclick="window.location.href='@Url.Action("Index", "Item")'">
                        <i class="fa fa-list me-1"></i> Stock List
                    </button>
                </div>

                <div class="card-header stock-header">
                    <div class="stock-header-title">
                        <i class="fa fa-boxes-stacked me-2"></i> Current Stock
                    </div>
                    <div class="stock-header-sub">
                        Quick search • Supplier/Category filters • Recent items
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height:650px; overflow-y:auto;">
                        <table id="stockTable" class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="form-label-sm"><i class="fa fa-barcode me-1"></i>Code</th>
                                    <th class="form-label-sm"><i class="fa fa-box me-1"></i>Name</th>
                                    <th class="form-label-sm"><i class="fa fa-tags me-1"></i>Category</th>
                                    <th class="form-label-sm"><i class="fa fa-truck me-1"></i>Supplier</th>
                                    <th class="form-label-sm"><i class="fa fa-cubes me-1"></i>Qty</th>
                                    <th class="form-label-sm"><i class="fa fa-arrow-down me-1"></i>Purchase PKR</th>
                                    <th class="form-label-sm"><i class="fa fa-arrow-up me-1"></i>Sale PKR</th>
                                    <th class="form-label-sm"><i class="fa fa-gear me-1"></i>Actions</th>
                                </tr>
                            </thead>

                            <tbody id="stockBody">
                                @{
                                    var last20 = (existingItems ?? new List<ItemModel>())
                                    .OrderByDescending(x => x.Id)
                                    .Take(20)
                                    .ToList();
                                }

                                @if (!last20.Any())
                                {
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-2">No items found</td>
                                    </tr>
                                }
                                else
                                {
                                    foreach (var it in last20)
                                    {
                                        var supplierName = it.Supplier?.SupplierName ?? "";
                                        var categoryName = it.Category?.Name ?? "";
                                        <tr data-supplier="@supplierName" data-category="@categoryName">
                                            <td class="form-label-sm">@it.ItemCode</td>
                                            <td class="form-label-sm">@it.ItemName</td>
                                            <td class="form-label-sm">@categoryName</td>
                                            <td class="form-label-sm">@supplierName</td>
                                            <td class="form-label-sm">@it.Quantity</td>
                                            <td class="form-label-sm">@it.PurchasePrice.ToString("0.00")</td>
                                            <td class="form-label-sm">@it.SalePrice.ToString("0.00")</td>
                                            <td class="form-label-sm text-nowrap">
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-primary me-1"
                                                        data-edit-id="@it.Id"
                                                        title="Edit">
                                                    <i class="fa fa-edit"></i>
                                                </button>

                                                <button type="button"
                                                        class="btn btn-sm btn-outline-danger"
                                                        data-del-id="@it.Id"
                                                        title="Delete">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>

                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ✅ Center TempData toast (top)
        document.addEventListener('DOMContentLoaded', function () {
            ['centerSmsSuccess', 'centerSmsDanger'].forEach(function (id) {
                const el = document.getElementById(id);
                if (!el) return;
                setTimeout(() => el.classList.add('show'), 50);
                setTimeout(() => el.classList.remove('show'), 1100);
                setTimeout(() => { try { el.remove(); } catch { } }, 1500);
            });
        });

        // ✅ Time/Date stable
        (function () {
            const timeEl = document.getElementById("currentTime");
            const dateEl = document.getElementById("currentDate");
            function pad2(n) { return String(n).padStart(2, '0'); }
            function update() {
                const now = new Date();
                if (timeEl) timeEl.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
                if (dateEl) dateEl.textContent = now.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
            }
            document.addEventListener("DOMContentLoaded", update);
            setInterval(update, 1000);
        })();

        // ✅ Helpers + elements
        const addForm = document.getElementById('addItemForm');
        const btnSaveNext = document.getElementById('btnSaveNext');
        const btnClearAll = document.getElementById('btnClearAll');

        // 🔥 global
        window.codeInput = document.getElementById('Item_ItemCode');

        const refInput = document.getElementById('Item_ReferenceCode');
        const flavInput = document.getElementById('Item_Flavour');

        // ✅ Anti-forgery token helper
        function getToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";
        }

        // ✅ Center toast helper
        function showCenterToast(type, msg) {
            let el = document.getElementById("centerToast");
            if (!el) {
                el = document.createElement("div");
                el.id = "centerToast";
                el.className = "sms-message";
                document.body.appendChild(el);
            }

            el.classList.remove("success", "danger", "show");
            el.classList.add(type === "danger" ? "danger" : "success");
            el.textContent = msg;

            setTimeout(() => el.classList.add("show"), 10);
            setTimeout(() => el.classList.remove("show"), 1200);
            setTimeout(() => { try { el.remove(); } catch { } }, 1500);
        }
        window.showCenterToast = showCenterToast;

        // ✅ Select helper
        function setSelectValue(selectId, value) {
            const sel = document.getElementById(selectId);
            if (!sel) return;

            const v = (value ?? "").toString();
            const ok = Array.from(sel.options).some(o => o.value === v);
            if (ok) sel.value = v;

            sel.dispatchEvent(new Event("change", { bubbles: true }));
        }

        // ✅ Fill item form
        function fillItemForm(item) {
            if (!item) return;

            const hid = document.getElementById("ExistingItemId");
            const id = document.getElementById("itemId");
            if (hid) hid.value = item.id || item.Id || "";
            if (id) id.value = item.id || item.Id || "";

            document.getElementById("Item_ItemCode") && (document.getElementById("Item_ItemCode").value = item.itemCode ?? item.ItemCode ?? "");
            document.getElementById("Item_ReferenceCode") && (document.getElementById("Item_ReferenceCode").value = item.referenceCode ?? item.ReferenceCode ?? "");
            document.getElementById("Item_ItemName") && (document.getElementById("Item_ItemName").value = item.itemName ?? item.ItemName ?? "");
            document.getElementById("Item_Flavour") && (document.getElementById("Item_Flavour").value = item.flavour ?? item.Flavour ?? "");

            setSelectValue("CategoryId", item.categoryId ?? item.CategoryId);
            setSelectValue("SupplierId", item.supplierId ?? item.SupplierId);
            setSelectValue("UnitId", item.unitId ?? item.UnitId);
            setSelectValue("LocationId", item.locationId ?? item.LocationId);

            document.getElementById("mrpPrice") && (document.getElementById("mrpPrice").value = (item.salePrice ?? item.SalePrice ?? 0).toString());
            document.getElementById("purchasePrice") && (document.getElementById("purchasePrice").value = (item.purchasePrice ?? item.PurchasePrice ?? 0).toString());
            document.getElementById("markupPct") && (document.getElementById("markupPct").value = (item.markupPercentage ?? item.MarkupPercentage ?? 0).toString());
            document.getElementById("Item_Quantity") && (document.getElementById("Item_Quantity").value = (item.quantity ?? item.Quantity ?? 0).toString());

            document.getElementById("packsize") && (document.getElementById("packsize").value = item.packSize ?? item.PackSize ?? "");
            document.getElementById("unitprice") && (document.getElementById("unitprice").value = item.unitPrice ?? item.UnitPrice ?? "");
            document.getElementById("packprice") && (document.getElementById("packprice").value = item.packPrice ?? item.PackPrice ?? "");

            const moreDetails = document.getElementById("moreDetailsSection");
            if (moreDetails && (moreDetails.style.display === "none" || moreDetails.style.display === "")) {
                if ((item.packSize ?? item.PackSize) || (item.unitId ?? item.UnitId) || (item.locationId ?? item.LocationId)) {
                    moreDetails.style.display = "block";
                    const icon = document.getElementById("iconMoreDetails");
                    if (icon) { icon.classList.remove("fa-plus-circle"); icon.classList.add("fa-minus-circle"); }
                }
            }

            // ✅ track edit mode item (IMPORTANT)
            window.__editItemId = parseInt(item.id || item.Id || "0") || 0;
            window.__editItemCode = (item.itemCode ?? item.ItemCode ?? "").trim();

            // ✅ track original name too (so edit me "Item Name already exists" na aaye)
            window.__editItemName = (item.itemName ?? item.ItemName ?? "").trim();
        }
        window.fillItemForm = fillItemForm;
    </script>

    <!-- ✅ REMEMBER LAST DROPDOWNS -->
    <script>
        (function () {
            const KEYS = {
                cat: "gsoft_last_category",
                sup: "gsoft_last_supplier",
                unit: "gsoft_last_unit",
                loc: "gsoft_last_location"
            };

            function el(id) { return document.getElementById(id); }

            function rememberNow() {
                const c = el("CategoryId")?.value || "";
                const s = el("SupplierId")?.value || "";
                const u = el("UnitId")?.value || "";
                const l = el("LocationId")?.value || "";
                if (c) localStorage.setItem(KEYS.cat, c);
                if (s) localStorage.setItem(KEYS.sup, s);
                if (u) localStorage.setItem(KEYS.unit, u);
                if (l) localStorage.setItem(KEYS.loc, l);
            }

            function restoreLast() {
                function setIfExists(id, val) {
                    const d = el(id);
                    if (!d || !val) return;
                    const ok = Array.from(d.options || []).some(o => o.value === val);
                    if (ok) d.value = val;
                }

                setIfExists("CategoryId", localStorage.getItem(KEYS.cat) || "");
                setIfExists("SupplierId", localStorage.getItem(KEYS.sup) || "");
                setIfExists("UnitId", localStorage.getItem(KEYS.unit) || "");
                setIfExists("LocationId", localStorage.getItem(KEYS.loc) || "");
            }

            window.__rememberLastDropdowns = rememberNow;
            window.__restoreLastDropdowns = restoreLast;

            ["CategoryId", "SupplierId", "UnitId", "LocationId"].forEach(id => {
                el(id)?.addEventListener("change", rememberNow);
            });

            document.addEventListener("DOMContentLoaded", () => restoreLast());

            document.getElementById("btnClearAll")?.addEventListener("click", () => {
                setTimeout(() => {
                    restoreLast();
                    document.getElementById("Item_ItemCode")?.focus();
                    document.getElementById("Item_ItemCode")?.select?.();
                }, 50);
            });
        })();
    </script>

    <!-- ✅ BARCODE CHECK (FIXED: prevents double checkNow call on one scan) -->
    <script>
        (function () {
            const codeInput = window.codeInput || document.getElementById('Item_ItemCode');
            const msg = document.getElementById('itemCodeMessage');
            const dupBox = document.getElementById('duplicateNotice');
            const saveBtn = document.getElementById('btnSaveNext');
            const hiddenExistingId = document.getElementById('ExistingItemId');
            if (!codeInput) return;

            const blockIds = [
                'Item_ReferenceCode','Item_ItemName','Item_Flavour',
                'CategoryId','SupplierId','mrpPrice','markupPct','purchasePrice',
                'Item_Quantity','ImageFile'
            ];

            let lastKeyAt = 0;
            let fastHits = 0;
            let scanEndTimer = null;

            // ✅ NEW: lock + last processed guard (double scan bug fix)
            let isChecking = false;
            let lastProcessedCode = "";
            let lastProcessedAt = 0;

            window.__isItemCodeDuplicate = false;

            function setSaveBtnText(isUpdate) {
                const sb = document.getElementById("btnSaveNext");
                if (!sb) return;
                sb.innerHTML = isUpdate ? 'Update &amp; Next' : 'Save &amp; Next';
            }

            function clearUI() {
                if (msg) msg.textContent = "";
                if (dupBox) { dupBox.classList.add("d-none"); dupBox.innerHTML = ""; }
                if (saveBtn) saveBtn.disabled = false;
            }

            async function checkNow() {

                // ✅ guard 1: already running => ignore
                if (isChecking) return;

                const nowTs = Date.now();
                const currentCode = (codeInput.value || "").trim();

                // ✅ guard 2: same code within 200ms => ignore
                if (currentCode && currentCode === lastProcessedCode && (nowTs - lastProcessedAt) < 200) {
                    return;
                }

                isChecking = true;

                try {
                    const code = currentCode;
                    const currentId = parseInt(document.getElementById("itemId")?.value || "0") || 0;

                    // ✅ empty
                    if (!code) {
                        window.__isItemCodeDuplicate = false;
                        clearUI();
                        setSaveBtnText(false);
                        if (hiddenExistingId) hiddenExistingId.value = "";
                        return;
                    }

                    // ======================================================
                    // ✅ EDIT MODE: do NOT reload item by code (prevents overwrite)
                    // ======================================================
                    if (currentId > 0) {
                        const original = (window.__editItemCode || "").trim();

                        // code same => ok
                        if (original && code === original) {
                            window.__isItemCodeDuplicate = false;
                            if (msg) msg.textContent = "";
                            if (saveBtn) saveBtn.disabled = false;
                            setSaveBtnText(true); // Update mode
                            return;
                        }

                        // ✅ only check duplicate (ignore same id)
                        try {
                            const url = '@Url.Action("CheckItemCode", "Item")'
                                + '?itemCode=' + encodeURIComponent(code)
                                + '&id=' + encodeURIComponent(currentId);

                            const res = await fetch(url, { cache: "no-store" });
                            const exists = await res.json(); // true/false

                            if (exists) {
                                window.__isItemCodeDuplicate = true;
                                if (msg) msg.textContent = `Item Code '${code}' already exists!`;
                                if (saveBtn) saveBtn.disabled = true;
                                window.showCenterToast?.("danger", "Duplicate barcode! Please change it.");
                                return;
                            }

                            window.__isItemCodeDuplicate = false;
                            if (msg) msg.textContent = "";
                            if (saveBtn) saveBtn.disabled = false;
                            setSaveBtnText(true);
                            return;

                        } catch (e) {
                            console.error(e);
                            window.__isItemCodeDuplicate = false;
                            if (saveBtn) saveBtn.disabled = false;
                            return;
                        }
                    }

                    // ======================================================
                    // ✅ ADD MODE: allow auto-load by code (existing behavior)
                    // ======================================================
                    try {
                        const url = '@Url.Action("GetItemByCode", "Item")' + '?code=' + encodeURIComponent(code);
                        const res = await fetch(url, { cache: "no-store" });
                        const data = await res.json().catch(() => null);

                        if (data && data.exists && data.item) {
                            const nm = data.item.itemName ? ` (${data.item.itemName})` : "";
                            if (msg) msg.textContent = `Already exists, loaded:${nm}`;

                            window.showCenterToast?.("success", "Item loaded from database");
                            window.fillItemForm?.(data.item);

                            window.__isItemCodeDuplicate = false;
                            if (saveBtn) saveBtn.disabled = false;
                            setSaveBtnText(true);

                            setTimeout(() => {
                                document.getElementById('Item_ReferenceCode')?.focus();
                                document.getElementById('Item_ReferenceCode')?.select?.();
                            }, 50);

                            return;
                        }

                        window.__isItemCodeDuplicate = false;
                        clearUI();
                        if (hiddenExistingId) hiddenExistingId.value = "";
                        setSaveBtnText(false);

                    } catch (e) {
                        console.error(e);
                        window.__isItemCodeDuplicate = false;
                        clearUI();
                        setSaveBtnText(false);
                    }

                } finally {
                    const finalCode = (codeInput.value || "").trim();
                    if (finalCode) {
                        lastProcessedCode = finalCode;
                        lastProcessedAt = Date.now();
                    }
                    isChecking = false;
                }
            }

            function hardBlock(e) {
                if (!window.__isItemCodeDuplicate) return;
                if (e.target && e.target.id !== 'Item_ItemCode') {
                    e.preventDefault(); e.stopPropagation();
                    codeInput.focus(); codeInput.select?.();
                    return false;
                }
            }

            blockIds.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener("focus", hardBlock, true);
                el.addEventListener("mousedown", hardBlock, true);
                el.addEventListener("keydown", function (e) {
                    if (!window.__isItemCodeDuplicate) return;
                    if (e.key === "Enter" || e.key === "Tab") {
                        e.preventDefault(); e.stopPropagation();
                        codeInput.focus(); codeInput.select?.();
                    }
                }, true);
            });

            codeInput.addEventListener("input", function () {
                if (msg) msg.textContent = "";
                if (dupBox) { dupBox.classList.add("d-none"); dupBox.innerHTML = ""; }

                window.__isItemCodeDuplicate = false;
                if (saveBtn) saveBtn.disabled = false;

                const now = Date.now();
                const gap = now - lastKeyAt;
                lastKeyAt = now;

                if (gap > 0 && gap < 50) fastHits++;
                else fastHits = Math.max(0, fastHits - 1);

                clearTimeout(scanEndTimer);

                if (fastHits >= 4) {
                    scanEndTimer = setTimeout(checkNow, 120);
                }
            });

            codeInput.addEventListener("keydown", function (e) {
                if (e.key !== "Enter") return;
                e.preventDefault();

                checkNow().then(() => {
                    if (window.__isItemCodeDuplicate) return;
                    document.getElementById('Item_ReferenceCode')?.focus();
                    document.getElementById('Item_ReferenceCode')?.select?.();
                });
            });

            codeInput.addEventListener("blur", function () {
                if ((codeInput.value || "").trim()) checkNow();
            });

            document.getElementById("addItemForm")?.addEventListener("submit", function (e) {
                if (window.__isItemCodeDuplicate) {
                    e.preventDefault();
                    window.showCenterToast?.("danger", "Duplicate barcode! Please change it.");
                    codeInput.focus();
                    codeInput.select?.();
                }
            });

            window.__checkBarcodeNow = checkNow;
        })();
    </script>

    <script>
        (function () {
            const btn = document.getElementById('btnAutoCode');
            const codeInput = document.getElementById('Item_ItemCode');
            const refInput = document.getElementById('Item_ReferenceCode');
            const msg = document.getElementById('itemCodeMessage');

            if (!codeInput) return;

            function clearBarcodeUI() {
                if (msg) msg.textContent = "";
                window.__isItemCodeDuplicate = false;
                const sb = document.getElementById("btnSaveNext");
                if (sb) sb.disabled = false;
            }

            async function generateCode(focusNext = true) {
                try {
                    const url = '@Url.Action("GetNextCode", "Item")';
                    const res = await fetch(url, { cache: "no-store" });
                    if (!res.ok) throw new Error("GetNextCode failed: " + res.status);

                    let code = "";
                    const ct = (res.headers.get("content-type") || "").toLowerCase();
                    if (ct.includes("application/json")) code = await res.json();
                    else code = (await res.text()).trim();

                    if (!code) throw new Error("Empty code returned");

                    codeInput.value = String(code).trim();
                    clearBarcodeUI();

                    if (focusNext) {
                        setTimeout(() => {
                            refInput?.focus();
                            refInput?.select?.();
                        }, 30);
                    }
                }
                catch (e) {
                    console.error(e);
                    window.showCenterToast?.("danger", "Auto code generate nahi hua (GetNextCode check karo)");
                }
            }

            window.gsoftGenerateCode = generateCode;

            btn?.addEventListener('click', () => generateCode(true));

            document.addEventListener('keydown', function (e) {
                if (!e.ctrlKey) return;
                if (!(e.key === 'a' || e.key === 'A')) return;
                if (document.activeElement !== codeInput) return;

                e.preventDefault();
                generateCode(true);
            });

        })();
    </script>

    <!-- ✅ Pricing dual mode -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const mrpEl = document.getElementById('mrpPrice');
            const pctEl = document.getElementById('markupPct');
            const costEl = document.getElementById('purchasePrice');

            const mtSale = document.getElementById('mtSale');
            const mtCost = document.getElementById('mtCost');

            const saleWrap = document.getElementById('saleWrap');
            const markupWrap = document.getElementById('markupWrap');
            const costWrap = document.getElementById('costWrap');
            const parentRow = document.getElementById('priceRow');

            if (!mrpEl || !pctEl || !costEl || !mtSale || !mtCost || !saleWrap || !markupWrap || !costWrap || !parentRow) return;

            function num(v) { const x = parseFloat(v); return isNaN(x) ? 0 : x; }
            function mode() { return mtCost.checked ? "cost" : "sale"; }

            function saveMode() { localStorage.setItem("gsoft_markup_mode", mode()); }
            function restoreMode() {
                const m = localStorage.getItem("gsoft_markup_mode") || "sale";
                if (m === "cost") mtCost.checked = true; else mtSale.checked = true;
            }

            function applyLayout() {
                const isCost = (mode() === "cost");
                if (isCost) {
                    parentRow.appendChild(costWrap);
                    parentRow.appendChild(markupWrap);
                    parentRow.appendChild(saleWrap);
                } else {
                    parentRow.appendChild(saleWrap);
                    parentRow.appendChild(markupWrap);
                    parentRow.appendChild(costWrap);
                }
            }

            function applyMarkup() {
                const p = num(pctEl.value);
                if (mode() === "sale") {
                    const mrp = num(mrpEl.value);
                    if (mrp > 0) costEl.value = (mrp * (100 - p) / 100).toFixed(2);
                } else {
                    const cost = num(costEl.value);
                    if (cost > 0) mrpEl.value = (cost * (1 + p / 100)).toFixed(2);
                }
            }

            function onSaleInput() {
                const mrp = num(mrpEl.value), cost = num(costEl.value);
                if (mode() === "cost") { if (mrp > 0 && cost > 0) pctEl.value = (((mrp - cost) / cost) * 100).toFixed(2); }
                else applyMarkup();
            }

            function onCostInput() {
                const mrp = num(mrpEl.value), cost = num(costEl.value);
                if (mode() === "sale") { if (mrp > 0 && cost > 0) pctEl.value = (((mrp - cost) / mrp) * 100).toFixed(2); }
                else applyMarkup();
            }

            pctEl.addEventListener('input', applyMarkup);
            mrpEl.addEventListener('input', onSaleInput);
            costEl.addEventListener('input', onCostInput);

            mtSale.addEventListener('change', () => { saveMode(); applyLayout(); applyMarkup(); });
            mtCost.addEventListener('change', () => { saveMode(); applyLayout(); applyMarkup(); });

            restoreMode();
            applyLayout();
            applyMarkup();
        });
    </script>

    <!-- ✅ Pack size calc -->
    <script>
        (function () {
            const mrpEl = document.getElementById('mrpPrice');
            const packSizeInput = document.getElementById("packsize");
            const unitPriceInput = document.getElementById("unitprice");
            const packPriceInput = document.getElementById("packprice");

            function calc() {
                const packSize = parseFloat(packSizeInput?.value) || 0;
                const mrp = parseFloat(mrpEl?.value) || 0;

                if (packSize > 0) {
                    const unitPrice = mrp / packSize;
                    const packPrice = packSize * unitPrice;
                    if (unitPriceInput) unitPriceInput.value = unitPrice.toFixed(2);
                    if (packPriceInput) packPriceInput.value = packPrice.toFixed(2);
                } else {
                    if (unitPriceInput) unitPriceInput.value = "";
                    if (packPriceInput) packPriceInput.value = "";
                }
            }
            packSizeInput?.addEventListener("keyup", calc);
            mrpEl?.addEventListener("keyup", calc);
        })();
    </script>

    <!-- ✅ Flavour clear -->
    <script>
        document.getElementById('btnClearFlavour')?.addEventListener('click', () => {
            const flavInput = document.getElementById("Item_Flavour");
            if (flavInput) { flavInput.value = ''; flavInput.focus(); }
        });
    </script>

    <!-- ✅ Remove barcode blink after first input -->
    <script>
        (function () {
            const codeInput = window.codeInput || document.getElementById('Item_ItemCode');
            if (!codeInput) return;
            function removeBlink() {
                codeInput.classList.remove("barcode-blink");
                codeInput.removeEventListener('input', removeBlink);
            }
            codeInput.addEventListener('input', removeBlink);
        })();
    </script>

    <!-- ✅ STOCK: SEARCH + FILTER + INLINE EDIT + AJAX DELETE -->
    <script>
        function renderStockRows(items) {
            const tbody = document.querySelector('#stockTable tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (!items || !items.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-2">No items found</td></tr>`;
                return;
            }

            items.forEach(it => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="form-label-sm">${it.itemCode ?? ''}</td>
                    <td class="form-label-sm">${it.itemName ?? ''}</td>
                    <td class="form-label-sm">${it.categoryName ?? ''}</td>
                    <td class="form-label-sm">${it.supplierName ?? ''}</td>
                    <td class="form-label-sm">${it.quantity ?? 0}</td>
                    <td class="form-label-sm">${Number(it.purchasePrice ?? 0).toFixed(2)}</td>
                    <td class="form-label-sm">${Number(it.salePrice ?? 0).toFixed(2)}</td>
                    <td class="form-label-sm text-nowrap">
                        <button type="button" class="btn btn-sm btn-outline-primary me-1" data-edit-id="${it.id}">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" data-del-id="${it.id}">
                            <i class="fa fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function searchTable(take = 300, recent = false) {
            const text = (document.getElementById("searchItemInput")?.value || "").trim();
            const sup = (document.getElementById("filterSupplier")?.value || "").trim();
            const cat = (document.getElementById("filterCategory")?.value || "").trim();

            const url = '@Url.Action("SearchStockAjax", "Item")'
                + `?search=${encodeURIComponent(text)}`
                + `&supplier=${encodeURIComponent(sup)}`
                + `&category=${encodeURIComponent(cat)}`
                + `&take=${encodeURIComponent(take)}`
                + `&recent=${encodeURIComponent(recent)}`;

            try {
                const res = await fetch(url, { cache: "no-store" });
                if (!res.ok) throw new Error("Network error");
                const data = await res.json();
                renderStockRows(data);
            } catch (e) {
                console.error(e);
                window.showCenterToast?.("danger", "Stock load error");
            }
        }
        window.searchTable = searchTable;

        function loadRecentStock() { searchTable(20, true); }
        window.loadRecentStock = loadRecentStock;

        function clearStockSearch() {
            const s = document.getElementById("searchItemInput");
            const sup = document.getElementById("filterSupplier");
            const cat = document.getElementById("filterCategory");
            if (s) s.value = "";
            if (sup) sup.value = "";
            if (cat) cat.value = "";
            loadRecentStock();
        }
        window.clearStockSearch = clearStockSearch;

        async function editItemInline(id) {
            id = parseInt(id || "0") || 0;
            if (!id) return;

            try {
                window.showCenterToast?.("success", "Loading item...");

                const url = '@Url.Action("GetItemForEditAjax", "Item")' + `?id=${encodeURIComponent(id)}`;
                const res = await fetch(url, { cache: "no-store" });

                const ct = (res.headers.get("content-type") || "").toLowerCase();
                if (!res.ok) {
                    const txt = await res.text().catch(() => "");
                    window.showCenterToast?.("danger", "Server error: " + (txt ? txt.substring(0, 80) : res.status));
                    return;
                }

                if (!ct.includes("application/json")) {
                    const txt = await res.text().catch(() => "");
                    console.log("Edit response text:", txt);
                    window.showCenterToast?.("danger", "Not JSON response (check controller).");
                    return;
                }

                const data = await res.json().catch(() => null);
                if (!data || !data.ok || !data.item) {
                    window.showCenterToast?.("danger", data?.error || "Item load failed");
                    return;
                }

                window.fillItemForm?.(data.item);

                const sb = document.getElementById("btnSaveNext");
                if (sb) sb.innerHTML = 'Update &amp; Next';

                window.scrollTo({ top: 0, behavior: "smooth" });

                setTimeout(() => {
                    document.getElementById("Item_ItemName")?.focus();
                    document.getElementById("Item_ItemName")?.select?.();
                }, 120);

                window.showCenterToast?.("success", "Item loaded");
            } catch (e) {
                console.error(e);
                window.showCenterToast?.("danger", "Network/Server error");
            }
        }
        window.editItemInline = editItemInline;

        async function deleteItemInline(id, btnEl) {
            id = parseInt(id || "0") || 0;
            if (!id) return;

            if (!confirm("Confirm delete?")) return;

            try {
                const fd = new FormData();
                fd.append("id", String(id));

                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";

                const res = await fetch('@Url.Action("DeleteAjax", "Item")', {
                    method: "POST",
                    body: fd,
                    headers: token ? { "RequestVerificationToken": token } : {}
                });

                const data = await res.json().catch(() => null);

                if (!res.ok || !data || !data.ok) {
                    window.showCenterToast?.("danger", data?.error || "Delete failed");
                    return;
                }

                btnEl?.closest("tr")?.remove();
                window.showCenterToast?.("danger", "Item deleted");

                const tbody = document.querySelector('#stockTable tbody');
                if (tbody && tbody.children.length === 0) loadRecentStock();
            } catch (e) {
                console.error(e);
                window.showCenterToast?.("danger", "Network/Server error");
            }
        }

        (function bindStockActions() {
            const tbody = document.querySelector("#stockTable tbody");
            if (!tbody) return;

            tbody.addEventListener("click", function (e) {
                const editBtn = e.target.closest("[data-edit-id]");
                if (editBtn) {
                    const id = parseInt(editBtn.getAttribute("data-edit-id") || "0");
                    if (id > 0) editItemInline(id);
                    return;
                }

                const delBtn = e.target.closest("[data-del-id]");
                if (delBtn) {
                    const id = parseInt(delBtn.getAttribute("data-del-id") || "0");
                    if (id > 0) deleteItemInline(id, delBtn);
                    return;
                }
            });
        })();

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("searchItemInput")?.addEventListener("keyup", function (e) {
                if (e.key === "Enter") searchTable(300, false);
            });

            document.getElementById("filterSupplier")?.addEventListener("change", () => searchTable(300, false));
            document.getElementById("filterCategory")?.addEventListener("change", () => searchTable(300, false));

            loadRecentStock();
        });
    </script>

    <!-- ✅ Toggles -->
    <script>
        function toggleMoreDetails() {
            const section = document.getElementById('moreDetailsSection');
            const icon = document.getElementById('iconMoreDetails');
            if (!section || !icon) return;

            const show = (section.style.display === "none" || section.style.display === "");
            section.style.display = show ? "block" : "none";

            icon.classList.toggle("fa-plus-circle", !show);
            icon.classList.toggle("fa-minus-circle", show);
        }
        window.toggleMoreDetails = toggleMoreDetails;

        function toggleRecipeSection() {
            const wrapper = document.getElementById('recipeSectionWrapper');
            const icon = document.getElementById('iconRecipe');
            if (!wrapper) return;

            const show = (wrapper.style.display === 'none' || wrapper.style.display === '');
            wrapper.style.display = show ? 'block' : 'none';

            if (icon) {
                if (show) { icon.classList.add('fa-minus-circle'); icon.classList.remove('fa-utensils'); }
                else { icon.classList.remove('fa-minus-circle'); icon.classList.add('fa-utensils'); }
            }
        }
        window.toggleRecipeSection = toggleRecipeSection;
    </script>

    <!-- ✅ MULTI BARCODE MODULE -->
    <script>
        (function () {
            const mbInput = document.getElementById('mbInput');
            const mbAddBtn = document.getElementById('mbAddBtn');
            const mbSaveBtn = document.getElementById('mbSaveBtn');
            const mbTbody = document.getElementById('mbTbody');
            const mbEmpty = document.getElementById('mbEmpty');
            const mbHidden = document.getElementById('mbHidden');
            const mbToastBox = document.getElementById('mbToastBox');

            if (!mbInput || !mbAddBtn || !mbSaveBtn || !mbTbody || !mbEmpty || !mbHidden || !mbToastBox) return;

            let list = [];
            let currentItemId = 0;
            let enabled = false;

            function getSafeItemId() {
                const a = parseInt(currentItemId || "0") || 0;
                if (a > 0) return a;

                const b = parseInt(document.getElementById("ExistingItemId")?.value || "0") || 0;
                if (b > 0) return b;

                const c = parseInt(window.__lastSavedItemId || "0") || 0;
                if (c > 0) return c;

                return 0;
            }

            function toastError(msg) {
                mbToastBox.classList.remove("d-none", "success");
                mbToastBox.classList.add("danger");
                mbToastBox.textContent = msg;
                setTimeout(() => mbToastBox.classList.add("d-none"), 900);
            }

            function normalize(v) { return (v || "").trim(); }

            function syncHiddenInputs() {
                mbHidden.innerHTML = "";
                list.forEach(bc => {
                    const h = document.createElement("input");
                    h.type = "hidden";
                    h.name = "MultiBarcodes";
                    h.value = bc;
                    mbHidden.appendChild(h);
                });
            }

            function render() {
                mbTbody.innerHTML = "";

                if (list.length === 0) {
                    mbEmpty.style.display = "block";
                    mbSaveBtn.classList.add("d-none");
                    syncHiddenInputs();
                    return;
                }

                mbEmpty.style.display = "none";
                mbSaveBtn.classList.remove("d-none");

                list.forEach((bc, idx) => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td class="text-center"><span class="badge text-bg-light">${idx + 1}</span></td>
                        <td class="small">${bc}</td>
                        <td class="text-end">
                            <button type="button" class="btn btn-outline-danger btn-sm" data-mb-del="${idx}">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    `;
                    mbTbody.appendChild(tr);
                });

                syncHiddenInputs();
            }

            function resetAll() {
                list = [];
                currentItemId = 0;
                enabled = false;
                mbInput.value = "";
                render();
            }

            function addBarcode(v) {
                if (!enabled) { toastError("Pehle item save karo, phir YES karo."); return; }

                const bc = normalize(v);
                if (!bc) return;

                if (list.includes(bc)) { toastError("Already added"); return; }

                list.push(bc);
                render();

                mbInput.value = "";
                mbInput.focus();
                mbInput.select?.();
            }

            mbTbody.addEventListener("click", (e) => {
                const btn = e.target.closest("[data-mb-del]");
                if (!btn) return;
                const idx = parseInt(btn.getAttribute("data-mb-del") || "-1");
                if (idx < 0) return;
                list.splice(idx, 1);
                render();
                mbInput.focus();
            });

            mbAddBtn.addEventListener("click", () => addBarcode(mbInput.value));

            mbInput.addEventListener("keydown", function (e) {
                if (e.key !== 'Enter') return;
                e.preventDefault();
                addBarcode(mbInput.value);
            });

            window.gsoftMB = {
                enableForItem: function (itemId) {
                    currentItemId = parseInt(itemId || "0") || 0;
                    enabled = currentItemId > 0;

                    const h = document.getElementById("ExistingItemId");
                    if (h && enabled) h.value = String(currentItemId);
                    window.__lastSavedItemId = currentItemId;

                    render();

                    setTimeout(() => {
                        mbInput.focus();
                        mbInput.select?.();
                    }, 50);
                },
                reset: resetAll
            };

            mbSaveBtn.addEventListener("click", async () => {
                const safeId = getSafeItemId();
                currentItemId = safeId;
                enabled = safeId > 0;

                if (!enabled || safeId <= 0) { toastError("Invalid itemId. Item dobara Save karo."); return; }
                if (list.length === 0) { toastError("No barcodes"); return; }

                try {
                    const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || "";
                    const payload = { itemId: safeId, multiBarcodes: list };

                    const res = await fetch('@Url.Action("SaveMultiBarcodesAjax", "Item")', {
                        method: "POST",
                        headers: Object.assign(
                            { "Content-Type": "application/json" },
                            token ? { "RequestVerificationToken": token } : {}
                        ),
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json().catch(() => null);

                    if (!res.ok || !data || !data.ok) {
                        toastError(data?.error || "Save failed");
                        return;
                    }

                    window.showCenterToast?.("success", "Multi barcodes saved");

                    resetAll();
                    addForm?.reset();

                    window.__restoreLastDropdowns?.();

                    document.getElementById("ExistingItemId").value = "";
                    window.__lastSavedItemId = 0;

                    window.gsoftGenerateCode?.(false);
                    window.codeInput?.focus();
                    window.codeInput?.select?.();

                } catch (e) {
                    console.error(e);
                    toastError("Network error");
                }
            });

            render();
        })();
    </script>

    <!-- ✅ SAVE & NEXT + MODAL FLOW (AJAX) -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (!addForm || !btnSaveNext) return;

            const mbModalEl = document.getElementById('mbConfirmModal');
            const mbYesBtn = document.getElementById('mbYesBtn');
            const mbNoBtn = document.getElementById('mbNoBtn');

            function bsModal() {
                if (!mbModalEl) return null;
                try { return bootstrap.Modal.getOrCreateInstance(mbModalEl); } catch { return null; }
            }

            function setBusy(busy) {
                btnSaveNext.disabled = busy;
                btnSaveNext.innerHTML = busy
                    ? `<span class="spinner-border spinner-border-sm me-1"></span> Saving...`
                    : (btnSaveNext.innerHTML.includes("Update") ? 'Update &amp; Next' : 'Save &amp; Next');
            }

            async function postAddAjax() {
                const fd = new FormData(addForm);

                const res = await fetch('@Url.Action("AddAjax", "Item")', {
                    method: "POST",
                    body: fd
                });

                let data = null;
                try { data = await res.json(); } catch { data = null; }

                if (!data) {
                    const txt = await res.text().catch(() => "");
                    return { ok: false, error: (txt || "Save failed").substring(0, 300) };
                }

                if (!res.ok || !data.ok) {
                    return { ok: false, error: data.error || "Save failed" };
                }

                return data;
            }

            addForm.addEventListener("submit", async function (e) {
                e.preventDefault();

                if (window.__isItemCodeDuplicate) {
                    window.showCenterToast?.("danger", "Duplicate barcode! Please change it.");
                    window.codeInput?.focus();
                    window.codeInput?.select?.();
                    return;
                }

                setBusy(true);

                try {
                    const data = await postAddAjax();

                    if (!data.ok) {
                        window.showCenterToast?.("danger", data.error || "Save failed");
                        setBusy(false);
                        return;
                    }

                    const newId =
                        parseInt(
                            data?.id ?? data?.itemId ?? data?.Id ?? data?.ItemId ??
                            data?.data?.id ?? data?.data?.itemId ??
                            data?.item?.id ?? data?.item?.Id ??
                            0
                        ) || 0;

                    document.getElementById("ExistingItemId").value = newId;
                    window.__lastSavedItemId = newId;

                    window.showCenterToast?.("success", data.message || "Saved");
                    window.__rememberLastDropdowns?.();

                    const isUpdate = parseInt(document.getElementById("itemId")?.value || "0") > 0;

                    // ✅ If update => reset & next item (no modal)
                    if (isUpdate) {
                        addForm.reset();
                        window.__restoreLastDropdowns?.();

                        document.getElementById("ExistingItemId").value = "";
                        window.__lastSavedItemId = 0;

                        const sb = document.getElementById("btnSaveNext");
                        if (sb) sb.innerHTML = 'Save &amp; Next';

                        const itemIdEl = document.getElementById("itemId");
                        if (itemIdEl) itemIdEl.value = "";

                        window.gsoftGenerateCode?.(false);
                        window.searchTable?.(20, true);

                        window.codeInput?.focus();
                        window.codeInput?.select?.();
                        setBusy(false);
                        return;
                    }

                    const modal = bsModal();
                    if (modal) { try { modal.show(); } catch { } }

                    if (mbYesBtn) {
                        mbYesBtn.onclick = function () {
                            try { bsModal()?.hide(); } catch { }
                            window.gsoftMB?.enableForItem(newId);
                        };
                    }

                    if (mbNoBtn) {
                        mbNoBtn.onclick = function () {
                            try { bsModal()?.hide(); } catch { }
                            window.gsoftMB?.reset();
                            addForm.reset();

                            window.__restoreLastDropdowns?.();

                            document.getElementById("ExistingItemId").value = "";
                            window.__lastSavedItemId = 0;

                            const sb = document.getElementById("btnSaveNext");
                            if (sb) sb.innerHTML = 'Save &amp; Next';

                            const itemIdEl = document.getElementById("itemId");
                            if (itemIdEl) itemIdEl.value = "";

                            window.gsoftGenerateCode?.(false);

                            window.codeInput?.focus();
                            window.codeInput?.select?.();
                        };
                    }

                    setBusy(false);

                } catch (e) {
                    console.error(e);
                    setBusy(false);
                    window.showCenterToast?.("danger", "Network/Server error");
                }
            });
        });
    </script>

    <!-- ✅ ENTER TO NEXT FIELD FLOW -->
    <script>
        (function () {
            const form = document.getElementById('addItemForm');
            if (!form) return;

            const mtSale = document.getElementById('mtSale');
            const mtCost = document.getElementById('mtCost');

            function getMode() {
                return (mtCost && mtCost.checked) ? "cost" : "sale";
            }

            function getFlowIds() {
                const head = ['Item_ItemCode', 'Item_ReferenceCode', 'Item_ItemName', 'Item_Flavour', 'CategoryId', 'SupplierId'];
                const priceOrder = (getMode() === "cost")
                    ? ['purchasePrice', 'markupPct', 'mrpPrice']
                    : ['mrpPrice', 'markupPct', 'purchasePrice'];
                const tail = ['Item_Quantity', 'ImageFile', 'btnSaveNext'];
                return head.concat(priceOrder).concat(tail);
            }

            function getEl(id) {
                if (id === 'btnSaveNext') return document.getElementById('btnSaveNext');
                return document.getElementById(id);
            }

            function focusNext(currId) {
                const flow = getFlowIds();
                const i = flow.indexOf(currId);
                if (i < 0) return;

                for (let j = i + 1; j < flow.length; j++) {
                    const nx = getEl(flow[j]);
                    if (!nx) continue;
                    if (nx.disabled) continue;
                    if (nx.offsetParent === null && nx.tagName !== 'OPTION') continue;

                    nx.focus();
                    if (nx.tagName === 'INPUT' && nx.type !== 'file' && typeof nx.select === 'function') nx.select();
                    return;
                }
            }

            function handleEnter(e) {
                if (e.key !== 'Enter') return;
                if (e.target && e.target.tagName === 'TEXTAREA') return;
                if (e.ctrlKey || e.altKey) return;

                if (window.__isItemCodeDuplicate) {
                    e.preventDefault();
                    window.codeInput?.focus();
                    window.codeInput?.select?.();
                    window.showCenterToast?.("danger", "Barcode already exists!");
                    return;
                }

                const curr = e.currentTarget;
                if (!curr || !curr.id) return;

                e.preventDefault();

                if (curr.id === 'btnSaveNext') {
                    curr.click();
                    return;
                }
                focusNext(curr.id);
            }

            function bindAll() {
                const flow = getFlowIds();
                flow.forEach(id => {
                    const el = getEl(id);
                    if (!el) return;
                    el.removeEventListener('keydown', handleEnter);
                    el.addEventListener('keydown', handleEnter);
                });
            }

            document.addEventListener('DOMContentLoaded', bindAll);
            mtSale?.addEventListener('change', bindAll);
            mtCost?.addEventListener('change', bindAll);
        })();
    </script>

    <!-- ✅ RECIPE FUNCTIONS (PLACEHOLDER) -->
    <script>
        function addRecipeRow() { /* TODO: paste your recipe code */ }
        function deleteRecipeRow(btn) { /* TODO */ }
        function onIngredientChange(e) { /* TODO */ }
        function recalcRecipeRowTotal() { /* TODO */ }
        function recalcRecipeGrandTotal() { /* TODO */ }
    </script>

    <!-- ✅ ItemName exists check -->
    <script>
        (function () {
            const nameInput = document.getElementById('Item_ItemName');
            const msg = document.getElementById('itemNameMessage');
            if (!nameInput) return;

            let t = null;

            async function checkName() {
                const v = (nameInput.value || "").trim();
                if (!v) { if (msg) msg.textContent = ""; return; }

                const currentId = parseInt(document.getElementById("itemId")?.value || "0") || 0;

                if (currentId > 0) {
                    const originalName = (window.__editItemName || "").trim();
                    if (originalName && v === originalName) {
                        if (msg) msg.textContent = "";
                        return;
                    }
                }

                try {
                    const url = '@Url.Action("CheckItemName", "Item")'
                        + '?itemName=' + encodeURIComponent(v)
                        + '&id=' + encodeURIComponent(currentId);

                    const res = await fetch(url, { cache: "no-store" });
                    const exists = await res.json();

                    if (exists) {
                        if (msg) msg.textContent = "Item Name already exists!";
                        window.showCenterToast?.("danger", "Item Name already exists!");
                    } else {
                        if (msg) msg.textContent = "";
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            nameInput.addEventListener("input", function () {
                clearTimeout(t);
                t = setTimeout(checkName, 300);
            });

            nameInput.addEventListener("blur", checkName);
        })();
    </script>
}
