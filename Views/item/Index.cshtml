@model object
@using System

@{
    ViewData["Title"] = "Item List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #eef2ff 0%, #f5f7fb 40%, #ffffff 100%);
        }

        .container-fluid {
            max-width: 100% !important;
            padding-left: 12px;
            padding-right: 12px;
        }

        .page-wrap-itemlist {
            max-width: 900px;
            margin: 12px 0 24px 0;
            padding-right: 0;
        }

        .inv-hero {
            position: sticky;
            top: 0;
            z-index: 9;
            background: linear-gradient(95deg, #0ea5e9 0%, #4f46e5 55%, #10b981 115%);
        }

        .inv-hero-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 18px;
            max-width: 900px;
            margin: 0 0 0 12px;
        }

        .inv-hero-accent {
            height: 4px;
            background: linear-gradient(90deg, #e0f2fe 0%, #ede9fe 50%, #d1fae5 100%);
            opacity: .95;
        }

        .toolbar {
            background: #ffffff;
            border: 1px solid #e6eaf2;
            border-radius: 16px;
            padding: 10px 12px;
            margin-top: 10px;
        }

            .toolbar .row {
                align-items: center;
            }

        .timebox {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            color: #0f172a;
        }

            .timebox .sep {
                opacity: .6;
            }

        .kpi-wrap {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .kpi {
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #eef;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .03);
        }

        .kpi-items {
            background: #eff6ff;
            color: #1e3a8a;
            border-color: #dbeafe;
        }

        .kpi-stock {
            background: #fffbeb;
            color: #92400e;
            border-color: #fde68a;
        }

        .kpi-purchase {
            background: #ecfdf5;
            color: #065f46;
            border-color: #a7f3d0;
        }

        .kpi-sale {
            background: #fef2f2;
            color: #991b1b;
            border-color: #fecaca;
        }

        .chip {
            padding: 6px 12px;
            border-radius: 999px;
            background: #ffffff;
            border: 1px solid #dbe1ea;
            font-weight: 800;
            cursor: pointer;
            white-space: nowrap;
        }

            .chip.active {
                background: #2563eb;
                color: #ffffff;
                border-color: #2563eb;
            }

        .input-ico {
            position: relative;
            display: flex;
            align-items: center;
            background: #F0FFFF;
            border: 1px solid #4f9eea;
            border-radius: 10px;
            min-height: 36px;
            padding-left: 34px;
            overflow: hidden;
        }

            .input-ico > i {
                position: absolute;
                left: 10px;
                color: #1d4ed8;
                opacity: .9;
                font-size: .95rem;
            }

            .input-ico input {
                border: none;
                outline: none;
                height: 34px;
                padding: .2rem .6rem;
                flex: 1;
                background: transparent;
                min-width: 220px;
                font-size: .9rem;
            }

        .type-input {
            height: 34px;
            border: none;
            outline: none;
            width: 100%;
            min-width: 180px;
            background: transparent;
        }

        .btn-mini {
            height: 36px;
            border-radius: 10px;
            padding: 0 .7rem;
            font-weight: 800;
            border: 1px solid #dbeafe;
            color: #1e3a8a;
            background: #eff6ff;
            display: inline-flex;
            align-items: center;
            gap: .45rem;
        }

            .btn-mini:hover {
                background: #e0efff;
            }

        .btn-split {
            position: relative;
        }

            .btn-split .drop {
                position: absolute;
                top: 110%;
                right: 0;
                min-width: 200px;
                background: #ffffff;
                color: #0f172a;
                border: 1px solid #e6eaf2;
                border-radius: 12px;
                box-shadow: 0 12px 28px rgba(2, 6, 23, .12);
                display: none;
                overflow: hidden;
            }

            .btn-split.open .drop {
                display: block;
            }

        .drop a,
        .drop button,
        .drop label {
            display: flex;
            align-items: center;
            gap: .5rem;
            width: 100%;
            padding: .6rem .8rem;
            background: #ffffff;
            border: 0;
            text-align: left;
        }

            .drop a:hover,
            .drop button:hover,
            .drop label:hover {
                background: #f5f7fb;
                cursor: pointer;
            }

        .btn-add {
            background: #0ea5e9;
            color: #ffffff;
            border: none;
            padding: 8px 14px;
            border-radius: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

            .btn-add:hover {
                filter: brightness(.95);
            }

        .table-responsive {
            border: 1px solid #e6eaf2;
            background: #ffffff;
            border-radius: 16px;
            overflow: hidden;
        }

        .table thead th {
            background: #f9fafb;
            font-weight: 800;
        }

        .table td {
            vertical-align: middle;
        }

        .table tbody tr:hover td {
            background: #dbeafe;
        }

        .num {
            text-align: right;
        }

        .code-badge {
            display: inline-block;
            padding: .28rem .55rem;
            border-radius: 999px;
            background: #f6ecfa;
            color: #6b21a8;
            border: 1px solid #e6d5e7;
            font-weight: 800;
            font-size: .85rem;
        }

        .status-badge {
            display: inline-block;
            padding: .28rem .55rem;
            border-radius: 999px;
            font-weight: 800;
            font-size: .8rem;
            border: 1px solid transparent;
        }

        .s-ok {
            background: #ecfdf5;
            color: #065f46;
            border-color: #a7f3d0;
        }

        .s-low {
            background: #fef2f2;
            color: #991b1b;
            border-color: #fecaca;
        }

        .s-exp {
            background: #fffbeb;
            color: #92400e;
            border-color: #fde68a;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid #e6eaf2;
            background: #ffffff;
            color: #0f172a;
            transition: background .15s, transform .04s;
        }

            .btn-icon:active {
                transform: translateY(1px);
            }

        .btn-edit {
            border-color: #93c5fd;
            color: #1d4ed8;
        }

            .btn-edit:hover {
                background: #e0f2fe;
            }

        .btn-del {
            border-color: #fecaca;
            color: #b91c1c;
        }

            .btn-del:hover {
                background: #fee2e2;
            }

        .pager-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 10px 12px;
            background: #F0FFFF;
            border: 1px solid #e6eaf2;
            border-radius: 16px;
            margin-top: 10px;
        }

        .pager-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pager-pages {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .page-btn {
            min-width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid #e6eaf2;
            background: #ffffff;
            font-weight: 700;
        }

            .page-btn.active {
                background: #2563eb;
                color: #ffffff;
                border-color: #2563eb;
            }

        .page-nav {
            padding: 0 10px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid #e6eaf2;
            background: #ffffff;
            font-weight: 700;
        }

        .btn-bottom {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding: 12px 14px;
            background: #ffffff;
            border: 1px solid #e6eaf2;
            border-radius: 16px;
            margin-top: 10px;
        }

        .btn-action {
            padding: 9px 14px;
            border: none;
            border-radius: 10px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-print {
            background: #2563eb;
            color: #ffffff;
        }

        .btn-clear {
            background: #facc15;
            color: #000000;
        }

        .btn-exit {
            background: #ef4444;
            color: #ffffff;
        }

        @@media print {
            .inv-hero, .toolbar, .pager-bar, .btn-bottom {
                display: none !important;
            }

            .table-responsive {
                border: none;
            }

            body {
                background: #ffffff;
            }
        }
    </style>
}

<!-- ===== Top Band ===== -->
<div class="inv-hero shadow-sm">
    <div class="inv-hero-inner">
        <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-boxes-stacked text-white"></i>
            <h5 class="mb-0 text-white fw-bold">@ViewData["Title"]</h5>
        </div>
        <div class="small text-white-50 d-none d-md-block">Inventory • Stock • Import/Export</div>
    </div>
    <div class="inv-hero-accent"></div>
</div>

<div class="container-fluid my-3 page-wrap-itemlist">
    <!-- Row 1: Time/Date + KPIs + Low stock -->
    <div class="toolbar">
        <div class="row g-2">
            <div class="col-md-8">
                <div class="timebox">
                    <i class="fa-regular fa-clock"></i>
                    <span id="nowTime">--:--:--</span>
                    <span class="sep">•</span>
                    <i class="fa-regular fa-calendar"></i>
                    <span id="nowDate">--/--/----</span>
                </div>

                <!-- KPIs (AJAX) -->
                <div class="kpi-wrap">
                    <div class="kpi kpi-items"><i class="fa-solid fa-list"></i> Items: <span id="kpiItems">0</span></div>
                    <div class="kpi kpi-stock"><i class="fa-solid fa-cubes"></i> Stock: <span id="kpiStock">0</span></div>
                    <div class="kpi kpi-purchase"><i class="fa-solid fa-cart-arrow-down"></i> Purchase: <span id="kpiPurchase">0.00</span></div>
                    <div class="kpi kpi-sale"><i class="fa-solid fa-sack-dollar"></i> Sale: <span id="kpiSale">0.00</span></div>
                </div>
            </div>

            <div class="col-md-4 d-flex justify-content-md-end justify-content-start align-items-start">
                <div id="chipLow" class="chip"><i class="fa-solid fa-triangle-exclamation"></i> Low Stock (≤5)</div>
            </div>
        </div>

        <!-- Row 2: Search + Flavour + Supplier + Category + Export/Import + Add -->
        <div class="row g-2 mt-2">
            <div class="col-lg-3 col-md-4">
                <div class="input-ico" title="Search by item name, code, barcode">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input id="itemSearch" type="text" placeholder="Search item..." autocomplete="off" />
                </div>
            </div>

            <div class="col-lg-2 col-md-3">
                <div class="input-ico" title="Filter by Flavour">
                    <i class="fa-solid fa-ice-cream"></i>
                    <input id="flavourSel" class="type-input" list="flavourList" placeholder="Flavour..." />
                    <datalist id="flavourList"></datalist>
                </div>
            </div>

            <div class="col-lg-2 col-md-3">
                <div class="input-ico" title="Filter by Supplier">
                    <i class="fa-solid fa-truck-field"></i>
                    <input id="supplierSel" class="type-input" list="supplierList" placeholder="Supplier..." />
                    <datalist id="supplierList"></datalist>
                </div>
            </div>

            <div class="col-lg-2 col-md-3">
                <div class="input-ico" title="Filter by Category">
                    <i class="fa-solid fa-shapes"></i>
                    <input id="categorySel" class="type-input" list="categoryList" placeholder="Category..." />
                    <datalist id="categoryList"></datalist>
                </div>
            </div>

            <div class="col-lg-3 col-md-3 d-flex gap-2 justify-content-md-end justify-content-start">
                <div class="btn-split" id="exportSplit">
                    <button type="button" class="btn-mini" id="btnExport"><i class="fa-solid fa-file-export"></i> Export</button>
                    <div class="drop">
                        <button type="button" id="expCsv"><i class="fa-solid fa-file-csv"></i> CSV / Excel</button>
                        <button type="button" id="expPdf"><i class="fa-solid fa-file-pdf"></i> PDF (Print)</button>
                        <button type="button" id="expCopy"><i class="fa-regular fa-copy"></i> Copy Table</button>
                    </div>
                </div>

                <div class="btn-split" id="importSplit">
                    <button type="button" class="btn-mini" id="btnImport"><i class="fa-solid fa-file-import"></i> Import</button>
                    <div class="drop">
                        <label style="padding:.55rem .8rem; display:block; cursor:pointer;">
                            <i class="fa-solid fa-file-csv"></i> Import CSV
                            <input type="file" id="importFile" accept=".csv" style="display:none;">
                        </label>
                    </div>
                </div>

                <button class="btn-add" onclick="window.location.href='@Url.Action("Add", "Item")'">
                    <i class="fa-solid fa-plus"></i> Add
                </button>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="table-responsive mt-2">
        <table class="table table-hover table-bordered mb-0" id="itemsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Item Code</th>
                    <th>Item Name</th>
                    <th>Flavour</th>
                    <th>Category</th>
                    <th>Supplier</th>
                    <th class="num">Purchase Price</th>
                    <th class="num">Sale Price</th>
                    <th class="num">Stock</th>
                    <th>Status</th>
                    <th style="width:110px;">Actions</th>
                </tr>
            </thead>
            <tbody id="itemsTbody">
                <tr><td colspan="11" class="text-center text-muted py-3">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination Bar -->
    <div class="pager-bar">
        <div class="pager-left">
            <label class="me-1 fw-bold">Rows:</label>
            <select id="pageSize" class="form-select form-select-sm" style="width:auto;">
                <option value="10">10 (A4 fit)</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
            <span class="ms-2 text-muted small" id="pageInfo"></span>
        </div>
        <div class="pager-right d-flex align-items-center gap-2">
            <button class="page-nav" id="prevPage">&laquo; Prev</button>
            <div class="pager-pages" id="pageNumbers"></div>
            <button class="page-nav" id="nextPage">Next &raquo;</button>
        </div>
    </div>

    <!-- Bottom Buttons -->
    <div class="btn-bottom">
        <button id="btnPrint" class="btn-action btn-print"><i class="fa-solid fa-print"></i> Print</button>
        <button id="btnClear" class="btn-action btn-clear"><i class="fa-solid fa-eraser"></i> Clear</button>
        <button class="btn-action btn-exit" onclick="window.location.href='@Url.Action("Index", "Home")'">
            <i class="fa-solid fa-door-open"></i> Exit
        </button>
    </div>
</div>

@section Scripts {
    <script>
        (function () {

            // Time/Date live
            function tick() {
                const n = new Date();
                document.getElementById('nowTime').textContent = n.toLocaleTimeString();
                document.getElementById('nowDate').textContent = n.toLocaleDateString();
            }
            setInterval(tick, 1000); tick();

            // Elements
            const tbody = document.getElementById("itemsTbody");

            const itemSearch = document.getElementById("itemSearch");
            const supplierSel = document.getElementById("supplierSel");
            const categorySel = document.getElementById("categorySel");
            const flavourSel  = document.getElementById("flavourSel");
            const chipLow     = document.getElementById("chipLow");

            const pageSizeSel = document.getElementById("pageSize");
            const pageNumbers = document.getElementById("pageNumbers");
            const pageInfo    = document.getElementById("pageInfo");
            const prevBtn     = document.getElementById("prevPage");
            const nextBtn     = document.getElementById("nextPage");

            const kpiItems    = document.getElementById("kpiItems");
            const kpiStock    = document.getElementById("kpiStock");
            const kpiPurchase = document.getElementById("kpiPurchase");
            const kpiSale     = document.getElementById("kpiSale");

            // Export/Import menus
            const exportSplit = document.getElementById('exportSplit');
            const importSplit = document.getElementById('importSplit');
            document.getElementById('btnExport')?.addEventListener('click', () => exportSplit.classList.toggle('open'));
            document.getElementById('btnImport')?.addEventListener('click', () => importSplit.classList.toggle('open'));
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#exportSplit')) exportSplit.classList.remove('open');
                if (!e.target.closest('#importSplit')) importSplit.classList.remove('open');
            });

            // State
            let currentPage = 1;
            let totalCount  = 0;
            let debounceT   = null;

            function esc(s){
                return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
            }

            function num(v){
                const x = parseFloat(v);
                return isNaN(x) ? 0 : x;
            }

            function getFilters(){
                return {
                    search: (itemSearch?.value || "").trim(),
                    supplier: (supplierSel?.value || "").trim(),
                    category: (categorySel?.value || "").trim(),
                    flavour: (flavourSel?.value || "").trim(),
                    low: chipLow?.classList.contains("active") || false,
                    pageSize: parseInt(pageSizeSel?.value || "25", 10) || 25
                };
            }

            function renderRows(items){
                if(!tbody) return;

                if(!items || !items.length){
                    tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-3">No items found</td></tr>`;
                    return;
                }

                tbody.innerHTML = items.map(it => {
                    const isLow = (num(it.quantity) <= 5);
                    const status = it.isExpired ? `<span class="status-badge s-exp ms-1">Expired</span>` : "";
                    const lowBadge = isLow ? `<span class="status-badge s-low">Low Stock</span>` : `<span class="status-badge s-ok">In Stock</span>`;

                    return `
                    <tr data-id="${it.id}">
                        <td>${it.id}</td>
                        <td><span class="code-badge">${esc(it.itemCode)}</span></td>
                        <td>${esc(it.itemName)}</td>
                        <td>${esc(it.flavour || "")}</td>
                        <td>${esc(it.categoryName || "")}</td>
                        <td>${esc(it.supplierName || "")}</td>
                        <td class="num">${num(it.purchasePrice).toFixed(2)}</td>
                        <td class="num">${num(it.salePrice).toFixed(2)}</td>
                        <td class="num ${isLow ? "text-danger":""}">${num(it.quantity)} pcs</td>
                        <td>${lowBadge}${status}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <a class="btn-icon btn-edit" title="Edit" href="@Url.Action("Edit", "Item")/${it.id}">
                                    <i class="fa-solid fa-pen-to-square"></i>
                                </a>
                                <a class="btn-icon btn-del" title="Delete" href="@Url.Action("Delete", "Item")/${it.id}"
                                   onclick="return confirm('Are you sure to delete this item?');">
                                    <i class="fa-solid fa-trash-can"></i>
                                </a>
                            </div>
                        </td>
                    </tr>`;
                }).join("");
            }

            function renderPager(){
                const pageSize = getFilters().pageSize;
                const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));

                if(currentPage > totalPages) currentPage = totalPages;

                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;

                if(totalCount <= 0){
                    pageInfo.textContent = "No rows";
                } else {
                    const start = (currentPage - 1) * pageSize + 1;
                    const end = Math.min(currentPage * pageSize, totalCount);
                    pageInfo.textContent = `Showing ${start}–${end} of ${totalCount}`;
                }

                pageNumbers.innerHTML = "";
                const windowSize = 5;
                let startP = Math.max(1, currentPage - Math.floor(windowSize/2));
                let endP = Math.min(totalPages, startP + windowSize - 1);
                if(endP - startP + 1 < windowSize){
                    startP = Math.max(1, endP - windowSize + 1);
                }

                function addBtn(p){
                    const b = document.createElement("button");
                    b.className = "page-btn" + (p === currentPage ? " active" : "");
                    b.textContent = p;
                    b.addEventListener("click", () => { currentPage = p; loadPage(); });
                    pageNumbers.appendChild(b);
                }

                if(startP > 1) addBtn(1);
                for(let p = startP; p <= endP; p++) addBtn(p);
                if(endP < totalPages) addBtn(totalPages);
            }

            // CSV Export (only current visible page)
            function tableToCSV() {
                const rows = Array.from(document.querySelectorAll('#itemsTable tr'));
                return rows.map(row => {
                    return Array.from(row.querySelectorAll('th,td')).map(cell => {
                        let t = (cell.innerText || "").replace(/\s+/g, ' ').trim();
                        t = t.replaceAll('"', '""');
                        return `"${t}"`;
                    }).join(',');
                }).join('\n');
            }

            function downloadBlob(data, filename, type) {
                const blob = new Blob([data], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                URL.revokeObjectURL(url);
            }

            document.getElementById('expCsv')?.addEventListener('click', () => {
                const csv = tableToCSV();
                downloadBlob(csv, 'items-export.csv', 'text/csv;charset=utf-8;');
            });
            document.getElementById('expPdf')?.addEventListener('click', () => window.print());
            document.getElementById('expCopy')?.addEventListener('click', async () => {
                const csv = tableToCSV();
                try { await navigator.clipboard.writeText(csv); alert('Table copied to clipboard (CSV format).'); }
                catch { alert('Copy failed.'); }
            });

            // Print & Clear
            document.getElementById('btnPrint')?.addEventListener('click', () => window.print());
            document.getElementById('btnClear')?.addEventListener('click', () => {
                itemSearch.value = "";
                supplierSel.value = "";
                categorySel.value = "";
                flavourSel.value = "";
                chipLow.classList.remove("active");
                currentPage = 1;
                loadPage();
            });

            // ✅ MAIN LOAD
            async function loadPage(){
                const f = getFilters();
                tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-3">Loading...</td></tr>`;

                const url = '@Url.Action("SearchItemsAjax", "Item")'
                    + `?search=${encodeURIComponent(f.search)}`
                    + `&supplier=${encodeURIComponent(f.supplier)}`
                    + `&category=${encodeURIComponent(f.category)}`
                    + `&flavour=${encodeURIComponent(f.flavour)}`
                    + `&low=${encodeURIComponent(f.low)}`
                    + `&page=${encodeURIComponent(currentPage)}`
                    + `&pageSize=${encodeURIComponent(f.pageSize)}`;

                try{
                    const res = await fetch(url, { cache:"no-store" });
                    if(!res.ok) throw new Error("Network error");
                    const data = await res.json();

                    totalCount = Number(data.totalCount || 0);
                    renderRows(data.items || []);
                    renderPager();

                    // KPIs (approx from current page + total)
                    if(kpiItems) kpiItems.textContent = totalCount.toString();

                    // simple KPIs from current page (fast)
                    const items = data.items || [];
                    const stock = items.reduce((a,x)=>a + num(x.quantity), 0);
                    const purchase = items.reduce((a,x)=>a + (num(x.purchasePrice) * num(x.quantity)), 0);
                    const sale = items.reduce((a,x)=>a + (num(x.salePrice) * num(x.quantity)), 0);

                    if(kpiStock) kpiStock.textContent = stock.toFixed(0);
                    if(kpiPurchase) kpiPurchase.textContent = purchase.toFixed(2);
                    if(kpiSale) kpiSale.textContent = sale.toFixed(2);

                    // datalist fill (collect from current page - light)
                    fillDatalistFromPage(items);

                } catch(e){
                    console.error(e);
                    tbody.innerHTML = `<tr><td colspan="11" class="text-center text-danger py-3">Load error</td></tr>`;
                }
            }

            // Lightweight datalist fill (from current page only)
            function fillDatalistFromPage(items){
                const dFlav = document.getElementById("flavourList");
                const dSup  = document.getElementById("supplierList");
                const dCat  = document.getElementById("categoryList");
                if(!dFlav || !dSup || !dCat) return;

                const flavs = new Set();
                const sups = new Set();
                const cats = new Set();

                (items || []).forEach(x=>{
                    if((x.flavour||"").trim()) flavs.add((x.flavour||"").trim());
                    if((x.supplierName||"").trim()) sups.add((x.supplierName||"").trim());
                    if((x.categoryName||"").trim()) cats.add((x.categoryName||"").trim());
                });

                function up(dl, set){
                    // keep previous + add new
                    const existing = new Set(Array.from(dl.querySelectorAll("option")).map(o => o.value));
                    set.forEach(v => existing.add(v));
                    dl.innerHTML = Array.from(existing).sort().map(v => `<option value="${esc(v)}"></option>`).join("");
                }

                up(dFlav, flavs);
                up(dSup, sups);
                up(dCat, cats);
            }

            function debounceLoad(){
                clearTimeout(debounceT);
                debounceT = setTimeout(() => { currentPage = 1; loadPage(); }, 250);
            }

            itemSearch?.addEventListener("input", debounceLoad);
            supplierSel?.addEventListener("input", debounceLoad);
            categorySel?.addEventListener("input", debounceLoad);
            flavourSel?.addEventListener("input", debounceLoad);

            chipLow?.addEventListener("click", () => {
                chipLow.classList.toggle("active");
                currentPage = 1;
                loadPage();
            });

            pageSizeSel?.addEventListener("change", () => { currentPage = 1; loadPage(); });

            prevBtn?.addEventListener("click", () => { if(currentPage > 1){ currentPage--; loadPage(); } });
            nextBtn?.addEventListener("click", () => { currentPage++; loadPage(); });

            // First render
            document.addEventListener("DOMContentLoaded", () => loadPage());

        })();
    </script>
}
