@model IEnumerable<GSoftPosNew.Models.CustomerReportDto>

@{
    var role = Context.Items["UserRole"] as string;
    var permissions = Context.Items["UserPermissions"] as Dictionary<string, bool> ?? new();
    ViewData["Title"] = "Customer Report";
    var totalCustomers = Model?.Count() ?? 0;
    var sumSales = Model?.Sum(x => x.Debit) ?? 0m;
    var sumPayments = Model?.Sum(x => x.Credit) ?? 0m;
    var sumAdvance = Model?.Sum(x => x.Advance) ?? 0m;
    var sumReceivable = Model?.Sum(x => x.Receivable) ?? 0m;
    var sumPayable = Model?.Sum(x => x.Payable) ?? 0m;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    :root {
        --ink: #0f172a;
        --muted: #64748b;
        --bg: #f8fafc;
        --card: #fff;
        --line: #e2e8f0;
        --shadow: 0 8px 24px rgba(2,6,23,.06);
        --indigo: #1e3a8a;
    }

    body {
        background: var(--bg);
    }

    .card {
        border: 1px solid var(--line);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
        background: var(--card);
    }

    .card-header {
        background: linear-gradient(135deg,#e0f2fe 0%,#dbeafe 40%,#bfdbfe 100%) !important;
        border-bottom: 1px solid #c7d2fe;
        padding: 12px 16px;
    }

    .hdr-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .hdr-title {
        display: flex;
        align-items: center;
        gap: .55rem;
        font-weight: 800;
        color: var(--indigo);
        margin: 0;
        letter-spacing: .2px;
        white-space: nowrap;
    }

    .hdr-right {
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .chip-time {
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        background: #eff6ff;
        color: var(--indigo);
        border: 1px solid #bfdbfe;
        border-radius: 999px;
        padding: .35rem .6rem;
        font-weight: 700;
        font-size: .9rem;
        white-space: nowrap;
    }

    .search-wrap {
        display: flex;
        align-items: center;
        gap: .4rem;
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: .25rem .45rem;
        min-width: 260px;
    }

    #searchBox {
        border: none;
        outline: none;
        height: 38px;
        flex: 1;
        background: transparent;
    }

    .toolbar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        padding: 10px 16px;
        border-bottom: 1px dashed var(--line);
        background: #fafcff;
    }

    .btn-chip {
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        border: 1px solid #cbd5e1;
        background: #f8fafc;
        color: var(--ink);
        border-radius: 999px;
        padding: .45rem .75rem;
        font-weight: 700;
        cursor: pointer;
        transition: background .15s ease,border-color .15s ease, transform .04s ease;
        white-space: nowrap;
    }

        .btn-chip:hover {
            background: #eef2f7;
        }

        .btn-chip.active {
            border-color: #93c5fd;
            background: #e0f2fe;
            color: #1e3a8a;
        }

        .btn-chip .sum {
            font-weight: 800;
        }

    /* ===== TABLE ===== */
    .table-responsive {
        overflow-x: auto;
    }

    #customerTable {
        min-width: 600px;
    }

        #customerTable thead th {
            position: sticky;
            top: 0;
            z-index: 2;
            background: #f1f5f9;
            color: #0f172a;
            border-bottom: 1px solid var(--line);
            font-weight: 800;
            letter-spacing: .02em;
            white-space: nowrap; /* prevent wrap */
            overflow: hidden;
            text-overflow: ellipsis; /* show ... if too long */
            font-size: 0.9rem;
        }

        #customerTable tbody tr:hover {
            background: #f8fafc !important;
        }

        #customerTable td.text-end {
            font-weight: 400;
        }

        #customerTable tfoot {
            background: #eff6ff;
            color: #1e3a8a;
            border-top: 1px solid #bfdbfe;
            font-weight: 700;
        }

    /* Responsive font size for table headings on small screens */
    @@media (max-width: 576px) {
        #customerTable thead th

    {
        font-size: 0.8rem;
    }

    }

    /* Modern buttons */
    .modern-btn {
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 50px;
        color: #fff !important;
        font-weight: 500;
        background: linear-gradient(135deg, #4f46e5, #06b6d4);
        border: none;
        box-shadow: 0 4px 10px rgba(79, 70, 229, 0.25);
        transition: all .25s ease;
        white-space: nowrap;
    }

        .modern-btn:hover {
            background: linear-gradient(135deg, #4338ca, #0ea5e9);
            box-shadow: 0 6px 14px rgba(79, 70, 229, 0.35);
        }
</style>

<div class="container-fluid py-4">
    <div class="card rounded-3">
        <!-- Header -->
        <div class="card-header">
            <div class="hdr-row">
                <h3 class="hdr-title">
                    <i class="fa-solid fa-user-group"></i> Customer Report
                </h3>
                <div class="hdr-right">
                    <span class="chip-time">
                        <i class="fa-regular fa-clock"></i>
                        <span id="liveClock">—</span>
                    </span>
                    <div class="search-wrap">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="searchBox" placeholder="Search customer..." />
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button id="btnAll" class="btn-chip active" type="button" title="Show all">
                <i class="fa-regular fa-rectangle-list"></i>
                All <span class="sum">@totalCustomers</span>
            </button>
            <button id="btnReceivable" class="btn-chip" type="button" title="Only receivable > 0">
                <i class="fa-solid fa-arrow-trend-up"></i>
                Receivable <span class="sum">@sumReceivable.ToString("N2")</span>
            </button>
            <button id="btnPayable" class="btn-chip" type="button" title="Only payable > 0">
                <i class="fa-solid fa-arrow-trend-down"></i>
                Payable <span class="sum">@sumPayable.ToString("N2")</span>
            </button>
        </div>

        <!-- Table -->
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="customerTable" class="table table-bordered table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th class="text-end">Total Sales (₨)</th>
                            <th class="text-end">Payments (₨)</th>
                            <th class="text-end">Advance (₨)</th>
                            <th class="text-end">Receivable (₨)</th>
                            <th class="text-end">Payable (₨)</th>
                            @if (permissions.TryGetValue("CustomersProducts", out var canAccessCustomersProducts) && canAccessCustomersProducts)
                            {
                                <th>Products</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-receivable="@item.Receivable" data-payable="@item.Payable">
                                <td>@item.CustomerName</td>
                                <td class="text-end">@item.Debit.ToString("N2")</td>
                                <td class="text-end">@item.Credit.ToString("N2")</td>
                                <td class="text-end">@item.Advance.ToString("N2")</td>
                                <td class="text-end text-success">@item.Receivable.ToString("N2")</td>
                                <td class="text-end text-danger">@item.Payable.ToString("N2")</td>
                                @if (permissions.TryGetValue("CustomersProducts", out var canAccessCustomersProduct) && canAccessCustomersProduct)
                                {
                                    <td>
                                        <a asp-action="CustomerProduct"
                                           asp-controller="Customer"
                                           asp-route-id="@item.CustomerId"
                                           class="modern-btn">
                                            <i class="bi bi-box-seam me-1"></i> Products
                                        </a>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>Total</td>
                            <td class="text-end">@sumSales.ToString("N2")</td>
                            <td class="text-end">@sumPayments.ToString("N2")</td>
                            <td class="text-end">@sumAdvance.ToString("N2")</td>
                            <td class="text-end">@sumReceivable.ToString("N2")</td>
                            <td class="text-end">@sumPayable.ToString("N2")</td>
                            @if (permissions.TryGetValue("CustomersProducts", out var canAccessCustomersProductss) && canAccessCustomersProductss)
                            {
                                <td></td>
                            }
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Live clock
        function tickClock(){
            const el = document.getElementById('liveClock');
            if(!el) return;
            el.textContent = new Date().toLocaleString('en-PK',{
                year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'
            });
        }
        tickClock(); setInterval(tickClock, 30000);

        // Search filter
        document.getElementById("searchBox").addEventListener("keyup", function () {
            var value = this.value.toLowerCase();
            var rows = document.querySelectorAll("#customerTable tbody tr");
            let anyVisible = false;

            rows.forEach(function (row) {
                const txt = row.innerText.toLowerCase();
                if (txt.includes(value) && row.dataset._hiddenByBtn !== "true") {
                    row.style.display = "";
                    anyVisible = true;
                } else {
                    row.style.display = "none";
                }
            });

            let noRow = document.getElementById("noResultsRow");
            if (!anyVisible) {
                if (!noRow) {
                    document.querySelector("#customerTable tbody")
                        .insertAdjacentHTML("beforeend",
                            "<tr id='noResultsRow'><td colspan='7' class='text-center text-muted'>No customers found</td></tr>");
                }
            } else if (noRow) { noRow.remove(); }
        });

        // Top totals buttons filtering
        const btnAll = document.getElementById('btnAll');
        const btnRec = document.getElementById('btnReceivable');
        const btnPay = document.getElementById('btnPayable');

        function setActive(btn){
            [btnAll, btnRec, btnPay].forEach(b=> b.classList.remove('active'));
            btn.classList.add('active');
        }

        function applyBtnFilter(mode){
            const rows = document.querySelectorAll("#customerTable tbody tr");
            rows.forEach(r=>{
                const rec = parseFloat(r.dataset.receivable || "0") || 0;
                const pay = parseFloat(r.dataset.payable   || "0") || 0;
                let hide = false;
                if(mode==='rec') hide = !(rec > 0);
                else if(mode==='pay') hide = !(pay > 0);
                else hide = false;
                r.dataset._hiddenByBtn = hide ? "true" : "false";
            });
            document.getElementById("searchBox").dispatchEvent(new Event('keyup'));
        }

        btnAll.addEventListener('click', ()=>{ setActive(btnAll); applyBtnFilter('all'); });
        btnRec.addEventListener('click', ()=>{ setActive(btnRec); applyBtnFilter('rec'); });
        btnPay.addEventListener('click', ()=>{ setActive(btnPay); applyBtnFilter('pay'); });
    </script>
}
