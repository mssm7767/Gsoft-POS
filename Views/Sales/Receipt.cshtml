@using GSoftPosNew.ViewModels
@model SaleReceiptViewModel
@{
    Layout = null;
    bool isReturn = Model.InvoiceNumber.Contains("RETURN") || Model.InvoiceNumber.Contains("R-") || Model.Total < 0;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Receipt</title>

    <style>
        /* Thermal Printer Specific Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', 'Monaco', monospace;
            line-height: 1;
        }

        :root {
            --line: #222; /* soft black */
            --line2: #d9d9d9; /* light lines */
            --text: #000;
            --muted: #333; /* darker */
            /* ✅ ONLY CHANGE: overall receipt font scale (slightly bigger) */
            --fs: 1.14; /* was 1.10 -> now a little bigger (not too much) */
        }

        body {
            width: 80mm;
            max-width: 80mm;
            margin: 0 auto;
            padding: 1.5mm;
            font-size: calc(10px * var(--fs)); /* ✅ scalable */
            background: white;
            color: #000;
        }

        @@page {
            size: 80mm auto;
            margin: 0;
            padding: 0;
        }

        @@media print {
            body {
                padding: 1mm;
                margin: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }
        }

        .receipt-container {
            width: 100%;
            padding: 0;
        }

        /* Header Section */
        .header {
            text-align: center;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--line);
            margin-bottom: 6px;
        }

        .logo {
            width: 55px;
            height: 55px;
            margin: 3px auto;
            display: block;
            object-fit: contain;
        }

        .shop-title {
            font-weight: 900;
            font-size: calc(14px * var(--fs)); /* ✅ scalable */
            letter-spacing: 0.6px;
            margin: 3px 0;
            text-transform: uppercase;
            color: var(--text);
        }

        /* Address + Contact */
        .shop-details {
            font-size: calc(9px * var(--fs)); /* ✅ scalable */
            line-height: 1.25;
            font-weight: 800;
            color: #111;
        }

        /* Return Badge */
        .return-badge {
            background-color: #ff4444;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 900;
            font-size: calc(10px * var(--fs)); /* ✅ scalable */
            display: inline-block;
            margin-bottom: 3px;
        }

        /* Invoice Info */
        .invoice-details {
            margin: 6px 0;
            padding: 4px 0;
            border-top: none;
            border-bottom: 1px solid var(--line);
            font-size: calc(10px * var(--fs)); /* ✅ scalable */
            color: var(--text);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            padding: 1px 0;
        }

            .detail-row .bold {
                font-weight: 900;
                color: #000;
            }

            .detail-row span:last-child {
                font-weight: 800;
                color: #000;
            }

        /* ITEMS header line */
        .items-header-line {
            display: flex;
            align-items: center;
            font-weight: 900;
            font-size: calc(10px * var(--fs)); /* ✅ scalable */
            border-top: none;
            border-bottom: 1px solid var(--line);
            padding: 3px 0;
            margin: 6px 0 4px 0;
            color: #000;
        }

            .items-header-line .h-sr {
                width: 18px;
                text-align: left;
            }

            .items-header-line .h-title {
                flex: 1;
                text-align: center;
            }

            .items-header-line .h-amt {
                width: 60px;
                text-align: right;
                padding-right: 2px;
            }

        /* Items Rows */
        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid var(--line2);
            font-size: calc(10px * var(--fs)); /* ✅ scalable */
            align-items: flex-start;
        }

            .item-row:last-child {
                border-bottom: none;
            }

        .item-left {
            display: flex;
            align-items: flex-start;
            flex: 1;
            min-width: 0;
        }

        .srbox {
            width: 18px;
            font-weight: 900;
            font-size: calc(10px * var(--fs)); /* ✅ scalable */
            text-align: left;
            padding-top: 1px;
            flex-shrink: 0;
            color: #000;
        }

        .item-details {
            flex: 1;
            padding-left: 5px;
            overflow: hidden;
            line-height: 1.2;
            min-width: 0;
        }

        .item-name {
            display: block;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            font-weight: 900;
            margin-bottom: 1px;
            color: #000;
        }

        .item-meta {
            font-size: calc(9px * var(--fs)); /* ✅ scalable */
            line-height: 1.15;
            color: #000;
            font-weight: 800;
            opacity: 1;
        }

        .qty-price {
            background: #f3f3f3;
            padding: 1px 3px;
            border-radius: 2px;
            display: inline-block;
            font-weight: 900;
            border: 1px solid #d0d0d0;
            color: #000;
        }

        .disc-badge {
            color: #b00000;
            font-weight: 900;
            margin-left: 5px;
        }

        .tax-badge {
            color: #0a7a0a;
            font-weight: 900;
            margin-left: 5px;
        }

        .item-amount {
            text-align: right;
            font-weight: 900;
            padding-right: 2px;
            line-height: 1.2;
            padding-top: 2px;
            width: 60px;
            flex-shrink: 0;
            color: #000;
        }

        /* Totals */
        .totals {
            margin: 8px 0;
            padding-top: 4px;
            border-top: none;
            color: #000;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: calc(11px * var(--fs)); /* ✅ scalable */
            padding: 1px 0;
            color: #000;
        }

            .total-line span:first-child {
                font-weight: 900;
            }

            .total-line span:last-child {
                font-weight: 900;
            }

        .grand-total {
            font-weight: 900;
            font-size: calc(13px * var(--fs)); /* ✅ scalable */
            border-top: 1px solid var(--line);
            padding-top: 4px;
            margin-top: 4px;
            color: #000;
        }

        /* Payment */
        .payment-section {
            background: #f3f3f3;
            padding: 5px;
            margin: 8px 0;
            border-radius: 3px;
            border: 1px solid #d0d0d0;
            font-size: calc(11px * var(--fs)); /* ✅ scalable */
            color: #000;
        }

        .payment-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            padding: 1px 0;
            color: #000;
        }

            .payment-row span:first-child {
                font-weight: 900;
            }

            .payment-row span:last-child {
                font-weight: 900;
            }

        /* QR */
        .qr-section {
            margin: 8px 0;
            padding: 5px 0;
            border: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-message {
            flex: 1;
            text-align: left;
            font-size: calc(9px * var(--fs)); /* ✅ scalable */
            line-height: 1.35;
            padding-right: 5px;
            color: #000;
            font-weight: 800;
        }

            .custom-message strong {
                font-weight: 900;
            }

        .qr-container {
            flex-shrink: 0;
            text-align: right;
        }

        .qr-code {
            width: 55px;
            height: 55px;
            display: block;
            border: 1px solid #cfcfcf;
            padding: 2px;
            background: white;
        }

        .qr-text {
            font-weight: 900;
            font-size: calc(8px * var(--fs)); /* ✅ scalable */
            margin-top: 2px;
            text-align: center;
            color: #000;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid var(--line);
            font-size: calc(9px * var(--fs)); /* ✅ scalable */
            line-height: 1.3;
            color: #000;
        }

        .company-info {
            margin: 4px 0;
            font-size: calc(8px * var(--fs)); /* ✅ scalable */
            color: #000;
            font-weight: 800;
            line-height: 1.25;
        }

        .contact-info {
            font-weight: 900;
            margin: 4px 0 0 0;
            font-size: calc(9px * var(--fs)); /* ✅ scalable */
            line-height: 1.25;
            color: #000;
        }

        .bold {
            font-weight: 900;
        }

        .text-red {
            color: #b00000;
            font-weight: 900;
        }

        /* Print Button */
        .print-btn {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            font-weight: bold;
            font-size: calc(12px * var(--fs)); /* ✅ scalable */
        }
    </style>
</head>

<body>
    <button class="print-btn no-print" onclick="printReceipt()">🖨 PRINT RECEIPT</button>

    <div class="receipt-container">

        <!-- Header -->
        <div class="header">
            <img src="@(!string.IsNullOrEmpty(ViewBag.Setting?.LogoPath)
                                                                                                ? Url.Content(ViewBag.Setting.LogoPath)
                                                                                                : "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIHZpZXdCb3g9IjAgMCA1NSA1NSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNTUiIGhlaWdodD0iNTUiIHJ4PSI1IiBmaWxsPSIjMjU2M2ViIi8+PHBhdGggZD0iTTE4IDM3TDM3IDE4TTM3IDM3TDE4IDE4IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==")"
                 alt="Logo"
                 class="logo" />

            <div class="shop-title">@(ViewBag.Setting?.ShopName ?? "G-SOFT SYSTEMS")</div>

            <div class="shop-details">
                @ViewBag.Setting?.Address<br />
                📞 0345-9166257 / 0335-9166257
            </div>

            @if (isReturn)
            {
                <div class="return-badge">RETURN INVOICE</div>
            }
        </div>

        <!-- Invoice Details -->
        <div class="invoice-details">
            <div class="detail-row">
                <span class="bold">Invoice #:</span>
                <span>@Model.InvoiceNumber</span>
            </div>
            <div class="detail-row">
                <span class="bold">Date:</span>
                <span>@Model.SaleDate.ToString("dd/MM/yyyy hh:mm tt")</span>
            </div>
            <div class="detail-row">
                <span class="bold">Customer:</span>
                <span>@Model.CustomerName (Bal: @ViewBag.Balance)</span>
            </div>
            <div class="detail-row">
                <span class="bold">Cashier:</span>
                <span>@Model.CashierName</span>
            </div>
        </div>

        <!-- ITEMS header -->
        <div class="items-header-line">
            <div class="h-sr">#</div>
            <div class="h-title">ITEMS</div>
            <div class="h-amt">AMOUNT</div>
        </div>

        <!-- Items -->
        @if (Model.Items != null && Model.Items.Any())
        {
            var srNo = 1;
            foreach (var item in Model.Items)
            {
                <div class="item-row">
                    <div class="item-left">
                        <div class="srbox">@srNo</div>

                        <div class="item-details">
                            <span class="item-name">@item.ItemName</span>

                            <div class="item-meta">
                                <span class="qty-price">
                                    @item.Quantity.ToString("0.##") x @item.UnitPrice.ToString("N0")
                                </span>

                                @if (item.DiscountPercent > 0)
                                {
                                    <span class="disc-badge">@item.DiscountPercent% Disc</span>
                                }
                                @if (item.TaxAmount > 0)
                                {
                                    <span class="tax-badge">@item.TaxAmount.ToString("N0") Tax</span>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="item-amount">@item.LineTotal.ToString("N0")</div>
                </div>
                srNo++;
            }
        }
        else
        {
            <div class="item-row">
                <div class="item-left">
                    <div class="srbox">&nbsp;</div>
                    <div class="item-details">No items in this sale</div>
                </div>
                <div class="item-amount">0</div>
            </div>
        }

        <!-- Totals -->
        <div class="totals">
            <div class="total-line">
                <span>Sub Total:</span>
                <span>@Model.SubTotal.ToString("N0")</span>
            </div>

            @if (Model.ServiceCharges != null && Model.ServiceCharges > 0)
            {
                <div class="total-line">
                    <span>Service Charges:</span>
                    <span>+@Model.ServiceCharges?.ToString("N0")</span>
                </div>
            }

            @if (Model.Tax > 0)
            {
                <div class="total-line">
                    <span>Tax Amount:</span>
                    <span>+@Model.Tax.ToString("N0")</span>
                </div>
            }

            @if (Model.Discount > 0)
            {
                <div class="total-line">
                    <span>Total Discount:</span>
                    <span>-@Model.Discount.ToString("N0")</span>
                </div>
            }

            <div class="total-line grand-total @(isReturn ? "text-red" : "")">
                <span>@(isReturn ? "RETURN AMOUNT:" : "GRAND TOTAL:")</span>
                <span>@(isReturn ? "-" : "")@Math.Abs(Model.Total).ToString("N0")</span>
            </div>
        </div>

        <!-- Payment -->
        <div class="payment-section">
            <div class="payment-row">
                <span class="bold">Payment:</span>
                <span>@Model.PaymentMethod</span>
            </div>
            <div class="payment-row">
                <span>@(isReturn ? "Refund Amount:" : "Amount Paid:")</span>
                <span class="bold">@Math.Abs(Model.PaidAmount).ToString("N0")</span>
            </div>
            @if (Model.Change > 0)
            {
                <div class="payment-row">
                    <span>@(isReturn ? "Balance:" : "Change:")</span>
                    <span class="bold">@Math.Abs(Model.Change).ToString("N0")</span>
                </div>
            }
        </div>

        <!-- QR -->
        <div class="qr-section">
            <div class="custom-message">
                <strong>For Customer:</strong><br />
                Please check all items before leaving.<br />
                Goods once sold cannot be returned<br />
                without original receipt.
            </div>
            <div class="qr-container">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=55x55&data=@Model.InvoiceNumber&margin=0"
                     alt="QR Code"
                     class="qr-code" />
                <div class="qr-text">Scan Invoice</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="company-info">
                @ViewBag.Setting?.Message<br />
                <strong>Software developed by G-Soft Systems</strong>
            </div>

            <div class="contact-info">
                📞 0345-9166257 | 0335-9166257<br />
                📱 WhatsApp | Facebook | Instagram
            </div>
        </div>

    </div>

    <script>
        function autoPrint() { setTimeout(() => { window.print(); }, 400); }
        function printReceipt() { window.print(); }
        window.onafterprint = function () { setTimeout(() => { window.close(); }, 400); };
        document.addEventListener('DOMContentLoaded', autoPrint);
    </script>
</body>
</html>