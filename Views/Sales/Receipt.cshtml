@using GSoftPosNew.ViewModels
@model SaleReceiptViewModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Receipt</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #fff;
        }

        #receiptContent {
            width: 80mm;
            margin: 0 auto;
            padding: 6px;
            font-size: 11px;
        }

        .dashed {
            border-top: 1px dashed #444;
        }

        .dashed-light {
            border-top: 1px dashed #999;
        }

        @@page {
            size: 80mm 170mm;
            margin: 0;
        }

        @@media print {
            body * {
                visibility: hidden;
            }

            #receiptContent, #receiptContent * {
                visibility: visible;
            }

            #receiptContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                height: 170mm;
            }

            #printBtn {
                display: none !important;
            }
        }
    </style>

    @functions {
        string DiscText(SaleItemReceiptVM item)
        {
            if (item == null) return "0";
            return item.DiscountPercent > 0 ? $"{item.DiscountPercent:0.##}%" : "0";
        }

        string TaxText(SaleItemReceiptVM item)
        {
            if (item == null) return "0";
            return item.TaxAmount > 0 ? $"{item.TaxAmount:N0}" : "0";
        }
    }
</head>

<body class="font-mono text-black text-xs">

    <div class="text-center mb-2">
        <button id="printBtn" onclick="printReceipt()" class="bg-blue-500 text-white px-3 py-1 rounded hidden">
            🖨 Print
        </button>
    </div>

    <div id="receiptContent">

        <!-- Header -->
        <div class="text-center mb-2">
            <img src="@(!string.IsNullOrEmpty(ViewBag.Setting?.LogoPath)
                                              ? Url.Content(ViewBag.Setting.LogoPath)
                                              : Url.Content("~/images/gsoftLogo.jpeg"))"
                 alt="Shop Logo"
                 class="w-16 h-16 mx-auto rounded-full shadow-md object-cover border border-gray-300 mb-2" />

            <div class="text-base font-bold tracking-wide">
                @(@ViewBag.Setting?.ShopName ?? "G-Soft")
            </div>

            <div class="text-gray-800 text-[12px]">@ViewBag.Setting?.Address</div>
            <div class="text-gray-800 text-[12px]">Phone: @ViewBag.Setting?.Contact1, @ViewBag.Setting?.Contact2</div>
        </div>

        <!-- Invoice Info -->
        <div class="dashed py-1 text-[11px] mb-1">
            <div><b>Invoice #:</b> @Model.InvoiceNumber</div>
            <div><b>Date:</b> @Model.SaleDate.ToString("dd MMM yyyy hh:mm tt")</div>
            <div><b>Customer:</b> @Model.CustomerName (Bal: @ViewBag.Balance)</div>
            <div><b>Cashier:</b> @Model.CashierName</div>
        </div>

        <!-- ITEMS -->
        <div class="mb-1">
            @if (Model.Items != null && Model.Items.Any())
            {
                <div class="dashed mb-1"></div>

                <div class="flex items-center gap-2 text-[11px] font-bold py-[2px]">
                    <div class="w-5 shrink-0 text-left">#</div>
                    <div class="flex-1 text-left">Items Descriptions</div>
                </div>

                <div class="dashed mb-1"></div>

                <!-- Headings -->
                <div class="text-[10px] font-bold py-[2px]">
                    <div class="grid grid-cols-5 gap-x-1">
                        <div class="text-left">Price</div>
                        <div class="text-center">Qty</div>
                        <div class="text-center">Dis</div>
                        <div class="text-center">Tax</div>
                        <div class="text-right">Total</div>
                    </div>
                </div>

                <div class="dashed-light mb-1"></div>

                @foreach (var item in Model.Items)
                {
                    var discShow = DiscText(item);
                    var taxShow = TaxText(item);

                    <div class="py-[2px]">
                        <!-- Line 1 -->
                        <div class="flex items-start gap-2 leading-4">
                            <div class="w-5 shrink-0 font-bold">@item.SrNo</div>
                            <div class="flex-1 break-words font-semibold">@item.ItemName</div>
                        </div>

                        <!-- Line 2 -->
                        <div class="mt-[2px] text-[10px] text-gray-900">
                            <div class="grid grid-cols-5 gap-x-1">
                                <div class="text-left">@item.UnitPrice.ToString("N0")</div>
                                <div class="text-center">@item.Quantity.ToString("0.###")</div>
                                <div class="text-center">@discShow</div>
                                <div class="text-center">@taxShow</div>
                                <div class="text-right font-semibold">@item.LineTotal.ToString("N0")</div>
                            </div>
                        </div>

                        <div class="dashed-light mt-1"></div>
                    </div>
                }
            }
            else
            {
                <div class="text-center text-red-500 py-2">No items found</div>
            }
        </div>

        <!-- Totals -->
        <div class="dashed mt-1"></div>

        <table class="w-full text-[11px] mt-1">
            <tr>
                <td class="text-right pr-2">SubTotal:</td>
                <td class="text-right font-semibold">@Model.SubTotal.ToString("N0")</td>
            </tr>

            @if (Model.ServiceCharges != null && Model.ServiceCharges > 0)
            {
                <tr>
                    <td class="text-right pr-2">Service Charges:</td>
                    <td class="text-right font-semibold">@Model.ServiceCharges?.ToString("N0")</td>
                </tr>
            }

            <tr>
                <td class="text-right pr-2">Tax:</td>
                <td class="text-right font-semibold">@Model.Tax.ToString("N0")</td>
            </tr>

            <tr>
                <td class="text-right pr-2">Discount:</td>
                <td class="text-right font-semibold">-@Model.Discount.ToString("N0")</td>
            </tr>

            <tr class="border-t border-black text-sm font-bold">
                <td class="text-right pr-2">TOTAL:</td>
                <td class="text-right">(@Model.Total.ToString("N0"))</td>
            </tr>
        </table>

        <!-- Payment -->
        <div class="mt-2 text-[11px]">
            <div class="flex justify-between"><b>Method:</b><span>@Model.PaymentMethod</span></div>
            <div class="flex justify-between"><b>Paid:</b><span>@Model.PaidAmount.ToString("N0")</span></div>
            <div class="flex justify-between"><b>Change:</b><span>@Model.Change.ToString("N0")</span></div>
        </div>

        <!-- Footer -->
        <div class="text-center text-[11px] mt-2 dashed pt-1">
            <div class="mb-1">@ViewBag.Setting?.Message</div>
            <div class="text-gray-600">Powered by <b>GSoftPos</b></div>
        </div>

        <!-- QR Code -->
        <div class="text-center mt-2">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=@Model.InvoiceNumber"
                 alt="QR Code"
                 class="mx-auto border border-gray-300 p-1 rounded" />
            <div class="text-[10px] text-gray-600">Scan for Invoice</div>
        </div>
    </div>

    <script>
        function printReceipt() { window.print(); }
        window.onload = function () { window.print(); };
        window.onafterprint = function () { window.close(); };
    </script>
</body>
</html>
