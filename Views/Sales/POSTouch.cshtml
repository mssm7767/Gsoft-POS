@using System.Text.Json
@model IEnumerable<ItemModel>
@{
    ViewData["Title"] = "Touch POS – Restaurant Fast Food";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var invoiceNo = ViewBag.InvoiceLastDigit;
    var safeModel = Model ?? new List<ItemModel>();
    var itemsJson = JsonSerializer.Serialize(safeModel);
}

@Html.AntiForgeryToken()

@section Styles {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --bg: #f6f8fb;
            --panel: #fff;
            --line: #e7ecf3;
            --ink: #0f172a;
            --muted: #667085;
            --shadow: 0 10px 28px rgba(2,6,23,.06);
            --hdrBlue1: #0ea5e9;
            --hdrBlue2: #3b82f6;
            --hdrBlue3: #60a5fa;
            --yellow-50: #fffbeb;
            --rose-600: #b91c1c;
            --rose-50: #fef2f2;
            --thumb: 82px;
        }

        * {
            box-sizing: border-box
        }

        body {
            background: var(--bg);
            color: var(--ink)
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow);
            min-height: 0;
            display: flex;
            flex-direction: column
        }

        .soft-input {
            height: 38px;
            border: 1px solid var(--line);
            border-radius: 12px;
            background: #fff;
            padding: 0 .65rem;
            outline: none
        }

            .soft-input:focus {
                box-shadow: 0 0 0 3px #bfdbfe55;
                border-color: #bfdbfe
            }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        /* Layout */
        .pos-root {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 16px;
            min-height: calc(100vh - 80px)
        }

        .left-col {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 10px
        }

        /* Header */
        .pos-left-header {
            position: sticky;
            top: 0;
            z-index: 2;
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 14px 16px;
            color: #0b1324;
            border: 1px solid #e5e7eb;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background: radial-gradient(1200px 400px at -10% -50%, #e0f2fe 0%, transparent 50%), radial-gradient(1200px 500px at 110% -90%, #dbeafe 0%, transparent 55%), linear-gradient(180deg, #ffffffcc, #ffffffdd);
            backdrop-filter: blur(8px);
            box-shadow: 0 10px 28px rgba(2,6,23,.06);
            border-bottom: 1px solid #e7ecf3
        }

        .brand {
            display: flex;
            align-items: center;
            gap: .6rem;
            font-weight: 900;
            color: #0b1324
        }

            .brand i {
                color: #0ea5e9
            }

        .menu-label {
            margin-left: 8px;
            font-weight: 900;
            color: #0b1324;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            padding: .35rem .6rem;
            background: #f8fafc
        }

        /* Top search */
        .search-pro {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: .55rem;
            padding: .35rem .55rem;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            min-width: 280px;
            box-shadow: 0 6px 18px rgba(2,6,23,.05)
        }

            .search-pro i {
                color: #64748b
            }

            .search-pro input {
                border: none;
                outline: none;
                background: transparent;
                height: 36px;
                flex: 1;
                color: #0b1220
            }

        /* Categories */
        /* Main layout */
        .left-col {
            display: flex;
            flex-direction: column;
            height: 100vh; /* full height layout */
            overflow: hidden;
        }

        /* ========== CATEGORY SECTION ========== */
        .cat-pane.card {
            flex-shrink: 0;
            height: 350px; /* fixed height for category area */
            overflow-y: auto;
            border-bottom: 1px dashed var(--line);
        }

        .cat-grid {
            padding: 10px 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .cat-btn {
            display: flex;
            align-items: center;
            gap: .8rem;
            padding: .7rem .8rem;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
            color: #0f172a;
            transition: box-shadow .15s, transform .04s;
        }

            .cat-btn:hover {
                box-shadow: 0 0 0 2px #bfdbfe inset;
            }

        .cat-thumb {
            width: 68px;
            height: 68px;
            border-radius: 12px;
            object-fit: cover;
            border: 1px solid var(--line);
        }

        .cat-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

            .cat-meta .cat-name {
                font-weight: 800;
                color: #0f172a;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .cat-meta .cat-count {
                font-size: .78rem;
                color: #64748b;
            }

        /* ========== ITEMS SECTION ========== */
        .left-items.card {
            flex: 1 1 auto;
            overflow-y: auto; /* scroll only item section */
        }

        .left-items-head {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px dashed var(--line);
            flex-wrap: wrap;
        }

            .left-items-head h4 {
                margin: 0;
                font-weight: 900;
                color: #0f172a;
            }

        /* Items Grid */
        .left-items-grid {
            padding: 8px 10px;
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr)); /* exactly 3 per row */
            gap: 10px;
            justify-content: flex-start;
            overflow-x: auto; /* allows horizontal scroll if text is wide */
        }

        /* Each Item */
        .li-card {
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 8px 12px;
            background: #fff;
            display: inline-flex;
            gap: 10px;
            align-items: center;
            cursor: pointer;
            transition: transform .05s, box-shadow .15s;
            box-sizing: border-box;
            white-space: nowrap;
        }

            .li-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 0 0 2px #bfdbfe inset;
            }

        .li-thumb {
            width: 68px;
            height: 68px;
            border-radius: 12px;
            object-fit: cover;
            border: 1px solid var(--line);
        }

        .li-name {
            font-weight: 800;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .li-meta {
            display: flex;
            gap: 8px;
            color: var(--muted);
            font-size: .9rem;
        }

        .price-badge {
            background: var(--yellow-50);
            color: #7c2d12;
            border: 1px solid #fde68a;
            border-radius: 999px;
            padding: .05rem .45rem;
            font-weight: 800;
        }

        /* Right */
        .pos-right.card {
            display: flex
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px dashed var(--line);
            flex-wrap: wrap
        }

        .order-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        .order-no {
            font-weight: 900;
            color: #111827;
            border: 1px dashed #cbd5e1;
            border-radius: 10px;
            padding: .35rem .6rem;
            background: #f8fafc
        }

        .fs-btn {
            height: 38px;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            background: #fff;
            padding: 0 .65rem;
            font-weight: 800;
            cursor: pointer
        }

        #runningBtn.active {
            box-shadow: 0 0 0 2px #bfdbfe inset
        }

        /* --- New Order button: modern/pro states --- */
        .fs-btn.pro {
            height: 40px;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            padding: 0 .85rem;
            font-weight: 900;
            cursor: pointer;
            background: linear-gradient(180deg,#ffffff,#f8fafc);
            box-shadow: 0 4px 14px rgba(2,6,23,.08);
            transition: transform .04s ease, box-shadow .15s ease, background .2s ease, border-color .2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #0b1324;
        }

            .fs-btn.pro i {
                font-size: 14px;
            }

            .fs-btn.pro:hover {
                background: linear-gradient(180deg,#eff6ff,#e0f2fe);
                border-color: #bfdbfe;
                box-shadow: 0 6px 16px rgba(2,6,23,.12), inset 0 0 0 2px #dbeafe;
            }

            .fs-btn.pro:active {
                transform: translateY(1px);
                box-shadow: 0 3px 10px rgba(2,6,23,.10), inset 0 0 0 2px #bfdbfe;
            }

            .fs-btn.pro:focus-visible {
                outline: none;
                box-shadow: 0 0 0 3px #bfdbfe66, 0 6px 16px rgba(2,6,23,.12);
            }

            .fs-btn.pro.is-pressed {
                background: linear-gradient(180deg,#dbeafe,#bfdbfe);
                border-color: #93c5fd;
            }

        .cart {
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding: 10px 12px 0
        }

        .cart-head {
            display: grid;
            grid-template-columns: 1fr 110px 120px 120px 40px;
            gap: 8px;
            position: sticky;
            top: 0;
            background: #eff6ff;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: .55rem .6rem;
            font-weight: 800
        }

        .cart-body {
            overflow: auto;
            border: 1px solid var(--line);
            border-radius: 12px;
            margin-top: 8px;
            padding: 4px;
            background: #fff;
            min-height: 220px;
            max-height: 38vh
        }

        .cart-row {
            display: grid;
            grid-template-columns: 1fr 110px 120px 120px 40px;
            gap: 8px;
            align-items: center;
            border-bottom: 1px dashed #eef2f7;
            padding: .5rem .4rem
        }

        .cart-name {
            font-weight: 800;
            color: #0f172a
        }

        .qty-wrap {
            display: flex;
            align-items: center;
            gap: 6px
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--line);
            background: #fff;
            font-weight: 900
        }

        .qty-input {
            width: 50px;
            text-align: center
        }

        .price-input, .line-total {
            height: 36px;
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 0 .5rem;
            text-align: right;
            background: #fff
        }

        .remove-btn {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #fff;
            color: #b91c1c
        }

            .remove-btn:hover {
                background: #fef2f2
            }

        .totals {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px 12px
        }

        .t-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: .55rem .6rem
        }

        .t-inline {
            display: flex;
            gap: 6px;
            align-items: center
        }

        .t-input {
            height: 36px;
            min-width: 90px
        }

        .t-val {
            font-weight: 900;
            color: #0f172a
        }

        .grand {
            background: linear-gradient(90deg,#e0f2fe,#dbeafe);
            border-color: #bfdbfe
        }

        .keypad {
            padding: 2px 12px 10px
        }

        .keypad-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0 10px
        }

        .keypad-title {
            font-weight: 800;
            color: #0f172a
        }

        .pad-targets {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #64748b;
            font-weight: 700
        }

            .pad-targets label {
                display: flex;
                align-items: center;
                gap: 6px
            }

        .pad-grid {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 8px
        }

            .pad-grid button {
                height: 42px;
                border: 1px solid var(--line);
                background: #fff;
                border-radius: 10px;
                font-weight: 800;
                font-size: 1.05rem
            }

                .pad-grid button.accent {
                    background: #fffaf0;
                    border-color: #fde68a
                }

        .actions-cards {
            display: grid;
            grid-template-columns: repeat(6,1fr);
            gap: 10px;
            padding: 12px;
            border-top: 1px dashed var(--line);
            position: sticky;
            bottom: 0;
            background: var(--panel)
        }

        .act-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 5px;
            border: 1px solid var(--line);
            border-radius: 14px;
            background: #fff;
            cursor: pointer;
            font-weight: 800;
            color: #0f172a;
            text-align: center;
            transition: transform .06s, box-shadow .15s
        }

            .act-card i {
                font-size: 18px
            }

            .act-card:hover {
                transform: translateY(-1px);
                box-shadow: 0 0 0 2px #e2e8f0 inset
            }

            .act-card.primary {
                background: #eff6ff;
                border-color: #bfdbfe
            }

            .act-card.warn {
                background: #fffbeb;
                border-color: #fde68a
            }

            .act-card.danger {
                background: #ffeef0;
                border-color: #fecdd3
            }

            .act-card.info {
                background: #f0fdf4;
                border-color: #bbf7d0
            }

        .modal[hidden] {
            display: none
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: 10000
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(2,6,23,.35)
        }

        .modal-card {
            position: relative;
            margin: 8vh auto 0;
            max-width: 900px;
            background: #fff;
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: var(--shadow)
        }

        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-bottom: 1px solid var(--line)
        }

            .modal-head h3 {
                margin: 0;
                font-weight: 900;
                color: #0f172a;
                display: flex;
                gap: 8px;
                align-items: center
            }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--line);
            background: #fff;
            font-size: 20px;
            cursor: pointer
        }

        .modal-body {
            padding: 14px;
            max-height: 60vh;
            overflow: auto
        }

        .retrieve-modal {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 30px 80px rgba(2,6,23,.45);
            width: 900px;
            max-width: 96vw;
            max-height: 92vh;
            overflow: auto;
            border: 1px solid #e5e7eb
        }

        .retrieve-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #fcfcfd
        }

            .retrieve-head .title {
                font-weight: 800;
                color: #0b1324;
                display: flex;
                gap: 8px;
                align-items: center
            }

        .retrieve-toolbar {
            display: flex;
            gap: 8px;
            padding: 10px 16px;
            border-bottom: 1px solid #eef2f7;
            background: #fcfcfd
        }

        .table-hold th {
            position: sticky;
            top: 0;
            background: #f1f5f9
        }

        #centerFlash {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 41000;
            background: rgba(15,23,42,.15);
            pointer-events: none
        }

            #centerFlash .box {
                background: #ffffff;
                border: 1px solid #e5e7eb;
                border-radius: 16px;
                padding: 16px 22px;
                box-shadow: 0 30px 70px rgba(2,6,23,.25);
                font-weight: 900;
                color: #0b1324;
                display: flex;
                align-items: center;
                gap: 10px
            }

                #centerFlash .box i {
                    color: #22c55e;
                    font-size: 20px
                }

        #runningDrawer {
            position: fixed;
            right: -420px;
            top: 0;
            height: 100vh;
            width: 420px;
            background: #fff;
            border-left: 1px solid #e5e7eb;
            box-shadow: -10px 0 30px rgba(2,6,23,.08);
            z-index: 12000;
            transition: right .25s ease
        }

        .running-card {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--line);
            border-radius: 12px;
            transition: background .15s,border-color .15s;
            cursor: pointer
        }

            .running-card:hover {
                background: #f8fafc;
                border-color: #bfdbfe
            }

        /* SweetAlert on top of fullscreen */
        .swal2-container {
            z-index: 40000 !important;
        }

            .swal2-container.swal2-top-end {
                top: 1rem !important;
                right: 1rem !important;
                bottom: auto !important;
                left: auto !important;
            }

        @@media print {
            body * {
                visibility: hidden !important
            }

            #printArea, #printArea * {
                visibility: visible !important
            }

            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 16px
            }
        }

        @@media (max-width:1280px) {
            .cat-grid {
                grid-template-columns: repeat(3,1fr)
            }
        }

        @@media (max-width:980px) {
            .pos-root {
                grid-template-columns: 1fr
            }

            .cat-grid {
                grid-template-columns: repeat(2,1fr)
            }

            .cart-head, .cart-row {
                grid-template-columns: 1fr 90px 100px 100px 40px
            }

            .actions-cards {
                grid-template-columns: repeat(3,1fr)
            }
        }
    </style>
}

<style>
    .left-items-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: nowrap; /* 👈 keeps everything in one row */
        overflow-x: auto; /* 👈 allows horizontal scrolling if content too wide */
        white-space: nowrap;
        padding: 4px 0;
    }

        /* Optional: make scroll look nice */
        .left-items-controls::-webkit-scrollbar {
            height: 6px;
        }

        .left-items-controls::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .left-items-controls::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

    .left-search {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: .25rem .6rem;
        min-width: 240px;
        display: flex;
        align-items: center;
        gap: .5rem;
        box-shadow: 0 6px 18px rgba(2,6,23,.05);
    }

        .left-search input {
            border: none;
            outline: none;
            background: transparent;
            height: 36px;
            flex: 1;
        }

    .chip-group {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .chip {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 999px;
        padding: 4px 10px;
        cursor: pointer;
        font-weight: 600;
    }

        .chip.active {
            background: #0E8FEA;
            color: white;
            border-color: #0E8FEA;
        }

</style>

<div id="posApp" class="pos-root">
    <!-- LEFT -->
    <div class="left-col">
        <div class="card cat-pane">
            <div class="pos-left-header">
                <div class="brand">
                    <i class="fa-solid fa-burger"></i>
                    <span>@(ViewBag.ShopName ?? "G-Soft")</span>
                </div>


                <!-- UPDATED: add .pro -->
                <button id="newOrderBtn" class="fs-btn pro" title="Start New Order">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> New Order
                </button>
                <div class="menu-label">Menu</div>

                <div class="search-pro" title="Search menu categories by name or code">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input id="itemSearchTop" type="text" placeholder="Category name or code…  ( / to focus )" autocomplete="off">
                </div>
            </div>

            <div class="cat-pane card"><div id="catGrid" class="cat-grid"></div></div>
        </div>

        <!-- LEFT ITEMS -->
        <div class="left-items card">
            <div class="left-items-head">
                <h4 id="leftItemsTitle">Items</h4>
                <div class="left-items-controls">
                    <div class="left-search" title="Search by name or code">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input id="itemSearchBottom" type="text" placeholder="Search items…" autocomplete="off">
                    </div>

                    <div class="chip-group" id="bottomChips" style="margin-left:6px;">
                        <button class="chip active" data-mode="name">Name</button>
                        <button class="chip" data-mode="code">Code</button>
                    </div>

                    <label>Sort:</label>
                    <select id="sortSel" class="soft-input" style="height:34px">
                        <option value="name">Name (A–Z)</option>
                        <option value="price_asc">Price (Low → High)</option>
                        <option value="price_desc">Price (High → Low)</option>
                    </select>
                </div>
            </div>
            <div id="leftItemsGrid" class="left-items-grid"></div>
        </div>
    </div>

    <!-- RIGHT -->
    <main class="pos-right card">
        <section id="rightPane" class="pos-main">
            <div class="topbar">
                <div class="order-meta">
                    <span class="order-no">Order # <span id="orderNo">0001</span></span>

                    <select id="orderType" class="soft-input">
                        <option value="dinein">Dine-In</option>
                        <option value="takeaway">Takeaway</option>
                        <option value="delivery">Delivery</option>
                    </select>

                    <input id="tableNo" class="soft-input" placeholder="Table # / Token">
                    <select id="customer" class="soft-input">
                        <option value="">Customer / Phone"</option>
                        @if (ViewBag.Customer != null)
                        {
                            @foreach (var c in ViewBag.Customer)
                            {
                                <option value="@c.Id" data-id="@c.Id">@c.CustomerName</option>
                            }
                        }
                    </select>
                    <button id="addCustomerBtn" class="icon-btn" title="Add/Quick customer"><i class="fa-solid fa-user-plus"></i></button>

                    <select id="waiterSel" class="soft-input">
                        <option value="">Select Waiter</option>
                    </select>
                    <button id="addWaiterBtn" class="icon-btn" title="Add new waiter"><i class="fa-solid fa-plus"></i></button>
                </div>

                <button id="runningBtn" class="fs-btn" title="Running Orders">
                    <i class="fa-solid fa-list-check"></i>
                    <span>Running Orders</span>
                    <span id="runningCount" class="badge text-bg-light" style="margin-left:6px;">0</span>
                </button>

                <div class="now" style="display:flex;align-items:center;gap:8px">
                    <button id="fsBtn" class="fs-btn" title="Full Screen"><i class="fa-solid fa-up-right-and-down-left-from-center"></i></button>
                    <span id="nowTime"></span><span class="sep">•</span><span id="nowDate"></span>
                </div>
            </div>

            <div class="cart">
                <div class="cart-head">
                    <div class="h-item">Item</div>
                    <div class="h-qty">Qty</div>
                    <div class="h-price">Price</div>
                    <div class="h-total">Total</div>
                    <div class="h-act"></div>
                </div>
                <div id="cartBody" class="cart-body"></div>
            </div>

            <div class="totals">
                <div class="t-row">
                    <label>Tax</label>
                    <div class="t-inline">
                        <input id="tTax" class="soft-input t-input" type="number" step="0.01" value="0">
                        <select id="tTaxType" class="soft-input t-input">
                            <option value="percent">%</option>
                            <option value="flat">PKR</option>
                        </select>
                    </div>
                </div>
                <div class="t-row">
                    <label>Discount</label>
                    <div class="t-inline">
                        <input id="tDisc" class="soft-input t-input" type="number" step="0.01" placeholder="0.00">
                        <select id="tDiscType" class="soft-input t-input">
                            <option value="flat">PKR</option>
                            <option value="percent">%</option>
                        </select>
                    </div>
                </div>
                <div class="t-row grand">
                    <label>Grand Total</label>
                    <div id="tGrand" class="t-val">0.00</div>
                </div>
                <div class="t-row">
                    <label>Cash</label>
                    <div class="t-inline">
                        <input id="tCash" class="soft-input t-input" type="number" step="0.01" placeholder="0.00">
                        <select id="payMode" class="soft-input t-input" title="Mode of Payment">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="credit">Credit</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="t-row">
                    <label>Change</label>
                    <div id="tChange" class="t-val">0.00</div>
                </div>
            </div>

            <div class="keypad">
                <div class="keypad-head">
                    <div class="keypad-title">Keypad • <span id="padHeading">Qty</span></div>
                    <div class="pad-targets">
                        <span>Target:</span>
                        <label><input type="radio" name="padTarget" value="qty" checked> Qty</label>
                        <label><input type="radio" name="padTarget" value="price"> Price</label>
                        <label><input type="radio" name="padTarget" value="disc"> Discount</label>
                        <label><input type="radio" name="padTarget" value="cash"> Cash</label>
                        <label><input type="radio" name="padTarget" value="tax"> Tax</label>
                    </div>
                </div>
                <div class="pad-grid" id="padGrid">
                    <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button data-key="C" class="accent">C</button>
                    <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button data-key="⌫" class="accent">⌫</button>
                    <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button data-key="00">00</button>
                    <button data-key="0">0</button><button data-key=".">.</button><button data-key="100">100</button><button data-key="200">200</button>
                </div>
            </div>

            <div class="actions-cards">
                <div id="acModify" class="act-card info" title="Modify Order"><i class="fa-regular fa-pen-to-square"></i><div>Modify</div></div>
                <div id="acDelete" class="act-card danger" title="Delete Order"><i class="fa-regular fa-trash-can"></i><div>Delete</div></div>

                <div id="acKOT" class="act-card warn" title="KOT (Kitchen Only)"><i class="fa-solid fa-utensils"></i><div>KOT</div></div>

                <div id="acSaveOnly" class="act-card warn" title="Save Only (no print)"><i class="fa-solid fa-floppy-disk"></i><div>Save Only</div></div>
                <div id="acPrint" class="act-card primary" title="Save & Print"><i class="fa-solid fa-print"></i><div>Save & Print</div></div>

                <div id="acHold" class="act-card" title="Hold Invoice"><i class="fa-regular fa-bookmark"></i><div>Hold</div></div>
                <div id="acRetrieve" class="act-card" title="Retrieve Held"><i class="fa-regular fa-folder-open"></i><div>Retrieve</div></div>
            </div>
        </section>
    </main>

    <!-- Running Orders Drawer -->
    <div id="runningDrawer">
        <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid #eef2f7; background:#fcfcfd;">
            <div style="font-weight:900; display:flex; gap:8px; align-items:center;"><i class="fa-solid fa-kitchen-set"></i> Running Orders</div>
            <button id="runningClose" class="icon-btn" title="Close"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <div style="padding:10px 12px; border-bottom:1px solid #f1f5f9; display:flex; gap:8px;">
            <div class="left-search" style="flex:1;">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input id="runningSearch" type="text" placeholder="Search by invoice # or table…" autocomplete="off">
            </div>
            <button id="runningSortTime" class="fs-btn" title="Latest first"><i class="fa-regular fa-clock"></i></button>
        </div>

        <div id="runningList" style="padding:10px 12px; overflow:auto; height:calc(100vh - 130px);"></div>
    </div>
</div>

<!-- Hidden print container -->
<div id="printArea" style="display:none"></div>
<div id="centerFlash"><div class="box"><i class="fa-solid fa-circle-check"></i><span id="centerFlashMsg">Done</span></div></div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@section Scripts {
    <script>
        (function(){
          "use strict";
          /* ========== SERVER DATA ========== */
          const items = @Html.Raw(itemsJson);
          const categories = @Html.Raw(Json.Serialize(ViewBag.CategoriesForJs));
          const basePath = '@Url.Content("~")';

          /* ========== DOM (LEFT) ========== */
          const catGrid=document.getElementById('catGrid');
          const leftItemsTitle=document.getElementById('leftItemsTitle');
          const leftItemsGrid=document.getElementById('leftItemsGrid');
          const sortSel=document.getElementById('sortSel');
          const itemSearchTop=document.getElementById('itemSearchTop');
          const itemSearchBottom=document.getElementById('itemSearchBottom');

          /* ========== DOM (RIGHT) ========== */
          const cartBody=document.getElementById('cartBody');
          const tGrand=document.getElementById('tGrand');
          const tCash=document.getElementById('tCash');
          const tChange=document.getElementById('tChange');
          const tTax=document.getElementById('tTax');
          const tTaxType=document.getElementById('tTaxType');
          const tDisc=document.getElementById('tDisc');
          const tDiscType=document.getElementById('tDiscType');
          const orderNoEl=document.getElementById('orderNo');
          const fsBtn=document.getElementById('fsBtn');
          const posApp=document.getElementById('posApp');
          const newOrderBtn=document.getElementById('newOrderBtn');
          const acSaveOnly=document.getElementById('acSaveOnly');
          const acPrint=document.getElementById('acPrint');
          const acKOT=document.getElementById('acKOT');
          const acHold=document.getElementById('acHold');
          const acRetrieve=document.getElementById('acRetrieve');
          const payMode=document.getElementById('payMode');
          const customer=document.getElementById('customer');
          const waiterSel=document.getElementById('waiterSel');
          const addWaiterBtn=document.getElementById('addWaiterBtn');
          const addCustomerBtn=document.getElementById('addCustomerBtn');
          const orderType=document.getElementById('orderType');
          const tableNo=document.getElementById('tableNo');
          const nowTime=document.getElementById('nowTime');
          const nowDate=document.getElementById('nowDate');
          const runningBtn=document.getElementById('runningBtn');
          const runningDrawer=document.getElementById('runningDrawer');
          const runningClose=document.getElementById('runningClose');
          const runningList=document.getElementById('runningList');
          const runningSearch=document.getElementById('runningSearch');
          const runningSortTime=document.getElementById('runningSortTime');
          const runningCount=document.getElementById('runningCount');
          const centerFlash=document.getElementById('centerFlash');
          const centerFlashMsg=document.getElementById('centerFlashMsg');

          /* ========== UTIL ========== */
          function debounce(fn, ms=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
          function money(n){ return `₨${(n||0).toFixed(2)}`; }
          function flashCenter(msg='Done', ms=900){
            if(centerFlash&&centerFlashMsg){ centerFlashMsg.textContent=msg; centerFlash.style.display='flex'; setTimeout(()=>{centerFlash.style.display='none';}, ms); }
          }
          // UPDATED: ensure top z-index class on container
          function toast(msg, icon='info', ms=1500){
            Swal.fire({
              toast:true,
              icon,
              title: msg,
              position:'top-end',
              showConfirmButton:false,
              timer: ms,
              timerProgressBar:true,
              customClass: { container: 'swal2-top-end' }
            });
          }

          /* ========== CLOCK ========== */
          function tick(){ const n=new Date(); nowTime.textContent=n.toLocaleTimeString(); nowDate.textContent=n.toLocaleDateString(); }
          setInterval(tick,1000); tick();

          /* ========== LEFT: CATEGORIES & ITEMS ========== */
          function renderCats(){
            catGrid.innerHTML = (categories||[]).map(c=>`
              <button class="cat-btn" data-id="${c.id}">
                <img class="cat-thumb" src="${c.imagePath ? basePath + c.imagePath : '/images/default.png'}" alt="${c.name}" width="68" height="68" decoding="async" fetchpriority="high" />
                <div class="cat-meta">
                  <div class="cat-name">${c.name}</div>
                  <div class="cat-count">${(c.items||[]).length||0}</div>
                </div>
              </button>
            `).join('');
          }
          renderCats();

          let currentCat = (categories&&categories[0]) ? categories[0].id : '';
          function applySort(arr){
            const v=sortSel.value;
            if(v==='name') arr.sort((a,b)=> (a.itemName||'').localeCompare(b.itemName||''));
            if(v==='price_asc') arr.sort((a,b)=>(a.salePrice||0)-(b.salePrice||0));
            if(v==='price_desc') arr.sort((a,b)=>(b.salePrice||0)-(a.salePrice||0));
          }
          let searchMode='name';
          function bindChipGroup(root){
            if(!root) return;
            root.addEventListener('click', e=>{
              const btn=e.target.closest('.chip'); if(!btn) return;
              [...root.querySelectorAll('.chip')].forEach(c=>c.classList.toggle('active', c===btn));
              searchMode=btn.dataset.mode; renderLeftItems();
            });
          }
          bindChipGroup(document.getElementById('bottomChips'));

          function renderLeftItems(){
            const q=(itemSearchBottom?.value||'').toLowerCase().trim();
            const cat = (categories||[]).find(c=>c.id===currentCat);
            if(!cat){ leftItemsTitle.textContent='Items'; leftItemsGrid.innerHTML=''; return; }
            leftItemsTitle.textContent=cat.name;
            let list=(cat.items||[]).filter(it=>{
              if(!q) return true;
              const name=(it.itemName||'').toLowerCase(), code=(it.itemCode||'').toLowerCase();
              return (searchMode==='name')? name.includes(q) : code.includes(q);
            });
            applySort(list);
            leftItemsGrid.innerHTML = list.map(it=>`
              <div class="li-card" data-id="${it.id}" title="${(it.itemName||'')}${it.itemCode ? ' • '+it.itemCode : ''}">
                <img class="li-thumb" src="${it.imagePath ? basePath + it.imagePath : '/images/default.png'}" alt="${it.itemName}" width="82" height="82" decoding="async" loading="lazy" />
                <div style="min-width:0">
                  <div class="li-name">${it.itemName}</div>
                  <div class="cat-count">${it.itemCode ? ` <small style="color:#64748b">(${it.itemCode})</small>` : ''}</div>
                  <div class="li-meta">
                    <span class="price-badge"><i class="fa-solid fa-sack-dollar"></i> ${Number(it.salePrice||0).toFixed(0)}</span>
                    <span class="muted">#${it.quantity}</span>
                  </div>
                </div>
              </div>
            `).join('');
          }
          renderLeftItems();

          catGrid.addEventListener('click', e=>{
            const b=e.target.closest('.cat-btn'); if(!b) return;
            currentCat=parseInt(b.dataset.id); renderLeftItems();
          });

          const doSearchTop = debounce(()=>{
            const q=(itemSearchTop?.value||'').trim().toLowerCase();
            if(!q){ return; }
            const match=(categories||[]).find(c=> (c.name||'').toLowerCase().includes(q) || String(c.id)===q || (c.code&&String(c.code).toLowerCase()===q) );
            if(match){ currentCat=match.id; renderLeftItems(); }
          },150);
          itemSearchTop?.addEventListener('input', doSearchTop);

          document.addEventListener('keydown', (e)=>{
            if(e.key==='/' && !/input|textarea/i.test(document.activeElement.tagName)){ e.preventDefault(); itemSearchTop?.focus(); }
          });

          const doSearchBottom = debounce(()=>{ renderLeftItems(); },150);
          itemSearchBottom?.addEventListener('input', doSearchBottom);
          sortSel.addEventListener('change', renderLeftItems);

          /* ========== RIGHT: CART ========== */
          window.cart = Array.isArray(window.cart)? window.cart : [];
          let cart = window.cart; function syncCartRef(){ window.cart = cart; }

          function renderCart(){
            if(!cart.length){
              cartBody.innerHTML = `<div class="muted" style="padding:.6rem;">No items yet. Select from left to add.</div>`;
              return;
            }
            cartBody.innerHTML = cart.map((l,idx)=>`
              <div class="cart-row" data-idx="${idx}" data-item-id="${l.id}" data-code="${l.code||''}">
                <div class="cart-name">${l.name}</div>
                <div class="qty-wrap">
                  <button class="qty-btn" data-op="dec">−</button>
                  <input class="soft-input qty-input" type="number" step="1" min="1" value="${l.qty}">
                  <button class="qty-btn" data-op="inc">+</button>
                </div>
                <input class="price-input" type="number" step="0.01" value="${Number(l.price||0).toFixed(2)}">
                <div class="line-total">${(l.qty*l.price).toFixed(2)}</div>
                <button class="remove-btn" title="Remove line"><i class="fa-regular fa-trash-can"></i></button>
              </div>`).join('');
          }

          function recalc(){
            const sub=cart.reduce((a,b)=>a+(b.qty*b.price),0);
            const d=parseFloat(tDisc.value||'0')||0; const dType=tDiscType.value; const dAmt=(dType==='percent')?(sub*d/100):d;
            const tx=parseFloat(tTax.value||'0')||0; const txType=tTaxType.value; const txBase=Math.max(0, sub - dAmt); const txAmt=(txType==='percent')?(txBase*tx/100):tx;
            const grand=Math.max(0, txBase + txAmt); tGrand.textContent=grand.toFixed(2);
            const cash=parseFloat(tCash.value||'0')||0; tChange.textContent=Math.max(0, cash - grand).toFixed(2);
          }

          leftItemsGrid.addEventListener('click', e=>{
            const card=e.target.closest('.li-card'); if(!card) return;
            const itemId=+card.dataset.id;
            const cat=(categories||[]).find(c=>c.id===currentCat); if(!cat) return;
            const it=(cat.items||[]).find(x=>x.id===itemId); if(!it) return;
            const ex=cart.find(x=>x.id===itemId);
            if(ex) ex.qty += 1; else cart.push({ id:itemId, code:it.itemCode, name:it.itemName, price:Number(it.salePrice||0), qty:1 });
            syncCartRef(); renderCart(); recalc();
          });

          cartBody.addEventListener('click', e=>{
            const row=e.target.closest('.cart-row'); if(!row) return;
            const idx=+row.dataset.idx;
            if(e.target.matches('.remove-btn, .remove-btn *')){ cart.splice(idx,1); syncCartRef(); renderCart(); recalc(); return; }
            if(e.target.matches('.qty-btn')){
              const op=e.target.dataset.op;
              if(op==='inc') cart[idx].qty+=1;
              if(op==='dec') cart[idx].qty=Math.max(1,cart[idx].qty-1);
              syncCartRef(); renderCart(); recalc();
            }
          });

          cartBody.addEventListener('input', e=>{
            const row=e.target.closest('.cart-row'); if(!row) return; const idx=+row.dataset.idx;
            if(e.target.matches('.qty-input')){
              cart[idx].qty=Math.max(1, parseInt(e.target.value||'1',10));
              row.querySelector('.line-total').textContent=(cart[idx].qty*cart[idx].price).toFixed(2);
              syncCartRef(); recalc();
            }
            if(e.target.matches('.price-input')){
              cart[idx].price=Math.max(0, parseFloat(e.target.value||'0'));
              row.querySelector('.line-total').textContent=(cart[idx].qty*cart[idx].price).toFixed(2);
              syncCartRef(); recalc();
            }
          });

          [tDisc,tCash,tTax].forEach(el=> el.addEventListener('input', recalc));
          [tDiscType,tTaxType,payMode].forEach(el=>{ el.addEventListener('input',recalc); el.addEventListener('change',recalc); });

          /* ========== FULLSCREEN ========== */
          fsBtn?.addEventListener('click', async ()=>{
            try{
              if(!document.fullscreenElement){ await posApp.requestFullscreen(); fsBtn.innerHTML='<i class="fa-solid fa-down-left-and-up-right-to-center"></i>'; fsBtn.title='Exit Full Screen'; }
              else{ await document.exitFullscreen(); fsBtn.innerHTML='<i class="fa-solid fa-up-right-and-down-left-from-center"></i>'; fsBtn.title='Full Screen'; }
            }catch{}
          });

          /* ========== NEW ORDER ========== */
          let invoiceCounter = @((invoiceNo ?? 0));
          function generateInvoiceNumber(){ invoiceCounter=(parseInt(invoiceCounter)||0)+1; const counterStr=String(invoiceCounter).padStart(4,'0'); return `${counterStr}`; }
          orderNoEl.innerText = generateInvoiceNumber();

          // NEW: pressed visual state
          if (newOrderBtn){
            newOrderBtn.addEventListener('mousedown', ()=> newOrderBtn.classList.add('is-pressed'));
            newOrderBtn.addEventListener('mouseup',   ()=> newOrderBtn.classList.remove('is-pressed'));
            newOrderBtn.addEventListener('mouseleave',()=> newOrderBtn.classList.remove('is-pressed'));
          }

          newOrderBtn?.addEventListener('click', ()=>{
            cart = []; syncCartRef(); renderCart(); tGrand.textContent='0.00'; tChange.textContent='0.00'; tTax.value='0'; tDisc.value='0'; tCash.value='0';
            itemSearchTop.value=''; itemSearchBottom.value='';
            tableNo.value=''; customer.value=''; waiterSel.value='';
            orderNoEl.innerText = generateInvoiceNumber();
            toast('New order ready','success'); itemSearchTop.focus();
          });

          /* ========== QUICK ADD WAITER/CUSTOMER ========== */
          const WAITERS=['Ali','Bilal','Hamza','Imran','Sara','Waqas'];
          function refreshWaiters(){ waiterSel.innerHTML='<option value="">Select Waiter</option>'+WAITERS.map(w=>`<option value="${w}">${w}</option>`).join(''); }
          refreshWaiters();
          addWaiterBtn?.addEventListener('click',()=>{ const name=prompt('New waiter name?'); if(!name) return; WAITERS.push(name); refreshWaiters(); waiterSel.value=name; });
          addCustomerBtn?.addEventListener('click',()=>{ const name=prompt('Customer name?'); if(!name) return; customer.value=name; });

          /* ========== HOLD / RUNNING ========== */
          const HOLD_KEY='touchHeldInvoices';
          function getAllHeld(){ try{ return JSON.parse(localStorage.getItem(HOLD_KEY)||'[]'); }catch{ return []; } }
          function saveAllHeld(list){ localStorage.setItem(HOLD_KEY, JSON.stringify(list)); updateRunningBadge(); }
          function updateRunningBadge(){ const c=(getAllHeld()||[]).length; if(runningCount) runningCount.textContent=c; }
          function nowIso(){ return new Date().toISOString(); }
          function cryptoRandomId(){ try{ return [...crypto.getRandomValues(new Uint8Array(8))].map(x=>x.toString(16).padStart(2,'0')).join(''); }catch{ return String(Date.now()); } }

          function holdCurrentInvoice(){
            if(!document.querySelector('.cart-row')){ toast('No items to hold','warning'); return; }
            const saleItems = Array.from(document.querySelectorAll('.cart-row')).map(row=>{
              const qty = parseInt(row.querySelector('.qty-input')?.value||0);
              const price = parseFloat(row.querySelector('.price-input')?.value||0);
              return { ItemId: parseInt(row.dataset.itemId), Quantity: qty, UnitPrice: price, LineTotal: +(qty*price).toFixed(2) };
            });
            const invoiceNumber=orderNoEl?.textContent||'';
            const tax=parseFloat(tTax?.value||0); const disc=parseFloat(tDisc?.value||0); const grand=parseFloat(tGrand?.textContent.replace(/,/g,'')||0);
            const held={ id: cryptoRandomId(), invoiceNumber, items:saleItems, grandTotal: grand, discount: disc, tax: tax, heldAt: nowIso(), tableNo: tableNo?.value||'', waiter: waiterSel?.value||'' };
            const list=getAllHeld(); list.unshift(held); saveAllHeld(list);
            toast('Invoice held','success',600); flashCenter('Invoice held',600);
            // next invoice & clear
            cart=[]; syncCartRef(); renderCart(); tGrand.textContent='0.00'; tChange.textContent='0.00'; tTax.value='0'; tDisc.value='0'; tCash.value='0';
            orderNoEl.textContent = generateInvoiceNumber();
            renderRunning();
          }

          function renderRunning(){
            const list=getAllHeld();
            const q=(runningSearch?.value||'').trim().toLowerCase();
            const view=list.filter(r=> !q || (r.invoiceNumber||'').toLowerCase().includes(q) || (r.tableNo||'').toLowerCase().includes(q));
            runningList.innerHTML = view.length ? view.map(r=>{
              const namesAll=(r.items||[]).map(it=> (items.find(x=>x.Id===it.ItemId)?.ItemName) || it.ItemName || (`Item#${it.ItemId}`) );
              const namesShort=namesAll.slice(0,6).map((nm,i)=>`${i+1}. ${nm}`).join(', ');
              const namesTitle=namesAll.map((nm,i)=>`${i+1}. ${nm}`).join(', ');
              return `
                <div class="running-card" data-id="${r.id}" title="${namesTitle}">
                  <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
                    <div style="font-weight:900;">#${r.invoiceNumber}</div>
                    <div class="t-inline" style="gap:6px;">
                      <span class="badge text-bg-light"><i class="fa-regular fa-user"></i> ${r.waiter||'-'}</span>
                      <span class="badge text-bg-light"><i class="fa-solid fa-table"></i> ${r.tableNo||'-'}</span>
                      <span class="badge text-bg-success"><i class="fa-solid fa-pizza-slice"></i> ${r.items?.length||0}</span>
                    </div>
                  </div>
                  <div style="color:#64748b;font-size:.9rem;margin:.35rem 0;"><i class="fa-regular fa-clock"></i> ${new Date(r.heldAt).toLocaleString()}</div>
                  <div class="text-truncate">${namesShort||'—'}</div>
                  <div style="display:flex;gap:8px;margin-top:8px;">
                    <button class="fs-btn" data-action="load" data-id="${r.id}"><i class="fa-solid fa-arrow-turn-down"></i> Load</button>
                    <button class="fs-btn" data-action="delete" data-id="${r.id}"><i class="fa-regular fa-trash-can"></i></button>
                  </div>
                </div>`;
            }).join('') : `<div class="text-muted" style="padding:12px;">No running orders</div>`;
          }

          // Make selectRunning available & stable
          window.selectRunning = function(id){
            const list = getAllHeld();
            const r = list.find(x=>x.id===id);
            if (!r) { toast('Not found','error'); return; }

            cart = (r.items||[]).map(it => ({
              id: it.ItemId,
              code: it.ItemCode || '',
              name: (items.find(x=>x.Id === it.ItemId)?.ItemName) || it.ItemName || 'Item',
              price: Number(it.UnitPrice)||0,
              qty: Number(it.Quantity)||1
            }));
            syncCartRef();
            renderCart();
            recalc();
            if (orderNoEl) orderNoEl.textContent = r.invoiceNumber || orderNoEl.textContent;

            // NOTE: We DO NOT remove from pending here (per your rule). Only delete if user deletes.
            // saveAllHeld(list.filter(x=>x.id!==id));  <-- removed
            renderRunning();
            updateRunningBadge();
            closeRunning();
            toast('Running order loaded','success');
          };

          function deleteRunning(id){
            let list=getAllHeld(); list=list.filter(x=>x.id!==id); saveAllHeld(list);
            renderRunning(); updateRunningBadge(); toast('Removed','success');
          }

          let RUNNING_OPEN=false;
          function openRunning(){ runningDrawer.style.right='0'; RUNNING_OPEN=true; runningBtn?.classList.add('active'); renderRunning(); }
          function closeRunning(){ runningDrawer.style.right='-420px'; RUNNING_OPEN=false; runningBtn?.classList.remove('active'); }
          runningBtn?.addEventListener('click', ()=>{ RUNNING_OPEN? closeRunning(): openRunning(); });
          runningClose?.addEventListener('click', closeRunning);
          document.addEventListener('keydown', e=>{ if(e.key==='Escape'&&RUNNING_OPEN) closeRunning(); });
          runningSearch?.addEventListener('input', renderRunning);
          runningSortTime?.addEventListener('click', ()=>{
            let list=getAllHeld().sort((a,b)=> new Date(b.heldAt)-new Date(a.heldAt));
            saveAllHeld(list); renderRunning();
          });

          // Delegate: load / delete buttons and card click
          runningList?.addEventListener('click', (e)=>{
            const delBtn = e.target.closest('button[data-action="delete"]');
            if (delBtn){ deleteRunning(delBtn.getAttribute('data-id')); return; }
            const loadBtn = e.target.closest('button[data-action="load"]');
            if (loadBtn){ window.selectRunning(loadBtn.getAttribute('data-id')); return; }
            const card = e.target.closest('.running-card');
            if (card){ window.selectRunning(card.getAttribute('data-id')); }
          });

          /* ========== SAVE / PRINT / KOT ========== */
          async function savePOS(mode){
            const wantPrint=(mode==='print');
            const cashStr=(tCash?.value||'').trim(); const cashVal=parseFloat(cashStr);
            if(!cashStr || isNaN(cashVal) || cashVal<=0){ Swal.fire({icon:'warning', title:'Required Field', text:'Please enter cash amount!'}); try{ tCash.focus(); }catch{} return; }
            const grandTotal=parseFloat(tGrand?.textContent.replace(/,/g,'')||0);
            const tax=parseFloat(tTax?.value||0); const discount=parseFloat(tDisc?.value||0); const cash=cashVal;
            const payModeVal=payMode?.value||'cash'; const custId=parseInt(customer?.value||0); const orderTypeVal=orderType?.value||'dinein'; const tableNoVal=tableNo?.value||''; const waiterVal=waiterSel?.value||null; const orderNo=orderNoEl?.textContent||'';
            const saleItems=Array.from(document.querySelectorAll('.cart-row')).map(row=>{
              const qty=parseInt(row.querySelector('.qty-input')?.value||0);
              const price=parseFloat(row.querySelector('.price-input')?.value||0);
              return { ItemId: parseInt(row.dataset.itemId), Quantity: qty, UnitPrice: price, DiscountPercent: discount, TaxAmount: tax, LineTotal: +(qty*price).toFixed(2) };
            });
            if(!saleItems.length){ Swal.fire({icon:'warning', title:'No Items', text:'Please add at least one item to the cart!'}); return; }
            const payload={ InvoiceNumber:orderNo, SubTotal:grandTotal, Tax:tax, Discount:discount, DiscountPercent:discount, DiscountLessAmount:discount, SaleType:'Sale', Total:grandTotal, custId:custId, tender_amount:cash, OrderType:orderTypeVal, TableNo:tableNoVal, Waiter:waiterVal, Payment:{ Amount:cash, PaymentMethod:payModeVal, Change: Math.max(cash-grandTotal,0) }, SaleItems:saleItems };
            try{
              const res=await fetch('/Sales/SaveSale', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
              if(res.ok){
                const result=await res.json();
                if(wantPrint) window.open(`/Sales/Receipt/${result.id}`,'_blank');
                cart=[]; syncCartRef(); renderCart(); tGrand.textContent='0.00'; tChange.textContent='0.00'; tTax.value='0'; tDisc.value='0'; tCash.value='0';
                flashCenter('Invoice cleared successfully',1000);
                setTimeout(()=>{ window.location.reload(); }, 1000);
              }else{
                const error=await res.json().catch(()=>({}));
                toast(error?.Message||'Failed to save order','error',3000);
              }
            }catch(err){ console.error(err); Swal.fire({icon:'error', title:'Error', text:'Something went wrong while saving the order.'}); }
          }

          async function saveKOT(){

            // const payModeVal=payMode?.value||'cash'; const custId=parseInt(customer?.value||0); const orderTypeVal=orderType?.value||'dinein'; const tableNoVal=tableNo?.value||''; const waiterVal=waiterSel?.value||null; const orderNo=orderNoEl?.textContent||'';
            // const saleItems=Array.from(document.querySelectorAll('.cart-row')).map(row=>{
            //   const qty=parseInt(row.querySelector('.qty-input')?.value||0);
            //   const price=parseFloat(row.querySelector('.price-input')?.value||0);
            //   return { ItemId: parseInt(row.dataset.itemId), Quantity: qty, UnitPrice: price, LineTotal: +(qty*price).toFixed(2) };
            // });
            // if(!saleItems.length){ Swal.fire({icon:'warning', title:'No Items', text:'Please add at least one item to the cart!'}); return; }
            // const payload={ InvoiceNumber: orderNoEl?.textContent?.trim()||'', TableNo: tableNo?.value?.trim()||'', Waiter: waiterSel?.value||'', SaleItems: saleItems };
            const cashStr=(tCash?.value||'').trim(); const cashVal=parseFloat(cashStr);
            if(!cashStr || isNaN(cashVal) || cashVal<=0){ Swal.fire({icon:'warning', title:'Required Field', text:'Please enter cash amount!'}); try{ tCash.focus(); }catch{} return; }
            const grandTotal=parseFloat(tGrand?.textContent.replace(/,/g,'')||0);
            const tax=parseFloat(tTax?.value||0); const discount=parseFloat(tDisc?.value||0); const cash=cashVal;
            const payModeVal=payMode?.value||'cash'; const custId=parseInt(customer?.value||0); 
            const orderTypeVal=orderType?.value||'dinein'; const tableNoVal=tableNo?.value||''; 
            const waiterVal=waiterSel?.value||null; const orderNo=orderNoEl?.textContent||'';
            const saleItems=Array.from(document.querySelectorAll('.cart-row')).map(row=>{
              const qty=parseInt(row.querySelector('.qty-input')?.value||0);
              const price=parseFloat(row.querySelector('.price-input')?.value||0);
              return { ItemId: parseInt(row.dataset.itemId), Quantity: qty, UnitPrice: price, DiscountPercent: discount, TaxAmount: tax, LineTotal: +(qty*price).toFixed(2) };
            });
            if(!saleItems.length){ Swal.fire({icon:'warning', title:'No Items', text:'Please add at least one item to the cart!'}); return; }
            const payload={ InvoiceNumber:orderNo, SubTotal:grandTotal, Tax:tax, Discount:discount, DiscountPercent:discount, DiscountLessAmount:discount, SaleType:'Sale', Total:grandTotal, custId:custId, tender_amount:cash, OrderType:orderTypeVal, TableNo:tableNoVal, Waiter:waiterVal, Payment:{ Amount:cash, PaymentMethod:payModeVal, Change: Math.max(cash-grandTotal,0) }, SaleItems:saleItems };
            console.log(payload);

            try{
              const res=await fetch('/Sales/KOTSale', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
              
              if(!res.ok){
                let errText='Failed to send KOT.'; try{ const e=await res.json(); if (e?.Message) errText=e.Message; }catch{}
                Swal.fire({icon:'error', title:'Error', text:errText}); return;
              }
              const result=await res.json();
              window.open(`/Sales/KOTReceipt/${result.id}`,'_blank'); window.location.reload();
            }catch(err){ console.error('KOT error:',err); Swal.fire({icon:'error', title:'Error', text:'Something went wrong while sending KOT.'}); }
          }

          /* ========== BIND ACTIONS ========== */
          acSaveOnly?.addEventListener('click', ()=> savePOS('save'));
          acPrint?.addEventListener('click', ()=> savePOS('print'));
          acKOT?.addEventListener('click', saveKOT);
          acHold?.addEventListener('click', holdCurrentInvoice);
          acRetrieve?.addEventListener('click', ()=>{ openRunning(); });

          // initial render
          renderCart(); recalc(); updateRunningBadge(); renderRunning();

        })(); // IIFE
    </script>
}
