@model GSoftPosNew.ViewModels.SalesFilterViewModel

@{
    ViewData["Title"] = "Sales Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var fromStr = Model.FromDate?.ToString("yyyy-MM-dd");
    var toStr = Model.ToDate?.ToString("yyyy-MM-dd");
}

<style>
    /* ===== Screen polish ===== */
    .page-header {
        background: linear-gradient(90deg, #f5f9ff, #f8fffb);
        border: 1px solid #ecf2ff;
        border-radius: 14px;
        padding: 14px 18px;
    }

        .page-header h2 {
            letter-spacing: .2px;
        }

    .btn-soft {
        border-radius: 10px;
        box-shadow: 0 6px 14px rgba(0,0,0,.04);
    }

    .kpi-badge {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        background: linear-gradient(90deg,#eef7ff,#f5fff2);
        border: 1px solid #e6eef8;
        border-radius: 12px;
        padding: .5rem .75rem;
        font-size: .9rem;
    }

        .kpi-badge .val {
            font-weight: 700;
        }

    .table.compact > :not(caption) > * > * {
        padding: .45rem .55rem;
    }

    .table thead th {
        letter-spacing: .3px;
    }

    /* ===== Default Print (A4) ===== */
    @@media print {
        @@page {
            size: A4;
            margin: 12mm;
        }
        /* NOTE: @@page for Razor escape */
        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            font-size: 12px;
            font-family: Arial, Helvetica, sans-serif;
        }

        .no-print, header, nav, .navbar, .sidebar, .footer, .topbar {
            display: none !important;
        }

        .container-fluid {
            padding: 0 !important;
            margin: 0 !important;
        }

        .card, .page-header {
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
        }

        .table thead th {
            background: #000 !important;
            color: #fff !important;
            -webkit-print-color-adjust: exact;
        }

        a.btn, button.btn {
            display: none !important;
        }

        .print-title {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 6px;
        }

        .print-sub {
            font-size: 12px;
            margin-bottom: 10px;
        }
    }
</style>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3 page-header no-print">
        <div>
            <h2 class="fw-bold mb-1 text-primary">
                <i class="fa fa-chart-line me-2"></i> @ViewData["Title"]
            </h2>
            <div class="text-muted" style="font-size:.85rem">
                <i class="fa fa-info-circle me-1"></i> Filter results ko A4 ya Thermal (80mm) par print karein.
            </div>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="POS" class="btn btn-primary btn-soft px-3">
                <i class="fa fa-plus me-1"></i> New Sale
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-3 border-0 rounded-3 no-print">
        <div class="card-body">
            <form method="get" asp-action="Index" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label"><i class="fa fa-calendar-day me-1 text-primary"></i>From Date</label>
                    <input id="fromDate" type="date" name="fromDate" class="form-control" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label"><i class="fa fa-calendar-day me-1 text-primary"></i>To Date</label>
                    <input id="toDate" type="date" name="toDate" class="form-control" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label"><i class="fa fa-magnifying-glass me-1 text-primary"></i>Search (Invoice / Cashier)</label>
                    <input id="search" type="text" name="search" class="form-control" placeholder="Invoice # or Cashier" value="@Model.Search" />
                </div>
                <div class="col-md-3 text-end">
                    <button type="submit" class="btn btn-success px-4 btn-soft">
                        <i class="fa fa-search me-1"></i> Filter
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary px-3 ms-2 btn-soft" title="Reset">
                        <i class="fa fa-sync"></i>
                    </a>
                </div>

                <!-- Print toolbar -->
                <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                    <button type="button" class="btn btn-dark btn-soft" onclick="printA4()">
                        <i class="fa fa-print me-2"></i> Print (A4)
                    </button>
                    <a asp-action="LastDaySales" asp-controller="Sales" type="button" class="btn btn-outline-dark btn-soft">
                        <i class="fa fa-receipt me-2"></i> Thermal Print (80mm)
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- KPIs -->
    @if (Model?.Sales != null && Model.Sales.Any())
    {
        var grandSubtotal = Model.Sales.Sum(s => s.SubTotal);
        var grandTax = Model.Sales.Sum(s => s.Tax);
        var grandDiscount = Model.Sales.Sum(s => s.Discount);
        var grandTotal = Model.Sales.Sum(s => s.Total);

        <div class="d-flex flex-wrap gap-2 mb-3 no-print">
            <span class="kpi-badge"><i class="fa fa-receipt text-primary"></i> Invoices: <span class="val">@Model.Sales.Count()</span></span>
            <span class="kpi-badge"><i class="fa fa-calculator text-primary"></i> Subtotal: <span class="val">@grandSubtotal.ToString("N2")</span></span>
            <span class="kpi-badge"><i class="fa fa-percent text-primary"></i> Tax: <span class="val">@grandTax.ToString("N2")</span></span>
            <span class="kpi-badge"><i class="fa fa-tag text-danger"></i> Discount: <span class="val">-@grandDiscount.ToString("N2")</span></span>
            <span class="kpi-badge"><i class="fa fa-wallet text-success"></i> Total: <span class="val">@grandTotal.ToString("N2")</span></span>
        </div>
    }

    <!-- Report Table (screen / A4) -->
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0 align-middle compact">
                    <thead class="table-dark text-uppercase small">
                        <tr>
                            <th>#</th>
                            <th>Invoice</th>
                            <th>Date</th>
                            <th>Cashier</th>
                            <th class="text-end">Subtotal</th>
                            <th class="text-end">Tax</th>
                            <th class="text-end">Discount</th>
                            <th class="text-end">Total</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Sales != null && Model.Sales.Any())
                        {
                            var grandSubtotal = 0m;
                            var grandTax = 0m;
                            var grandDiscount = 0m;
                            var grandTotal = 0m;
                            foreach (var sale in Model.Sales)
                            {
                                grandSubtotal += sale.SubTotal;
                                grandTax += sale.Tax;
                                grandDiscount += sale.Discount;
                                grandTotal += sale.Total;

                                <tr>
                                    <td class="fw-semibold text-muted">@sale.Id</td>
                                    <td class="fw-bold"><i class="fa fa-hashtag text-muted me-1"></i>@sale.InvoiceNumber</td>
                                    <td><i class="fa fa-clock me-1 text-muted"></i>@sale.SaleDate.ToString("g")</td>
                                    <td><i class="fa fa-user-gear me-1 text-muted"></i>@sale.CashierId</td>
                                    <td class="text-end">@sale.SubTotal.ToString("N2")</td>
                                    <td class="text-end">@sale.Tax.ToString("N2")</td>
                                    <td class="text-end text-danger">-@sale.Discount.ToString("N2")</td>
                                    <td class="text-end fw-bold text-success">@sale.Total.ToString("N2")</td>
                                    <td class="text-center">
                                        <a asp-action="Receipt" asp-route-id="@sale.Id" class="btn btn-sm btn-outline-secondary me-1" title="View Receipt">
                                            <i class="fa fa-file-invoice"></i>
                                        </a>
                                        <a asp-action="Edit" asp-route-id="@sale.Id" class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <button onclick="deleteSale(@sale.Id)"
                                                class="btn btn-sm btn-outline-danger">
  
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }

                            <!-- Totals Row -->
                            <tr class="table-light fw-bold">
                                <td colspan="4" class="text-end">Totals:</td>
                                <td class="text-end">@grandSubtotal.ToString("N2")</td>
                                <td class="text-end">@grandTax.ToString("N2")</td>
                                <td class="text-end text-danger">-@grandDiscount.ToString("N2")</td>
                                <td class="text-end text-success">@grandTotal.ToString("N2")</td>
                                <td></td>
                            </tr>
                        }
                        else
                        {
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fa fa-info-circle me-1"></i> No sales records found.
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ===== Hidden PRINT TEMPLATES (root level, no nesting) ===== -->
    <!-- A4 PRINT TEMPLATE -->
    <div id="a4Area" class="d-none">
        <div style="text-align:center;margin-bottom:8px;">
            <div style="font-size:18px;font-weight:700;">Sales Report</div>
            <div style="font-size:12px;">
                Range: @((Model.FromDate?.ToString("yyyy-MM-dd") ?? "--")) → @((Model.ToDate?.ToString("yyyy-MM-dd") ?? "--"))
                <br />Printed: @DateTime.Now.ToString("yyyy-MM-dd HH:mm")
            </div>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead>
                <tr>
                    <th style="padding:6px;border:1px solid #333;text-align:left;">Invoice</th>
                    <th style="padding:6px;border:1px solid #333;text-align:left;">Date</th>
                    <th style="padding:6px;border:1px solid #333;text-align:left;">Cashier</th>
                    <th style="padding:6px;border:1px solid #333;text-align:right;">Subtotal</th>
                    <th style="padding:6px;border:1px solid #333;text-align:right;">Tax</th>
                    <th style="padding:6px;border:1px solid #333;text-align:right;">Discount</th>
                    <th style="padding:6px;border:1px solid #333;text-align:right;">Total</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Sales != null && Model.Sales.Any())
                {
                    decimal tSub = 0, tTax = 0, tDis = 0, tTot = 0;
                    foreach (var s in Model.Sales)
                    {
                        tSub += s.SubTotal; tTax += s.Tax; tDis += s.Discount; tTot += s.Total;
                        <tr>
                            <td style="padding:6px;border:1px solid #ddd;">@s.InvoiceNumber</td>
                            <td style="padding:6px;border:1px solid #ddd;">@s.SaleDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td style="padding:6px;border:1px solid #ddd;">@s.CashierId</td>
                            <td style="padding:6px;border:1px solid #ddd;text-align:right;">@s.SubTotal.ToString("N2")</td>
                            <td style="padding:6px;border:1px solid #ddd;text-align:right;">@s.Tax.ToString("N2")</td>
                            <td style="padding:6px;border:1px solid #ddd;text-align:right;">-@s.Discount.ToString("N2")</td>
                            <td style="padding:6px;border:1px solid #ddd;text-align:right;"><strong>@s.Total.ToString("N2")</strong></td>
                        </tr>
                    }
                    <tr>
                        <td colspan="4" style="padding:8px;border-top:2px solid #333;text-align:right;"><strong>Totals</strong></td>
                        <td style="padding:8px;border-top:2px solid #333;text-align:right;"><strong>@tSub.ToString("N2")</strong></td>
                        <td style="padding:8px;border-top:2px solid #333;text-align:right;"><strong>@tTax.ToString("N2")</strong></td>
                        <td style="padding:8px;border-top:2px solid #333;text-align:right;"><strong>-@tDis.ToString("N2")</strong></td>
                        <td style="padding:8px;border-top:2px solid #333;text-align:right;"><strong>@tTot.ToString("N2")</strong></td>
                    </tr>
                }
                else
                {
                    <tr><td colspan="8" style="text-align:center;padding:10px;">No sales records</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    @@media print {

        /* Hide everything by default */
        body * {
            visibility: hidden !important;
        }

        /* Show only the print area */
        #a4Area, #a4Area * {
            visibility: visible !important;
        }

        /* Position the print area at top left */
        #a4Area {
            display: block !important;
            position: absolute;
            left: 0;
            top: 0;
            width: 100% !important;
            margin: 0;
            padding: 0;
        }

        @@page {
            size: A4 portrait;
            margin: 8mm;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    function deleteSale(saleId) {
        Swal.fire({
            title: "Are you sure?",
            text: "This will permanently delete the sale.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!",
            cancelButtonText: "Cancel"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/Sales/Delete/${saleId}`, {
                    method: "POST"
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: "Deleted!",
                            text: data.message,
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1500, // 🕒 Auto close after 1.5 seconds
                            timerProgressBar: true
                        });

                        // Auto reload after alert closes
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        Swal.fire({
                            title: "Access Denied",
                            text: data.message,
                            icon: "error",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                })
                .catch(() => {
                    Swal.fire({
                        title: "Error",
                        text: "Something went wrong!",
                        icon: "error",
                        showConfirmButton: false,
                        timer: 2000
                    });
                });
            }
        });
    }
</script>

@section Scripts {
    <script>
        function printA4() {
            window.print();
        }
    </script>

}
