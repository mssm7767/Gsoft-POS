@using System
@using System.Linq
@using System.Collections.Generic
@using System.Collections
@using GSoftPosNew.Models
@model GSoftPosNew.ViewModels.SalesFilterViewModel

@{
    ViewData["Title"] = "Sales Report";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var fromStr = Model.FromDate?.ToString("yyyy-MM-dd");
    var toStr = Model.ToDate?.ToString("yyyy-MM-dd");
    var purchase = ViewBag.Purchase as List<Purchase>;

    int itemsCount = 0;
    decimal purchaseTotal = 0m;
    decimal grandItemTotalQty = 0m;
    decimal grandProfit = 0m;

    decimal grandSaleSubtotal = 0m;
    decimal grandReturnSubtotal = 0m;
    decimal grandSubtotal = 0m;
    decimal grandTax = 0m;
    decimal grandDiscount = 0m;
    decimal grandSaleTotal = 0m;
    decimal grandReturnTotal = 0m;
    decimal grandTotal = 0m;
    decimal runningSubtotal = 0m;
    decimal runningTax = 0m;
    decimal runningDiscount = 0m;
    decimal runningTotal = 0m;

    var itemsList = new ArrayList();

    if (Model?.Sales != null && Model.Sales.Any())
    {
        var allSaleItemsQty = Model.Sales
            .SelectMany(s => s.SaleItems.Select(i => new
            {
                s.SaleType,
                ItemId = i.ItemId,
                Category = i.Item?.Category?.Name ?? "N/A",
                ItemCode = i.Item?.ItemCode ?? "N/A",
                ItemName = i.Item?.ItemName ?? "Unknown",
                Quantity = s.SaleType == "Return" ? -i.Quantity : i.Quantity,
                UnitPrice = i.UnitPrice,
                Discount = i.DiscountPercent,
                CostPrice =
                    int.TryParse(i.Item?.PackSize, out var ps) && ps > 0
                        ? i.Item.PurchasePrice / ps
                        : i.Item.PurchasePrice,

            }))
            .ToList();

        var groupedItemsData = allSaleItemsQty
            .GroupBy(x => x.ItemCode)
            .Select(g => new
            {
                ItemId = g.First().ItemId,
                ItemCode = g.Key,
                Category = g.First().Category,
                ItemName = g.First().ItemName,
                Quantity = g.Sum(x => x.Quantity),
                Discount = g.Sum(x => (x.Quantity * x.UnitPrice) * x.Discount / 100m),
                UnitPrice = g.First().UnitPrice,
                Total = g.Sum(x => (x.Quantity * x.UnitPrice) - ((x.Quantity * x.UnitPrice) * x.Discount / 100m)),
                CostPrice = g.First().CostPrice * g.Sum(x => x.Quantity),
                PurchaseTotal = purchase?
                    .Where(p => p.Items?.Any(pi => pi.ItemId == g.First().ItemId) == true)
                    .SelectMany(p => p.Items?.Where(pi => pi.ItemId == g.First().ItemId) ?? new List<PurchaseItem>())
                    .Sum(pi => pi.LineTotal) ?? 0
            })
            .OrderBy(x => x.ItemName)
            .ToList();

        itemsCount = groupedItemsData.Count;
        purchaseTotal = groupedItemsData.Sum(p => p.PurchaseTotal);
        grandItemTotalQty = allSaleItemsQty.Sum(i => (i.Quantity * i.UnitPrice) - i.Discount);
        grandProfit = grandItemTotalQty - purchaseTotal;

        foreach (var item in groupedItemsData) { itemsList.Add(item); }

        grandSaleSubtotal = Model.Sales.Where(s => s.SaleType == "Sale").Sum(s => s.SubTotal);
        grandReturnSubtotal = Model.Sales.Where(s => s.SaleType == "Return").Sum(s => s.SubTotal);

        grandSubtotal = grandSaleSubtotal - grandReturnSubtotal;
        grandTax = Model.Sales.Sum(s => s.Tax);
        grandDiscount = Model.Sales.Sum(s => s.Discount);

        grandSaleTotal = Model.Sales.Where(s => s.SaleType == "Sale").Sum(s => s.Total);
        grandReturnTotal = Model.Sales.Where(s => s.SaleType == "Return").Sum(s => s.Total);

        grandTotal = grandSaleTotal - grandReturnTotal;

        foreach (var sale in Model.Sales)
        {
            if (sale.SaleType == "Return")
            {
                runningSubtotal -= sale.SubTotal;
                runningTax -= sale.Tax;
                runningDiscount -= sale.Discount;
                runningTotal -= sale.Total;
            }
            else
            {
                runningSubtotal += sale.SubTotal;
                runningTax += sale.Tax;
                runningDiscount += sale.Discount;
                runningTotal += sale.Total;
            }
        }
    }
}

<!-- Icons (agar layout me nahi hain to yahan se load ho jayenge) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
    :root {
        --primary: #3b82f6;
        --primary-dark: #1d4ed8;
        --primary-light: #dbeafe;
        --secondary: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --info: #0ea5e9;
        --dark: #1f2937;
        --light: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-600: #64748b;
        --gray-800: #334155;
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
        --shadow-sm: 0 2px 12px rgba(0,0,0,0.06);
        --shadow-md: 0 6px 24px rgba(0,0,0,0.1);
        --shadow-lg: 0 12px 48px rgba(0,0,0,0.15);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        min-height: 100vh;
        color: var(--dark);
    }

    .sales-dashboard {
        max-width: 1800px;
        margin: 0 auto;
        padding: 20px;
        animation: fadeIn 0.5s ease-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dashboard-header {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: var(--radius-xl);
        padding: 20px 30px;
        margin-bottom: 25px;
        color: white;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
    }

        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -60px;
            right: -60px;
            width: 200px;
            height: 200px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .dashboard-header::after {
            content: '';
            position: absolute;
            bottom: -40px;
            left: -40px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

    .header-content {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .header-icon {
        width: 60px;
        height: 60px;
        background: rgba(255,255,255,0.15);
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.25);
    }

        .header-icon i {
            font-size: 28px;
            color: white;
        }

    .header-text {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .header-title {
        font-size: 24px;
        font-weight: 800;
        margin: 0;
        letter-spacing: -0.5px;
        background: linear-gradient(90deg, #fff 0%, #e0e7ff 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .header-subtitle {
        font-size: 14px;
        opacity: 0.9;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .header-right {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-end;
    }

    .header-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 15px;
        background: rgba(255,255,255,0.1);
        border-radius: var(--radius-md);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        font-size: 13px;
        width: fit-content;
    }

    /* ✅ Header top CTA */
    .header-cta {
        border: 1px solid rgba(255,255,255,.25);
        background: linear-gradient(135deg, rgba(16,185,129,.95) 0%, rgba(13,156,109,.95) 100%);
        color: #fff;
        box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }

        .header-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 30px rgba(0,0,0,.22);
        }

    .filter-section {
        background: white;
        border-radius: var(--radius-xl);
        padding: 20px 25px;
        margin-bottom: 25px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        animation: slideUp 0.6s ease-out 0.2s both;
    }

    @@keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--dark);
        padding-bottom: 15px;
        border-bottom: 2px solid var(--gray-100);
    }

        .section-title i {
            color: var(--primary);
            font-size: 20px;
        }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .filter-label {
        font-size: 12px;
        font-weight: 700;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .filter-label i {
            font-size: 14px;
            color: var(--primary);
        }

    .filter-input {
        padding: 10px 14px;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 14px;
        transition: var(--transition);
        background: white;
    }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

    .filter-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid var(--gray-200);
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        text-decoration: none;
        white-space: nowrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

    .btn-secondary {
        background: white;
        color: var(--dark);
        border: 2px solid var(--gray-300);
    }

        .btn-secondary:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
            transform: translateY(-2px);
        }

    .btn-dark {
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(31, 41, 55, 0.3);
    }

        .btn-dark:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(31, 41, 55, 0.4);
        }

    .btn-light {
        background: white;
        color: var(--dark);
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }

        .btn-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

    .kpi-section {
        margin-bottom: 25px;
        animation: slideUp 0.6s ease-out 0.4s both;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
    }

    .kpi-card {
        background: white;
        border-radius: var(--radius-lg);
        padding: 20px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .kpi-card:nth-child(1)::before {
            background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
        }

        .kpi-card:nth-child(2)::before {
            background: linear-gradient(180deg, #10b981 0%, #34d399 100%);
        }

        .kpi-card:nth-child(3)::before {
            background: linear-gradient(180deg, #ef4444 0%, #f87171 100%);
        }

        .kpi-card:nth-child(4)::before {
            background: linear-gradient(180deg, #f59e0b 0%, #fbbf24 100%);
        }

        .kpi-card:nth-child(5)::before {
            background: linear-gradient(180deg, #0ea5e9 0%, #38bdf8 100%);
        }

    .kpi-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .kpi-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .kpi-label {
        font-size: 12px;
        color: var(--gray-600);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    .kpi-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--dark);
        line-height: 1;
    }

    .kpi-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .kpi-card:nth-child(1) .kpi-icon {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: var(--primary);
    }

    .kpi-card:nth-child(2) .kpi-icon {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: var(--success);
    }

    .kpi-card:nth-child(3) .kpi-icon {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: var(--danger);
    }

    .kpi-card:nth-child(4) .kpi-icon {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: var(--warning);
    }

    .kpi-card:nth-child(5) .kpi-icon {
        background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        color: var(--info);
    }

    .table-section {
        margin-bottom: 30px;
        animation: slideUp 0.6s ease-out 0.8s both;
    }

    .table-container {
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        overflow: hidden;
    }

    .table-header {
        padding: 18px 24px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .table-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .table-title i {
            color: var(--primary);
        }

    .table-stats {
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: var(--gray-600);
    }

        .table-stats span {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            font-weight: 600;
        }

    .table-wrapper {
        overflow-x: auto;
        padding: 15px;
    }

    .data-table, .items-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px;
    }

    .items-table {
        min-width: 1400px;
    }

        .data-table thead, .items-table thead {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-bottom: 2px solid var(--gray-300);
        }

        .data-table th, .items-table th {
            padding: 14px 18px;
            text-align: left;
            font-weight: 700;
            color: var(--gray-800);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .data-table tbody tr, .items-table tbody tr {
            border-bottom: 1px solid var(--gray-200);
            transition: var(--transition);
        }

            .data-table tbody tr:hover {
                background: linear-gradient(90deg, rgba(59, 130, 246, 0.04) 0%, rgba(59, 130, 246, 0.02) 100%);
                transform: translateX(5px);
            }

            .items-table tbody tr:hover {
                background: linear-gradient(90deg, rgba(59, 130, 246, 0.04) 0%, rgba(59, 130, 246, 0.02) 100%);
            }

        .data-table td, .items-table td {
            padding: 14px 18px;
            font-size: 13px;
            color: var(--dark);
            vertical-align: middle;
        }

    .invoice-badge {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
        color: var(--primary);
        padding: 6px 12px;
        border-radius: var(--radius-md);
        font-weight: 700;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .cashier-chip {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
        color: var(--secondary);
        padding: 6px 12px;
        border-radius: var(--radius-md);
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .sale-type-badge {
        padding: 6px 12px;
        border-radius: var(--radius-md);
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.8px;
    }

    .sale-type-sale {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .sale-type-return {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: white;
        transition: var(--transition);
        cursor: pointer;
        text-decoration: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

    .action-btn-view {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
        color: var(--primary);
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .action-btn-edit {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
        color: var(--warning);
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .action-btn-delete {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .category-filter {
        display: none;
        margin-bottom: 15px;
        padding: 15px;
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
    }

        .category-filter.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

    .empty-state {
        padding: 60px 20px;
        text-align: center;
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
    }

    .empty-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        font-size: 36px;
        color: var(--gray-600);
        box-shadow: var(--shadow-md);
    }

    .empty-title {
        font-size: 22px;
        font-weight: 700;
        color: var(--gray-800);
        margin-bottom: 12px;
    }

    .empty-subtitle {
        font-size: 16px;
        color: var(--gray-600);
        max-width: 500px;
        margin: 0 auto 24px;
        line-height: 1.5;
    }

    .profit-positive {
        color: #10b981;
    }

    .profit-negative {
        color: #ef4444;
    }

    @@media (max-width: 1200px) {
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .header-content {
            flex-direction: column;
            gap: 15px;
        }

        .header-right {
            width: 100%;
            align-items: flex-start;
        }
    }

    @@media (max-width: 768px) {
        .sales-dashboard {
            padding: 15px;
        }

        .dashboard-header {
            padding: 15px;
        }

        .header-left {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .header-icon {
            width: 50px;
            height: 50px;
        }

            .header-icon i {
                font-size: 24px;
            }

        .header-title {
            font-size: 20px;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .filter-actions {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .table-header {
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }

        .table-stats {
            flex-wrap: wrap;
        }

        .header-right {
            align-items: flex-start;
        }
    }

    @@media print {
        .no-print {
            display: none !important;
        }

        .sales-dashboard {
            padding: 0;
        }

        .dashboard-header, .filter-section, .kpi-section {
            display: none !important;
        }

        .table-container {
            box-shadow: none !important;
            border: 1px solid #000 !important;
        }

        .data-table th, .items-table th {
            background: #000 !important;
            color: #fff !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }
</style>

<div class="sales-dashboard">

    <!-- ✅ Anti-forgery token (for AJAX delete) -->
    <form id="antiForgeryForm" class="d-none">
        @Html.AntiForgeryToken()
    </form>

    <!-- HEADER -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="header-text">
                    <h1 class="header-title">Sales Analytics Dashboard</h1>
                    <div class="header-subtitle">
                        <i class="fas fa-chart-bar"></i>
                        Real-time sales performance and detailed analytics
                    </div>
                </div>
            </div>

            <div class="header-right">
                <!-- ✅ New Sale button header me (System Administrator ke sath) -->
                <a asp-action="POS" class="btn header-cta no-print">
                    <i class="fas fa-plus-circle me-2"></i> New Sale
                </a>

                <div class="header-badge">
                    <i class="fas fa-calendar-alt"></i>
                    <span>@Model.FromDate?.ToString("dd MMM yyyy") - @Model.ToDate?.ToString("dd MMM yyyy")</span>
                </div>

                <div class="header-badge">
                    <i class="fas fa-user-circle"></i>
                    <span>@(ViewBag.CurrentUser ?? "System Administrator")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTER -->
    <div class="filter-section">
        <div class="section-title">
            <i class="fas fa-sliders-h"></i>
            Filter & Search Options
        </div>

        <form method="get" asp-action="Index" class="filter-form no-print">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label"><i class="fas fa-calendar-day"></i> Start Date</label>
                    <input id="fromDate" type="date" name="fromDate" class="filter-input"
                           value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
                </div>

                <div class="filter-group">
                    <label class="filter-label"><i class="fas fa-calendar-check"></i> End Date</label>
                    <input id="toDate" type="date" name="toDate" class="filter-input"
                           value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
                </div>

                <div class="filter-group">
                    <label class="filter-label"><i class="fas fa-search"></i> Search Invoice / Cashier</label>
                    <input id="search" type="text" name="search" class="filter-input"
                           placeholder="Invoice # or Cashier" value="@Model.Search" />
                </div>

                <div class="filter-group">
                    <label class="filter-label"><i class="fas fa-users"></i> Select Customer</label>
                    <select id="customerInput" name="customerId" class="filter-input" asp-for="CustomerId">
                        <option value="">-- All Customers --</option>
                        @foreach (var cus in ViewBag.Customers)
                        {
                            <option value="@cus.Id">@cus.CustomerName</option>
                        }
                    </select>
                </div>
            </div>

            <div class="filter-actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Apply Filters
                </button>

                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-redo me-2"></i>Reset Filters
                </a>

                <button type="button" id="showInvoicesBtn" class="btn btn-primary" onclick="showInvoicesTable()">
                    <i class="fas fa-table me-2"></i>Invoices
                </button>

                <button type="button" id="showItemsBtn" class="btn btn-secondary" onclick="showItemsTable()">
                    <i class="fas fa-boxes me-2"></i>Items
                </button>

                <button type="button" class="btn btn-dark" onclick="printA4()">
                    <i class="fas fa-print me-2"></i>Print A4
                </button>

                <a asp-action="LastDaySales" asp-controller="Sales" class="btn btn-light">
                    <i class="fas fa-receipt me-2"></i>Thermal
                </a>
            </div>
        </form>
    </div>

    @if (Model?.Sales != null && Model.Sales.Any())
    {
        <!-- KPI -->
        <div class="kpi-section">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-info">
                            <div class="kpi-label"><i class="fas fa-file-invoice-dollar"></i> Total Invoices</div>
                            <div class="kpi-value">@Model.Sales.Count()</div>
                        </div>
                        <div class="kpi-icon"><i class="fas fa-receipt"></i></div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-info">
                            <div class="kpi-label"><i class="fas fa-calculator"></i> Gross Amount</div>
                            <div class="kpi-value">@grandSubtotal.ToString("N2")</div>
                        </div>
                        <div class="kpi-icon"><i class="fas fa-layer-group"></i></div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-info">
                            <div class="kpi-label"><i class="fas fa-percentage"></i> Total Tax</div>
                            <div class="kpi-value">@grandTax.ToString("N2")</div>
                        </div>
                        <div class="kpi-icon"><i class="fas fa-file-invoice"></i></div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-info">
                            <div class="kpi-label"><i class="fas fa-tag"></i> Total Discount</div>
                            <div class="kpi-value">@grandDiscount.ToString("N2")</div>
                        </div>
                        <div class="kpi-icon"><i class="fas fa-percent"></i></div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-content">
                        <div class="kpi-info">
                            <div class="kpi-label"><i class="fas fa-wallet"></i> Net Total</div>
                            <div class="kpi-value">@grandTotal.ToString("N2")</div>
                        </div>
                        <div class="kpi-icon"><i class="fas fa-money-bill-wave"></i></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CATEGORY FILTER (Items view only) -->
        <div class="category-filter no-print" id="categoryFilter">
            <div class="filter-group">
                <label class="filter-label"><i class="fas fa-filter"></i> Filter by Category</label>
                <select id="categoryInput" class="filter-input">
                    <option value="">-- All Categories --</option>
                    @if (ViewBag.Categories != null)
                    {
                        foreach (var cat in ViewBag.Categories)
                        {
                            <option value="@cat.Name">@cat.Name</option>
                        }
                    }
                </select>
            </div>
        </div>

        <!-- INVOICES TABLE -->
        <div class="table-section" id="invoicesTable">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title"><i class="fas fa-table"></i> Sales Transactions</div>
                    <div class="table-stats">
                        <span><i class="fas fa-file-alt"></i> @Model.Sales.Count() Records</span>
                        <span><i class="fas fa-chart-bar"></i> Total: @grandTotal.ToString("N2")</span>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Type</th>
                                <th><i class="fas fa-hashtag"></i> Invoice</th>
                                <th><i class="fas fa-calendar"></i> Date & Time</th>
                                <th><i class="fas fa-user-tie"></i> Cashier</th>
                                <th class="text-end"><i class="fas fa-layer-group"></i> Subtotal</th>
                                <th class="text-end"><i class="fas fa-percent"></i> Tax</th>
                                <th class="text-end"><i class="fas fa-tag"></i> Discount</th>
                                <th class="text-end"><i class="fas fa-wallet"></i> Total</th>
                                <th class="text-center"><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var index = 1;
                                foreach (var sale in Model.Sales)
                                {
                                    <tr>
                                        <td class="fw-semibold text-muted">@index</td>
                                        <td>
                                            <span class="sale-type-badge sale-type-@sale.SaleType.ToLower()">@sale.SaleType</span>
                                        </td>
                                        <td>
                                            <span class="invoice-badge">
                                                <i class="fas fa-file-invoice"></i>
                                                @sale.InvoiceNumber
                                            </span>
                                        </td>
                                        <td>
                                            <i class="far fa-clock me-1 text-muted"></i>
                                            @sale.SaleDate.ToString("dd MMM • HH:mm")
                                        </td>
                                        <td>
                                            <span class="cashier-chip">
                                                <i class="fas fa-user-circle"></i>
                                                @sale.CashierId
                                            </span>
                                        </td>
                                        <td class="text-end @(sale.SaleType == "Return" ? "text-danger" : "")">
                                            @(sale.SaleType == "Return" ? "-" : "")@sale.SubTotal.ToString("N2")
                                        </td>
                                        <td class="text-end">@sale.Tax.ToString("N2")</td>
                                        <td class="text-end text-danger">-@sale.Discount.ToString("N2")</td>
                                        <td class="text-end fw-bold @(sale.SaleType == "Return" ? "text-danger" : "text-success")">
                                            @(sale.SaleType == "Return" ? "-" : "")@sale.Total.ToString("N2")
                                        </td>
                                        <td class="text-center">
                                            <div class="action-buttons">
                                                <a asp-action="Receipt" asp-route-id="@sale.Id"
                                                   class="action-btn action-btn-view" title="View Receipt">
                                                    <i class="fas fa-eye"></i>
                                                </a>

                                                <a asp-action="Edit" asp-route-id="@sale.Id"
                                                   class="action-btn action-btn-edit" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>

                                                <!-- ✅ FIX: type="button" so form submit na ho -->
                                                <button type="button" onclick="deleteSale(@sale.Id)"
                                                        class="action-btn action-btn-delete" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    index++;
                                }
                            }
                        </tbody>
                        <tfoot>
                            <tr style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                                <td colspan="5" class="text-end fw-bold">Grand Totals:</td>
                                <td class="text-end fw-bold">@runningSubtotal.ToString("N2")</td>
                                <td class="text-end fw-bold">@runningTax.ToString("N2")</td>
                                <td class="text-end fw-bold text-danger">-@runningDiscount.ToString("N2")</td>
                                <td class="text-end fw-bold text-success">@runningTotal.ToString("N2")</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- ITEMS TABLE -->
        <div class="table-section" id="itemsTable" style="display:none;">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title"><i class="fas fa-boxes"></i> Items Summary Analysis</div>
                    <div class="table-stats">
                        <span><i class="fas fa-cube"></i> @itemsCount Items</span>
                        <span><i class="fas fa-chart-pie"></i> Profit/Loss Analysis</span>
                    </div>
                </div>

                <div class="table-wrapper">
                    @if (itemsList.Count > 0)
                    {
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item Code</th>
                                    <th>Category</th>
                                    <th>Item Name</th>
                                    <th class="text-end">Quantity</th>
                                    <th class="text-end">Unit Price</th>
                                    <th class="text-end">Discount</th>
                                    <th class="text-end">Sale Total</th>
                                    <th class="text-end">Cost</th>
                                    <th class="text-end">Profit/Loss</th>
                                </tr>
                            </thead>
                            <tbody id="itemsTableBody">
                                @for (int i = 0; i < itemsList.Count; i++)
                                {
                                    dynamic item = itemsList[i];
                                    decimal profit = (decimal)item.Total - (decimal)item.CostPrice;

                                    <tr data-category="@((string)item.Category?.ToLower() ?? "")">
                                        <td>@(i + 1)</td>
                                        <td>@item.ItemCode</td>
                                        <td>@item.Category</td>
                                        <td>@item.ItemName</td>
                                        <td class="text-end fw-bold">@(((decimal)item.Quantity).ToString("N2"))</td>
                                        <td class="text-end">@(((decimal)item.UnitPrice).ToString("N2"))</td>
                                        <td class="text-end text-danger">-@(((decimal)item.Discount).ToString("N2"))</td>
                                        <td class="text-end fw-bold">@(((decimal)item.Total).ToString("N2"))</td>
                                        <td class="text-end text-danger">-@(((decimal)item.CostPrice).ToString("N2"))</td>
                                        <td class="text-end fw-bold @(profit < 0 ? "profit-negative" : "profit-positive")">
                                            @profit.ToString("N2")
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);">
                                    <td colspan="4" class="text-end fw-bold">Grand Totals:</td>
                                    <td class="text-end fw-bold" id="ftQty">
                                        @{
                                            decimal totalQtySum = 0m;
                                            foreach (dynamic it in itemsList)
                                            {
                                                totalQtySum += (decimal)it.Quantity;
                                            }
                                        }
                                        @totalQtySum.ToString("N2")
                                    </td>
                                    <td class="text-end">-</td>
                                    <td class="text-end fw-bold text-danger" id="ftDiscount">
                                        @{
                                            decimal totalDiscountSum = 0m;
                                            foreach (dynamic it in itemsList)
                                            {
                                                totalDiscountSum += (decimal)it.Discount;
                                            }
                                        }
                                        -@totalDiscountSum.ToString("N2")
                                    </td>
                                    <td class="text-end fw-bold text-success" id="ftTotal">@grandItemTotalQty.ToString("N2")</td>
                                    <td class="text-end fw-bold" id="ftPurchase">@purchaseTotal.ToString("N2")</td>
                                    <td class="text-end fw-bold @(grandProfit < 0 ? "profit-negative" : "profit-positive")" id="ftProfit">
                                        @grandProfit.ToString("N2")
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    }
                    else
                    {
                        <div class="empty-state" style="padding: 40px 20px; margin: 20px;">
                            <div class="empty-icon" style="width: 80px; height: 80px; font-size: 40px;">
                                <i class="fas fa-box"></i>
                            </div>
                            <h3 class="empty-title" style="font-size: 20px;">No Items Data Available</h3>
                            <p class="empty-subtitle" style="font-size: 14px;">
                                No items found for the selected filter criteria.
                            </p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-chart-line"></i></div>
            <h3 class="empty-title">No Sales Data Available</h3>
            <p class="empty-subtitle">Try adjusting your date filters or check back later for new sales transactions.</p>
            <div class="mt-4 no-print">
                <a asp-action="Index" class="btn btn-primary">
                    <i class="fas fa-redo"></i> Reset Filters
                </a>
                <a asp-action="POS" class="btn header-cta ms-3">
                    <i class="fas fa-plus-circle"></i> Create New Sale
                </a>
            </div>
        </div>
    }
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let isItemsView = false;

    document.addEventListener('DOMContentLoaded', function () {
        const fromDate = document.getElementById('fromDate');
        const toDate = document.getElementById('toDate');

        if (fromDate && !fromDate.value) {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            fromDate.valueAsDate = firstDay;
        }
        if (toDate && !toDate.value) {
            toDate.valueAsDate = new Date();
        }

        showInvoicesTable();
    });

    function showInvoicesTable() {
        document.getElementById('invoicesTable').style.display = 'block';
        document.getElementById('itemsTable').style.display = 'none';
        document.getElementById('categoryFilter').classList.remove('active');

        document.getElementById('showInvoicesBtn').classList.add('btn-primary');
        document.getElementById('showInvoicesBtn').classList.remove('btn-secondary');

        document.getElementById('showItemsBtn').classList.add('btn-secondary');
        document.getElementById('showItemsBtn').classList.remove('btn-primary');

        isItemsView = false;
    }

    function showItemsTable() {
        document.getElementById('invoicesTable').style.display = 'none';
        document.getElementById('itemsTable').style.display = 'block';
        document.getElementById('categoryFilter').classList.add('active');

        document.getElementById('showItemsBtn').classList.add('btn-primary');
        document.getElementById('showItemsBtn').classList.remove('btn-secondary');

        document.getElementById('showInvoicesBtn').classList.add('btn-secondary');
        document.getElementById('showInvoicesBtn').classList.remove('btn-primary');

        isItemsView = true;
        initializeCategoryFilter();
    }

    function recalculateFooterTotals() {
        let qty = 0, discount = 0, total = 0, purchase = 0, profit = 0;

        const rows = document.querySelectorAll('#itemsTableBody tr');

        rows.forEach(row => {
            if (row.style.display === 'none') return;

            const cells = row.querySelectorAll('td');

            qty      += parseFloat(cells[4].innerText.replace(/,/g, '')) || 0;
            discount += Math.abs(parseFloat(cells[6].innerText.replace(/,/g, ''))) || 0;
            total    += parseFloat(cells[7].innerText.replace(/,/g, '')) || 0;
            purchase += parseFloat(cells[8].innerText.replace(/,/g, '')) || 0;
            profit   += parseFloat(cells[9].innerText.replace(/,/g, '')) || 0;
        });

        document.getElementById('ftQty').innerText      = qty.toFixed(2);
        document.getElementById('ftDiscount').innerText = '-' + discount.toFixed(2);
        document.getElementById('ftTotal').innerText    = total.toFixed(2);
        document.getElementById('ftPurchase').innerText = purchase.toFixed(2);

        const profitCell = document.getElementById('ftProfit');
        profitCell.innerText = profit.toFixed(2);
        profitCell.className = profit < 0
            ? 'text-end fw-bold profit-negative'
            : 'text-end fw-bold profit-positive';
    }


    function initializeCategoryFilter() {
        const categorySelect = document.getElementById('categoryInput');
        if (!categorySelect) return;

        categorySelect.onchange = function () {
            const selectedCategory = (this.value || '').toLowerCase().trim();
            const rows = document.querySelectorAll('#itemsTableBody tr');

            rows.forEach(row => {
                const category = (row.getAttribute('data-category') || '').toLowerCase().trim();
                const show = (!selectedCategory || category === selectedCategory);
                row.style.display = show ? '' : 'none';
            });
            recalculateFooterTotals();
        };
        recalculateFooterTotals();
    }

    function printA4() { window.print(); }

    // ✅ Single clean deleteSale
    function deleteSale(saleId) {
        Swal.fire({
            title: 'Delete sale?',
            text: "This will permanently delete the invoice!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, delete',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (!result.isConfirmed) return;

            const tokenEl = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')
                || document.querySelector('input[name="__RequestVerificationToken"]');

            const token = tokenEl ? tokenEl.value : '';
            const deleteUrl = '@Url.Action("Delete", "Sales")';

            fetch(deleteUrl + '?id=' + saleId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'RequestVerificationToken': token,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: '__RequestVerificationToken=' + encodeURIComponent(token)
            })
            .then(async (res) => {
                const ct = res.headers.get('content-type') || '';
                if (!res.ok) throw new Error('Request failed');

                if (ct.includes('application/json')) return res.json();
                return { success: false, message: 'Delete endpoint did not return JSON. Controller fix needed.' };
            })
            .then(data => {
                if (data && data.success) {
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'Sale deleted successfully.',
                        icon: 'success',
                        timer: 1200,
                        showConfirmButton: false
                    }).then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message || 'Failed to delete sale.', 'error');
                }
            })
            .catch(() => {
                Swal.fire('Error', 'An error occurred while deleting the sale.', 'error');
            });
        });
    }
</script>
