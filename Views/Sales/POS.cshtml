@using System.Text.Json
@model IEnumerable<ItemModel>

@{

    ViewBag.Title = "GSoft POS";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var safeModel = Model ?? new List<ItemModel>();
    var itemsJson = JsonSerializer.Serialize(safeModel);

    var cashierId = ViewBag.CashierId as string ?? "N/A";
    var shopName = ViewBag.ShopName as string ?? "GSoft POS";

    var invoiceNo = ViewBag.InvoiceLastDigits;

    var customerPayments = ViewBag.CustomerPayments as List<CustomerPayment> ?? new List<CustomerPayment>();

    // ✅ Correct Dashboard URL (your route)
    var dashboardUrl = Url.Action("Index", "Home") ?? "/Home/Index";

    var searchSale = ViewBag.Sale as Sale;
}

<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<link href="~/lib/bootstrap-icons/bootstrap-icons-1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    :root {
        --brand: #60a5fa;
        --brand-2: #93c5fd;
        --ink: #0f172a;
        --muted: #64748b;
        --card: #ffffff;
        --bg: #f8fafc;
        --ok: #16a34a;
        --warn: #f59e0b;
        --danger: #dc2626;
        --slate: #1e293b;
        --grad-1: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
        --grad-2: linear-gradient(135deg, #22c55e 0%, #60a5fa 100%);
        --grad-3: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
    }

    body {
        background: var(--bg);
    }

    #posShell {
        position: relative;
    }

        #posShell:fullscreen,
        #posShell:-webkit-full-screen {
            background: var(--bg);
            padding: 8px;
            width: 100vw;
            height: 100vh;
            overflow: auto;
        }

    .pos-header {
        background: linear-gradient(135deg,var(--brand) 0%, var(--brand-2) 100%);
        border-radius: 16px;
        padding: 12px 16px;
        margin-bottom: 0px;
        color: #0f172a;
        box-shadow: 0 6px 18px rgba(96,165,250,.30);
        border: 1px solid #e2e8f0;
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        padding: .4rem .75rem;
        border-radius: 999px;
        background: rgba(255,255,255,.75);
        border: 1px solid rgba(203,213,225,.6);
        font-weight: 600;
        color: #0f172a;
        white-space: nowrap;
    }

    .brand-chip {
        display: inline-flex;
        align-items: center;
        gap: .6rem;
        padding: .6rem 1.4rem;
        border-radius: 16px;
        background: rgba(255,255,255,.25);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255,255,255,.35);
        color: #0f172a;
        font-weight: 800;
        font-size: 1.6rem;
        letter-spacing: .6px;
        text-transform: uppercase;
        box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }

        .brand-chip i {
            font-size: 1.6rem;
            color: #2563eb;
        }

    .inv-group {
        max-width: 260px;
    }

        .inv-group .form-control {
            border: none;
            border-radius: 12px 0 0 12px;
        }

        .inv-group .input-group-text {
            border: none;
            border-radius: 12px 0 0 12px;
            background: #e0f2fe;
            color: #0f172a;
        }

        .inv-group .btn-search {
            border: none;
            border-radius: 0 12px 12px 0;
            background: #22c55e;
            color: #fff;
            font-weight: 600;
        }

            .inv-group .btn-search:hover {
                background: #16a34a;
            }

    .icon-btn {
        border: 1px solid #cbd5e1;
        background: #f1f5f9;
        color: #0f172a;
        border-radius: 10px;
        padding: .35rem .55rem;
    }

        .icon-btn:hover {
            background: #e2e8f0;
        }

        .icon-btn.active {
            background: #e0f2fe;
            border-color: #93c5fd;
            color: #1d4ed8;
        }

    .inv-badge {
        display: inline-flex;
        align-items: center;
        gap: .45rem;
        padding: .38rem .75rem;
        border-radius: 12px;
        background: #e0f2fe;
        border: 1px solid #bae6fd;
        color: #075985;
        font-weight: 700;
    }

    .pos-card {
        background: var(--card);
        border-radius: 16px;
        box-shadow: 0 6px 16px rgba(2,6,23,.05);
        border: 1px solid #e5e7eb;
    }

    .section-title {
        font-weight: 700;
        color: var(--ink);
        margin-bottom: 10px;
    }

    .barcode-input {
        height: 52px;
        font-size: 1rem;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
        transition: all .15s;
    }

        .barcode-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 .2rem rgba(59,130,246,.15);
        }

        .barcode-input.blinking {
            animation: blink-glow 1.5s infinite;
        }

    @@keyframes blink-glow {
        0% {
            box-shadow: 0 0 0 rgba(37,99,235,0);
            border-color: #e2e8f0;
        }

        50% {
            box-shadow: 0 0 12px rgba(37,99,235,.45);
            border-color: #3b82f6;
        }

        100% {
            box-shadow: 0 0 0 rgba(37,99,235,0);
            border-color: #e2e8f0;
        }
    }

    @@keyframes blink-glow-red {
        0% {
            box-shadow: 0 0 0 rgba(239,68,68,0);
            border-color: #e2e8f0;
        }

        50% {
            box-shadow: 0 0 12px rgba(239,68,68,.5);
            border-color: #ef4444;
        }

        100% {
            box-shadow: 0 0 0 rgba(239,68,68,0);
            border-color: #e2e8f0;
        }
    }

    body.return-mode .pos-card .barcode-input {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 .2rem rgba(239,68,68,.15) !important;
    }

        body.return-mode .pos-card .barcode-input.blinking {
            animation: blink-glow-red 1.5s infinite !important;
        }

    .pos-table thead th {
        background: #3b82f6;
        color: #fff;
        position: sticky;
        top: 0;
    }

    .qty-input {
        width: 76px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        text-align: center;
        padding: .25rem .4rem;
    }

    .delete-row-btn {
        border: 1px solid #fecaca;
        background: #fff1f2;
        color: #b91c1c;
        border-radius: 10px;
        padding: .35rem .55rem;
    }

        .delete-row-btn:hover {
            background: #ffe4e6;
        }

    .totals-bar {
        position: sticky;
        bottom: 0;
        margin-top: 18px;
        background: linear-gradient(180deg, rgba(248,250,252,0), #f1f5f9 40%);
        padding-top: 10px;
        z-index: 10;
    }

    .totals-card {
        background: #fff;
        color: var(--ink);
        border-radius: 14px;
        padding: 10px 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e5e7eb;
        box-shadow: 0 8px 24px rgba(2,6,23,.08);
    }

        .totals-card .sum {
            display: flex;
            gap: 18px;
            align-items: center;
        }

    .sum .k {
        font-size: .8rem;
        color: var(--muted);
    }

    .sum .v {
        font-size: 1.05rem;
        font-weight: 600;
    }

    .btn-items {
        background: #e2e8f0;
        border: 1px solid #cbd5e1;
        color: #0f172a;
        padding: .30rem .50rem;
        font-size: .82rem;
        height: 36px;
        display: flex;
        align-items: center;
        gap: .35rem;
        border-radius: 10px;
        font-weight: 800;
        width: 100%;
        justify-content: space-between;
    }

        .btn-items:hover {
            background: #cfd8e3;
        }

    .btn-new {
        background: #10b981;
        border: 1px solid #059669;
        color: #fff;
        border-radius: 10px;
        font-weight: 900;
        padding: .30rem .50rem;
        font-size: .82rem;
        line-height: 1;
        height: 36px;
        display: flex;
        align-items: center;
        gap: .35rem;
        width: 100%;
        justify-content: space-between;
    }

    .kbd {
        border: 1px solid #cbd5e1;
        background: #f8fafc;
        border-radius: 6px;
        padding: 2px 6px;
        font-size: .72rem;
        color: #334155;
        font-weight: 800;
        white-space: nowrap;
    }

    .sale-return {
        border-right: none;
        padding-right: 0;
        margin-right: 0;
        border-left: 1px solid #e2e8f0;
        padding-left: 12px;
        margin-left: 6px;
    }

        .sale-return .form-check-input {
            cursor: pointer;
        }

        .sale-return .form-check-label {
            font-weight: 900;
            color: #0f172a;
            margin-right: 6px;
            font-size: .9rem;
        }

    .method-pill {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        border: 1px solid #e2e8f0;
        border-radius: 999px;
        padding: .35rem .7rem;
        cursor: pointer;
        user-select: none;
        color: #0f172a;
        background: #f1f5f9;
        font-weight: 700;
    }

        .method-pill.active {
            border-color: #3b82f6;
            color: #1d4ed8;
            background: #e0f2fe;
        }

    .actions .btn {
        font-weight: 600;
        border-radius: 12px;
        padding: .55rem .9rem;
        display: flex;
        align-items: center;
        gap: .45rem;
        border: 1px solid transparent;
        position: relative;
        overflow: visible;
    }

    .btn-soft-green {
        background: #ecfdf5;
        color: #065f46;
        border-color: #a7f3d0;
    }

    .btn-soft-blue {
        background: #eff6ff;
        color: #1e40af;
        border-color: #bfdbfe;
    }

    .btn-soft-sky {
        background: #e0f2fe;
        color: #075985;
        border-color: #bae6fd;
    }

    .btn-soft-slate {
        background: #f1f5f9;
        color: #0f172a;
        border-color: #cbd5e1;
    }

    .btn-soft-amber {
        background: #fff7ed;
        color: #7c2d12;
        border-color: #fed7aa;
    }

    .btn-soft-gray {
        background: #f8fafc;
        color: #334155;
        border-color: #cbd5e1;
    }

    .focus-mode-indicator {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #64748b;
        color: #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 8px 18px rgba(2,6,23,.25);
    }

    .focus-mode-text {
        font-weight: 900;
        padding: 2px 8px;
        border-radius: 6px;
    }

    .focus-mode-qty .focus-mode-text {
        background: #22c55e;
        color: #fff;
    }

    .focus-mode-price .focus-mode-text {
        background: #3b82f6;
        color: #fff;
    }

    .focus-mode-scan .focus-mode-text {
        background: #64748b;
        color: #fff;
    }

    .editable-price {
        background: #fff7ed !important;
        border: 2px solid #f59e0b !important;
        border-radius: 6px;
        padding: 4px 8px;
        font-weight: 800;
        cursor: text;
        outline: none;
    }

        .editable-price:focus {
            background: #fff !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59,130,246,.25);
        }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(2px);
    }

    .payment-modal {
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 40px 100px rgba(2,6,23,.45);
        width: 800px;
        max-width: 96vw;
        max-height: 96vh;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
    }

        .payment-modal .titlebar {
            background: var(--grad-1);
            color: #0f172a;
            border-radius: 16px 16px 0 0;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }

    .titlebar .ttl {
        font-weight: 900;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #0b1324;
    }

    .payment-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 10px;
        background: #fbfdff;
    }

    .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
        background: #eff6ff;
        color: #1e3a8a;
        font-weight: 900;
    }

    .stat-ok {
        background: #ecfdf5;
        border-color: #bbf7d0;
        color: #065f46;
    }

    .stat-warn {
        background: #fffbeb;
        border-color: #fde68a;
        color: #92400e;
    }

    .retrieve-modal {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 30px 80px rgba(2,6,23,.45);
        width: 900px;
        max-width: 96vw;
        max-height: 92vh;
        overflow: auto;
        border: 1px solid #e5e7eb;
    }

    .retrieve-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        background: var(--grad-2);
    }

        .retrieve-head .title {
            font-weight: 900;
            color: #0b1324;
            display: flex;
            gap: 8px;
            align-items: center;
        }

    .retrieve-toolbar {
        display: flex;
        gap: 8px;
        padding: 10px 16px;
        border-bottom: 1px solid #eef2f7;
        background: #fcfcfd;
        flex-wrap: wrap;
    }

    .table-hold th {
        position: sticky;
        top: 0;
        background: #f1f5f9;
    }

    .suggestions-list {
        position: absolute;
        width: 100%;
        max-width: 620px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 16px 40px rgba(2,6,23,.12);
        margin-top: 6px;
        overflow: hidden;
        z-index: 1000;
        max-height: 260px;
        overflow-y: auto;
        padding: 4px;
        backdrop-filter: saturate(1.2) blur(2px);
    }

    .suggestion-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        transition: background .15s ease, border-color .15s ease, transform .04s ease;
        border: 1px solid transparent;
        background: #f9fafb;
        margin: 3px 2px;
    }

        .suggestion-item:hover {
            background: #eff6ff;
            border-color: #dbeafe;
        }

        .suggestion-item.active {
            background: #dbeafe;
            border-color: #93c5fd;
        }

    .suggestion-code {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 900;
        font-family: ui-monospace, Menlo, Consolas, monospace;
        color: #1e3a8a;
        padding: 3px 8px;
        border-radius: 8px;
        border: 1px solid #c7d2fe;
        background: #eef2ff;
        white-space: nowrap;
        line-height: 1.1;
    }

    .suggestion-qty {
        font-weight: 800;
        color: #065f46;
        background: #ecfdf5;
        border: 1px solid #a7f3d0;
        border-radius: 999px;
        padding: 1px 8px;
        white-space: nowrap;
        font-size: .9rem;
        line-height: 1.1;
    }

    .suggestion-name {
        flex: 1;
        min-width: 0;
        font-weight: 800;
        color: #0f172a;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: .95rem;
    }

    .swal2-container {
        z-index: 10000 !important;
    }

    .gpos-swal-fixed {
        position: fixed !important;
        inset: 0 !important;
        pointer-events: none !important;
    }

    .swal2-popup.swal2-toast {
        pointer-events: auto !important;
    }

    .topbar-line {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
    }

    @@media (min-width: 992px) {
        .topbar-line {
            flex-wrap: nowrap;
        }
    }

    .items-buttons-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-shrink: 0;
        width: 150px;
        align-items: flex-start;
        justify-content: flex-start;
    }

    .barcode-center-area {
        position: relative;
        margin-left: auto;
        width: 620px;
        max-width: 620px;
        min-width: 340px;
    }

    .barcode-controls {
        display: block;
        width: 100%;
    }

    .data-grid-wrapper {
        margin-top: 4px;
    }

    .bottom-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0 0 0;
        margin-top: 12px;
        border-top: 1px solid #e2e8f0;
    }

    .exit-btn {
        border: none;
        color: white;
        font-weight: 900;
        padding: 10px 16px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 10px 22px rgba(2,6,23,.12);
    }

    .exit-to-dashboard {
        background: linear-gradient(135deg,#60a5fa 0%, #a78bfa 100%);
    }

        .exit-to-dashboard:hover {
            filter: brightness(.96);
            color: #fff;
        }

    .close-app {
        background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
    }

        .close-app:hover {
            filter: brightness(.96);
            color: #fff;
        }

    @@media (max-width: 992px) {
        .barcode-center-area {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            order: 3;
        }

        .items-buttons-group {
            width: 100%;
            flex-direction: row;
            gap: 10px;
            order: 1;
        }

            .items-buttons-group .btn-items,
            .items-buttons-group .btn-new {
                width: auto;
                flex: 1;
                justify-content: center;
            }

        .sale-return {
            border-left: none;
            padding-left: 0;
            margin-left: 0;
            order: 2;
        }

        .bottom-actions-bar {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
        }

            .bottom-actions-bar .exit-btn {
                width: 100%;
                justify-content: center;
            }
    }

    /* ✅ IMPORTANT: Per-item discount show ONLY ONE (percent OR PKR) */
    .disc-percent-wrap, .disc-amount-wrap {
        display: none !important;
    }

    body.disc-mode-percent .disc-percent-wrap {
        display: inline-flex !important;
    }

    body.disc-mode-amount .disc-amount-wrap {
        display: inline-flex !important;
    }
</style>

<div id="posShell">
    <!-- HEADER -->
    <div class="pos-header">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center flex-wrap gap-2">
                <form asp-action="POS" method="get">
                    <div class="input-group inv-group">

                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="tbInvoiceSearch" name="search" value="@ViewBag.Search" type="text" class="form-control inv-input" placeholder="Search invoice #">
                        <button type="submit" id="btnInvSearch" class="btn btn-search"><i class="bi bi-search"></i></button>

                    </div>
                </form>
                <button id="btnInvPrev" class="icon-btn" title="Previous (Alt+Left)"><i class="bi bi-chevron-left"></i></button>
                <button id="btnInvNext" class="icon-btn" title="Next (Alt+Right)"><i class="bi bi-chevron-right"></i></button>
                <span class="inv-badge"><i class="bi bi-receipt-cutoff"></i><span id="invoiceNoValue"></span></span>
            </div>

            <div class="text-center flex-grow-1 d-none d-md-block">
                <span class="brand-chip"><i class="bi bi-shop"></i>@shopName</span>
            </div>

            <div class="d-flex align-items-center gap-2">
                <span class="chip"><i class="bi bi-person-badge"></i> <span id="chipCashier">@cashierId</span></span>
                <span class="chip"><i class="bi bi-bullseye"></i> Mode: <span id="modeChip" class="focus-mode-text">Scan</span></span>
                <span class="chip"><i class="bi bi-calendar3-event"></i> <span id="liveClock">—</span></span>
                <button id="btnFullscreen" class="icon-btn" title="Expand (Alt+Enter)"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
        </div>
    </div>

    <div class="container-fluid pt-0">
        <div class="row g-4">
            <!-- LEFT -->
            <div class="col-lg-8">
                <!-- TOP BAR -->
                <div class="pos-card p-3 mb-3">
                    <div class="topbar-line">
                        <div class="items-buttons-group">
                            <button id="btnItemsList" class="btn btn-items" title="Open items list (Alt+I)">
                                <span><i class="bi bi-list-ul"></i> Items List</span>
                                <span class="kbd">Alt+I</span>
                            </button>

                            <a asp-action="Add" asp-controller="Item" id="btnNewItem" class="btn btn-new" title="Add new item (Alt+N)">
                                <span><i class="bi bi-plus-lg"></i> New Item</span>
                                <span class="kbd">Alt+N</span>
                            </a>
                        </div>

                        <div class="sale-return-group d-flex align-items-center">
                            <div class="sale-return d-flex align-items-center gap-2 flex-wrap">
                                <div class="form-check form-check-inline m-0">
                                    <input class="form-check-input saletype" type="radio" name="SaleType" id="rbSale" value="Sale" checked>
                                    <label class="form-check-label" for="rbSale">
                                        <i class="bi bi-bag-check me-1"></i>Sale <span class="kbd">Alt+S</span>
                                    </label>
                                </div>
                                <div class="form-check form-check-inline m-0">
                                    <input class="form-check-input saletype" type="radio" name="SaleType" id="rbReturn" value="Return">
                                    <label class="form-check-label" for="rbReturn">
                                        <i class="bi bi-arrow-counterclockwise me-1"></i>Return <span class="kbd">Alt+R</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="barcode-center-area">
                            <div class="barcode-controls">
                                <input id="itemSearchInput" class="form-control barcode-input blinking"
                                       placeholder="Scan barcode or search item… (Alt + B)"
                                       onkeyup="showItemSuggestions(this.value)"
                                       onfocus="showItemSuggestions(this.value)"
                                       style="width: 100%;" />

                                <div id="itemSuggestions" class="suggestions-list" style="display:none; left: 0; right: 0;"></div>
                            </div>

                            <div class="small text-muted mt-2 d-flex align-items-center justify-content-between flex-wrap gap-2">
                                <span style="font-size: .8rem;">
                                    <span class="kbd">F2</span> Qty |
                                    <span class="kbd">F3</span> Price |
                                    <span class="kbd">F4</span> Pay |
                                    Current: <span id="currentFocusMode" class="focus-mode-text">Scan</span>
                                </span>

                                <span class="d-flex align-items-center gap-1">
                                    <span class="chip" style="font-size: .8rem; padding: .2rem .5rem;">
                                        <i class="bi bi-tag"></i> <span id="itemDiscModeChip">Item Disc: %</span>
                                    </span>
                                    <button type="button" id="itemDiscModePercentBtn" class="icon-btn active"
                                            style="padding: .2rem .4rem; font-size: .85rem;" onclick="setItemDiscMode('percent')">
                                        %
                                    </button>
                                    <button type="button" id="itemDiscModeAmountBtn" class="icon-btn"
                                            style="padding: .2rem .4rem; font-size: .85rem;" onclick="setItemDiscMode('amount')">
                                        ₨
                                    </button>
                                </span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Items table -->
                <div class="pos-card data-grid-wrapper">
                    <div class="p-3 pb-2 d-flex justify-content-between">
                        <div></div><div></div>
                    </div>
                    <div class="table-responsive" style="max-height:60vh;">
                        <table class="table table-hover align-middle pos-table mb-0" id="salesTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Item Name</th>
                                    <th>Price</th>
                                    <th>Qty</th>
                                    <th>Disc</th>
                                    <th>Tax %</th>
                                    <th>Line Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="noDataRow">
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="bi bi-bag-x fs-4 d-block mb-2"></i>No items added yet
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="col-lg-4">
                <!-- CUSTOMER -->
                <div class="pos-card p-3 mb-3">
                    <div class="section-title"><i class="bi bi-people"></i> Customer</div>
                    <div class="d-flex gap-2 mb-2">
                        <input type="radio" name="custType" id="walkinRadio" checked onchange="toggleCustomerType()" />
                        <span class="chip"><i class="bi bi-person-walking"></i> Walk-in</span>
                        <input type="radio" name="custType" id="customerRadio" onchange="toggleCustomerType()" class="ms-3" />
                        <span class="chip"><i class="bi bi-person-lines-fill"></i> Registered</span>
                    </div>
                    <div id="walkinBlock" class="p-2 border rounded bg-light"><strong>Walk-in Customer</strong></div>
                    <div id="customerBlock" style="display:none;">
                        <div class="input-group mb-2">
                            <select id="customerDropdown" class="form-control" onchange="setSelectedCustomer(this)">
                                <option value="">-- Select Customer --</option>
                                @foreach (var cust in ViewBag.CustomerList)
                                {
                                    <option value="@cust.Id" data-id="@cust.Id">@cust.CustomerName</option>
                                }
                            </select>
                            <input name="CustomerId" type="hidden" id="selectedCustomerId" />
                            <a class="btn btn-outline-primary" href="/Customer/Create" title="Add New Customer"><i class="bi bi-plus-lg"></i></a>
                        </div>
                        <div class="d-flex justify-content-between mt-2" id="selectedCustomerBlock" style="display:none;">
                            <div class="text-muted">Balance</div>
                            <div class="chip" id="customerBalance"></div>
                        </div>
                    </div>
                </div>

                <!-- PAYMENT METHOD (hidden select) -->
                <select id="paymentMethod" style="display:none;">
                    <option value="credit">Credit</option>
                    <option value="cash" selected>Cash</option>
                    <option value="credit_card">Card</option>
                    <option value="bank">Bank</option>
                    <option value="online">Online</option>
                </select>

                <div class="pos-card p-3 mb-3">
                    <div class="section-title"><i class="bi bi-cash-coin"></i> Payment Method</div>
                    <div class="d-flex flex-wrap gap-2" id="paymentPills">
                        <span class="method-pill" data-value="credit"><i class="bi bi-journal-text"></i> Credit</span>
                        <span class="method-pill" data-value="cash"><i class="bi bi-cash"></i> Cash</span>
                        <span class="method-pill" data-value="credit_card"><i class="bi bi-credit-card"></i> Card</span>
                        <span class="method-pill" data-value="bank"><i class="bi bi-bank"></i> Bank</span>
                        <span class="method-pill" data-value="online"><i class="bi bi-wifi"></i> Online</span>
                    </div>
                    <div class="small text-muted mt-2">Pay karne ke liye <span class="kbd">F4</span>/<span class="kbd">F5</span> use karein.</div>
                </div>

                <!-- BILL SUMMARY -->
                <div class="pos-card p-3">
                    <div class="section-title"><i class="bi bi-cash-stack"></i> Bill Summary</div>
                    <div class="d-flex justify-content-between py-1"><span class="text-muted">Sub-Total</span><strong class="gpos-total" id="subTotal">₨0.00</strong></div>

                    <div class="d-flex justify-content-between align-items-center py-1">
                        <span class="text-muted">Discount</span>
                        <div class="d-flex gap-2 align-items-center">
                            <input id="invoiceDiscountPercent" type="number" class="qty-input" placeholder="%" min="0" max="100" step="0.01" value="0" title="Discount Percentage (Ctrl+D)" />
                            <span class="text-muted">%</span>
                            <input id="invoiceDiscountAmount" type="number" class="qty-input" placeholder="Less (PKR)" min="0" step="0.01" value="0" title="Discount Less (PKR)" />
                        </div>
                    </div>

                    <div class="d-flex justify-content-between py-1"><span class="text-muted">Total Discount</span><strong id="invoiceDiscountComputed">₨0.00</strong></div>
                    <div class="d-flex justify-content-between py-1"><span class="text-muted">Total Tax</span><strong class="gpos-tax" id="sumTax">₨0.00</strong></div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between py-1 fs-5"><span>Grand Total</span><span class="fw-bold gpos-grand-value" id="grandTotal">₨0.00</span></div>
                    <div class="small text-muted mt-1">Shortcuts: <span class="kbd">Ctrl + D</span> discount focus • <span class="kbd">F4</span>/<span class="kbd">F5</span> to pay.</div>
                </div>
            </div>
        </div>

        <!-- Sticky Totals / Actions -->
        <div class="totals-bar">
            <div class="totals-card">
                <div class="sum">
                    <div><div class="k">Items</div><div class="v gpos-quantity" id="sumItems">0</div></div>
                    <div><div class="k">Qty</div><div class="v gpos-items" id="sumQty">0</div></div>
                    <div><div class="k">Payable</div><div class="v" id="sumPayable">0.00</div></div>
                </div>
                <div class="actions d-flex flex-wrap gap-2">
                    <button class="btn btn-soft-green saveprint-btn" id="saveprint-btn" title="F4"><i class="bi bi-receipt"></i> Save & Print (F4)</button>
                    <button class="btn btn-soft-blue saveonly-btn" id="saveonly-btn" title="F5"><i class="bi bi-floppy"></i> Save (F5)</button>

                    <div class="btn-group">
                        <button class="btn btn-soft-amber" id="btnHold" title="Hold current"><i class="bi bi-pause-circle"></i> Hold</button>
                        <button class="btn btn-soft-gray" id="btnRetrieveHeld" title="Retrieve held"><i class="bi bi-archive"></i> Retrieve Held</button>
                    </div>

                    <button class="btn btn-soft-sky new-btn" id="new-btn" title="F12"><i class="bi bi-file-earmark-plus"></i> New Invoice (F12)</button>
                    <button class="btn btn-soft-slate print-btn" id="print-btn" title="F8"><i class="bi bi-printer"></i> Print (F8)</button>
                </div>
            </div>
        </div>

        <!-- Exit buttons -->
        <div class="bottom-actions-bar">
            <div class="small text-muted">
                <i class="bi bi-info-circle"></i> Exit to Dashboard / Close App
            </div>

            <div class="d-flex gap-2 flex-wrap justify-content-end">
                <button type="button" class="exit-btn exit-to-dashboard" onclick="exitToDashboard()">
                    <i class="bi bi-speedometer2"></i> Exit to Dashboard
                </button>

                <button type="button" class="exit-btn close-app" onclick="closeSoftware()">
                    <i class="bi bi-x-circle"></i> Close Software
                </button>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModalOverlay" class="modal-overlay">
            <div class="payment-modal" id="paymentModalCard" tabindex="-1">
                <div class="titlebar">
                    <div class="ttl"><i class="bi bi-wallet2"></i> Take Payment</div>
                    <button class="btn btn-soft-slate" onclick="closePaymentModal()" title="Close (Esc)"><i class="bi bi-x-lg"></i></button>
                </div>

                <div class="p-3">
                    <div class="payment-row">
                        <div class="d-flex align-items-center gap-2"><span class="pill"><i class="bi bi-credit-card-2-front"></i> Method</span></div>
                        <div id="modalMethod" class="pill"><i class="bi bi-cash"></i> Cash</div>
                    </div>

                    <div class="payment-row">
                        <div class="d-flex align-items-center gap-2"><i class="bi bi-cash-stack"></i><span>Grand Total</span></div>
                        <div id="tenderGrandTotal" class="fw-bold">0.00</div>
                    </div>

                    <div class="payment-row" id="rowDiscount" style="display:none;">
                        <div class="d-flex align-items-center gap-2"><i class="bi bi-patch-minus"></i><span>Discount</span></div>
                        <div id="tenderDiscount">0.00</div>
                    </div>

                    <div class="payment-row" id="rowTax" style="display:none;">
                        <div class="d-flex align-items-center gap-2"><i class="bi bi-receipt"></i><span>Tax</span></div>
                        <div id="tenderTax">0.00</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-muted"><i class="bi bi-pencil-square"></i> Enter Payment Amount</label>
                        <input id="tenderInput" type="number" class="form-control" placeholder="Amount" min="0" step="0.01" />
                    </div>

                    <div class="payment-row">
                        <div class="d-flex align-items-center gap-2"><i class="bi bi-hourglass-split"></i><span>Remaining Due</span></div>
                        <div id="modalRemaining" class="stat-warn fw-bold px-3 py-1 rounded">0.00</div>
                    </div>

                    <div class="payment-row mb-3">
                        <div class="d-flex align-items-center gap-2"><i class="bi bi-arrow-repeat"></i><span>Change</span></div>
                        <div id="tenderChangeText" class="stat-ok fw-bold px-3 py-1 rounded">0.00</div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 pb-2">
                        <button class="btn btn-soft-gray" onclick="closePaymentModal()"><i class="bi bi-x-circle"></i> Cancel</button>
                        <button class="btn btn-soft-green" id="tenderOkBtn"><i class="bi bi-check2-circle"></i> <span id="btnPayConfirm">Confirm & Print (F4)</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Retrieve Held Modal -->
        <div id="retrieveOverlay" class="modal-overlay">
            <div class="retrieve-modal">
                <div class="retrieve-head">
                    <div class="title"><i class="bi bi-archive"></i> Retrieve Held Invoices</div>
                    <button class="btn btn-soft-slate" onclick="closeRetrieveModal()"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="retrieve-toolbar">
                    <div class="input-group" style="max-width:340px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="holdSearch" type="text" class="form-control" placeholder="Search by invoice #">
                    </div>
                    <button class="btn btn-soft-gray" onclick="sortHeld('time')"><i class="bi bi-clock"></i> Latest</button>
                    <button class="btn btn-soft-gray" onclick="sortHeld('grand')"><i class="bi bi-cash-coin"></i> Grand Total</button>
                    <button class="btn btn-soft-amber" onclick="clearAllHeld()"><i class="bi bi-trash3"></i> Clear All</button>
                </div>
                <div class="p-3">
                    <div class="table-responsive" style="max-height:60vh;">
                        <table class="table table-hover align-middle table-hold" id="heldTable">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Items</th>
                                    <th>Preview</th>
                                    <th>Grand</th>
                                    <th>Held At</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="heldTbody"></tbody>
                        </table>
                    </div>
                    <div id="noHeldRow" class="text-center text-muted py-4" style="display:none;">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>No held invoices
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<link href="~/lib/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
<script src="~/lib/sweetalert2/sweetalert2.min.js"></script>


<script>
    /* -------- GLOBALS -------- */
    let filtered = [];
    let selectedIdx = -1;

    let focusMode = 'scan';

    // ✅ Default: percent
    let itemDiscMode = 'percent'; // 'percent' | 'amount'

    let currentEditingPrice = null;
    const items = @Html.Raw(itemsJson);
    const TAX_PERCENT = 0;

    var invoiceCounter = "@invoiceNo";
    let pendingAction = null;

    let itemInputEl, suggDiv, posShell, btnFullscreen;
    let invoiceDiscountPercentEl, invoiceDiscountAmountEl;

    // ✅ Dashboard URL from server
    const DASHBOARD_URL = "@dashboardUrl";

    /* -------- UTILS -------- */
    function getToastTarget() {
        return document.fullscreenElement || document.webkitFullscreenElement || document.body;
    }

    function toast(msg, icon = 'info', ms = 1500) {
        Swal.fire({
            toast: true,
            icon: icon,
            title: msg,
            position: 'top-end',
            showConfirmButton: false,
            timer: ms,
            timerProgressBar: true,
            target: getToastTarget(),
            didOpen: (container) => {
                const c = container?.closest?.('.swal2-container');
                if (c) c.classList.add('gpos-swal-fixed');
            }
        });
    }

    function nowIso() { return new Date().toISOString(); }
    function selectAllContent(el) {
        const r = document.createRange(); r.selectNodeContents(el);
        const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }
    function money(n) { return `₨${(n || 0).toFixed(2)}`; }
    function hasLineItems() { return !!document.querySelector('#salesTable tbody tr:not(#noDataRow)'); }
    function clamp(n, min, max) {
        n = parseFloat(n);
        if (isNaN(n)) n = 0;
        return Math.min(Math.max(n, min), max);
    }

    /* ✅✅ SAVE FIX HELPERS (JSON/HTML + CSRF) */
    function getAntiForgeryToken() {
        return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
    }

    async function readResponseSmart(res) {
        const ct = (res.headers.get('content-type') || '').toLowerCase();
        const text = await res.text();

        let json = null;
        if (ct.includes('application/json')) {
            try { json = JSON.parse(text); } catch { json = null; }
        }
        return { ct, text, json };
    }

    function showServerError(title, details) {
        Swal.fire({
            icon: 'error',
            title: title || 'Error',
            html: `<div style="text-align:left;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px;max-height:260px;overflow:auto;border:1px solid #e5e7eb;padding:10px;border-radius:10px;background:#f9fafb;">${String(details || '').replace(/</g, '&lt;')}</div>`,
            target: getToastTarget()
        });
    }

    /* ✅✅ EXIT / CLOSE */
    function exitToDashboard() {
        window.location.href = DASHBOARD_URL || '/Home/Index';
    }

    function closeSoftware() {
        Swal.fire({
            icon: 'warning',
            title: 'Close Software?',
            text: 'Browser apps normally cannot force-close tabs. If allowed, it will close. Otherwise it will take you to Dashboard.',
            showCancelButton: true,
            confirmButtonText: 'Close',
            cancelButtonText: 'Cancel',
            target: getToastTarget()
        }).then(r => {
            if (!r.isConfirmed) return;

            try {
                window.open('', '_self');
                window.close();
            } catch { }

            setTimeout(() => {
                window.location.href = DASHBOARD_URL || '/Home/Index';
            }, 200);
        });
    }

    /* ✅ ITEM DISC MODE (Percent / Amount) — show ONLY one in grid */
    function setItemDiscMode(mode, showToast = true) {
        itemDiscMode = (mode === 'amount') ? 'amount' : 'percent';

        document.body.classList.remove('disc-mode-percent', 'disc-mode-amount');
        document.body.classList.add(itemDiscMode === 'percent' ? 'disc-mode-percent' : 'disc-mode-amount');

        const chip = document.getElementById('itemDiscModeChip');
        const bP = document.getElementById('itemDiscModePercentBtn');
        const bA = document.getElementById('itemDiscModeAmountBtn');

        if (chip) chip.textContent = (itemDiscMode === 'percent') ? 'Item Disc: %' : 'Item Disc: PKR';
        bP?.classList.toggle('active', itemDiscMode === 'percent');
        bA?.classList.toggle('active', itemDiscMode === 'amount');

        recalculateTotals();

        if (showToast) {
            toast(itemDiscMode === 'percent'
                ? 'Item discount mode: %'
                : 'Item discount mode: PKR (Less)', 'info', 1100);
        }
    }

    /* -------- FOCUS / MODES -------- */
    function initializeFocusMode() { setFocusMode('scan', false); }

    // ✅✅ FIX: F2/F3 se grid focus nahi jayega — barcode pe hi rahega
    function setFocusMode(mode, showToast = true) {
        focusMode = mode;

        document.body.classList.remove('focus-mode-qty', 'focus-mode-price', 'focus-mode-scan');
        if (mode === 'qty') document.body.classList.add('focus-mode-qty');
        else if (mode === 'price') document.body.classList.add('focus-mode-price');
        else document.body.classList.add('focus-mode-scan');

        const lbl = document.getElementById('currentFocusMode');
        const chip = document.getElementById('modeChip');

        const text = (mode === 'qty' ? 'Quantity' : mode === 'price' ? 'Price' : 'Scan');
        if (lbl) lbl.textContent = text;
        if (chip) chip.textContent = text;

        updateFocusModeIndicator();

        if (showToast) toast(`Mode: ${text}`, 'info', 900);

        // ✅ always keep barcode focus
        focusBarcode();
    }

    function updateFocusModeIndicator() {
        let i = document.getElementById('focusModeIndicator');
        if (!i) {
            i = document.createElement('div');
            i.id = 'focusModeIndicator';
            i.className = 'focus-mode-indicator';
            const p = document.getElementById('itemSearchInput')?.parentNode;
            if (p) { p.style.position = 'relative'; p.appendChild(i); }
        }
        if (!i) return;

        i.textContent = (focusMode === 'qty' ? 'Q' : focusMode === 'price' ? 'P' : 'S');
        i.style.background = (focusMode === 'qty' ? '#22c55e' : focusMode === 'price' ? '#3b82f6' : '#64748b');
    }

    function focusLastPriceCell() {
        const r = document.querySelector('#salesTable tbody tr:last-child');
        if (!r || r.id === 'noDataRow') return;
        const c = r.querySelector('.price-cell'); if (!c) return;
        makePriceEditable(c); selectAllContent(c); c.focus();
    }

    function focusLastQtyInput() {
        const r = document.querySelector('#salesTable tbody tr:last-child');
        if (!r || r.id === 'noDataRow') return;
        const q = r.querySelector('.qty-main'); if (!q) return;
        q.focus(); q.select();
    }

    function focusBarcode() {
        const bi = document.getElementById('itemSearchInput');
        if (!bi) return;
        bi.classList.add('blinking');
        bi.focus();
        bi.select();
    }

    function focusQtyOnRow(row) {
        const q = row?.querySelector('.qty-main');
        if (q) { q.focus(); q.select(); }
    }

    function focusPriceOnRow(row) {
        const p = row?.querySelector('.price-cell');
        if (p) { makePriceEditable(p); selectAllContent(p); p.focus(); }
    }

    function postAddFocus(row) {
        if (focusMode === 'price') focusPriceOnRow(row);
        else if (focusMode === 'qty') focusQtyOnRow(row);
        else focusBarcode();
    }

    function toggleQtyMode() { (focusMode === 'qty') ? setFocusMode('scan') : setFocusMode('qty'); }
    function togglePriceMode() { (focusMode === 'price') ? setFocusMode('scan') : setFocusMode('price'); }

    function applySaleTypeVisual() {
        const isReturn = document.getElementById('rbReturn')?.checked;
        document.body.classList.toggle('return-mode', !!isReturn);
        const bi = document.getElementById('itemSearchInput');
        if (bi) bi.placeholder = isReturn ? "Return item scan karein… (Alt + B)" : "Sale item scan karein… (Alt + B)";
    }

    /* -------- SUGGESTIONS / SCAN -------- */
        function showItemSuggestions(term) {
        term = (term || '').trim();
        const listDiv = document.getElementById('itemSuggestions');

        if (!term) {
            listDiv.style.display = 'none';
            filtered = [];
            selectedIdx = -1;
            return;
        }

        const lc = term.toLowerCase();
        filtered = items.filter(x =>
            (x.ItemCode || '').toLowerCase().includes(lc) ||
            (x.ItemName || '').toLowerCase().includes(lc)
        );

        if (filtered.length === 0) {
            listDiv.innerHTML = `
                <div class="suggestion-item">
                    <span class="suggestion-name text-muted">No items found</span>
                </div>`;
            selectedIdx = -1;
        } else {
            // ✅ only set selectedIdx if nothing is selected
            if (selectedIdx < 0) selectedIdx = 0;

            listDiv.innerHTML = filtered.map((it, i) => {
                const code = it.ItemCode || '—';
                const qty = (it.Quantity ?? 0);
                const name = it.ItemName || '';
                return `
                <div class="suggestion-item ${i === selectedIdx ? 'active' : ''}"
                     data-idx="${i}" onclick="selectItemSuggestion(${i})">
                    <span class="suggestion-code"><i class="bi bi-upc-scan"></i>${code}</span>
                    <span class="suggestion-qty">(${qty})</span>
                    <span class="suggestion-name">${name}</span>
                </div>`;
            }).join('');
            updateHighlight();
        }

        listDiv.style.display = 'block';
    }

    // ✅✅ NEW: keep active suggestion visible while moving up/down
    function ensureActiveVisible() {
        const box = document.getElementById('itemSuggestions');
        if (!box || box.style.display !== 'block') return;

        const active = box.querySelector('.suggestion-item.active');
        if (!active) return;

        const top = active.offsetTop;
        const bottom = top + active.offsetHeight;

        if (top < box.scrollTop) box.scrollTop = top - 6;
        else if (bottom > box.scrollTop + box.clientHeight) box.scrollTop = bottom - box.clientHeight + 6;
    }

    function updateHighlight() {
        document.querySelectorAll('#itemSuggestions .suggestion-item')
            .forEach((el, i) => el.classList.toggle('active', i === selectedIdx));

        ensureActiveVisible();
    }

    const allowSaleLowStock = @((ViewBag.SaleLowStock ?? false).ToString().ToLower());

    function selectItemSuggestion(i) {
        if (i < 0 || i >= filtered.length) return;
        const item = filtered[i];

        if ((item.Quantity <= 0) && !allowSaleLowStock) {
            Swal.fire({
                icon: 'error',
                title: 'Stock Unavailable',
                html: `
                    <div style="font-size:14px;">
                        This item is currently <b>out of stock</b>.<br><br>
                        To proceed with this sale, please enable
                        <b>"Allow Sale on Low Stock"</b>
                        from
                         <a href="/Settings/Index"
                           style="color:#0d6efd;font-weight:600;text-decoration:underline;">
                            Shop Settings
                        </a>.
                    </div>
                `,
                confirmButtonText: 'OK',
                confirmButtonColor: '#dc3545'
            });
            return;
        }


        addToSalesTable(item);

        const box = document.getElementById('itemSuggestions');
        box.style.display = 'none';

        const bi = document.getElementById('itemSearchInput');
        bi.value = '';
    }

    let scanState = {
      start: 0,
      last: 0,
      count: 0,
      timer: null,
      buffer: ''
    };
    const SCAN_MIN_LEN = 6;        // minimum chars to qualify as scan
    const SCAN_AVG_MS = 45;        // avg ms per key (scanner threshold)
    const SCAN_END_DELAY = 120;    // wait after last key (slow grouping)
    const SCANNER_ADD_DELAY = 600;

    function attachScannerHandlers() {
        itemInputEl.addEventListener('keydown', e => {
          const now = performance.now();

          /* ─────── SCAN TIMING TRACK ─────── */
            if (scanState.count === 0 || now - scanState.last > SCAN_END_DELAY) {
              scanState.start = now;
              scanState.buffer = '';
              scanState.count = 0;
            }


          scanState.count++;
          scanState.last = now;

          /* ─────── CAPTURE SCANNER CHARS ─────── */
          if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
            scanState.buffer += e.key;
          }

          /* ─────── SUGGESTION NAVIGATION ─────── */
          if (filtered.length && suggDiv.style.display === 'block') {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              if (selectedIdx < filtered.length - 1) {
                selectedIdx++;
                updateHighlight();
              }
              return;
            }

            if (e.key === 'ArrowUp') {
              e.preventDefault();
              if (selectedIdx > 0) {
                selectedIdx--;
                updateHighlight();
              }
              return;
            }

            if (e.key === 'Enter') {
              e.preventDefault();
              if (selectedIdx === -1 && filtered.length > 0) selectedIdx = 0;
              if (selectedIdx >= 0) selectItemSuggestion(selectedIdx);
              return;
            }

            if (e.key === 'Escape') {
              suggDiv.style.display = 'none';
              filtered = [];
              selectedIdx = -1;
              return;
            }
          } else {
            /* ─────── MANUAL ENTER ─────── */
            if (e.key === 'Enter') {
              e.preventDefault();
              manualTryAdd(itemInputEl.value.trim());
              return;
            }
          }

          /* ─────── SCAN END DETECTION ─────── */
          clearTimeout(scanState.timer);
          scanState.timer = setTimeout(() => {
            const term =
              scanState.buffer.length
                ? scanState.buffer.trim()        // scanner input
                : itemInputEl.value.trim();      // manual input

            const duration = scanState.last - scanState.start;
            const avg = duration / Math.max(1, scanState.count);

            const isScanner =
              term.length >= SCAN_MIN_LEN &&
              avg <= SCAN_AVG_MS;

            if (isScanner) {
              scannerAutoAdd(term);
              itemInputEl.value = '';
            } else {
              showItemSuggestions(term);
            }

              scanState.start = 0;
              scanState.last = 0;
              scanState.count = 0;
              scanState.buffer = '';
              scanState.timer = null;

            }, SCAN_END_DELAY);
        });

        itemInputEl.addEventListener('input', () => {
            if (scanState.count === 0) showItemSuggestions(itemInputEl.value.trim());
        });
    }

    function scannerAutoAdd(term) {
        const lc = term.toLowerCase();

        let match =
            items.find(x => (x.ItemCode || '').toLowerCase() === lc) ||
            items.find(x => (x.ItemName || '').toLowerCase() === lc);

        if (!match) {
            const poss = items.filter(x => (x.ItemCode || '').toLowerCase().includes(lc) || (x.ItemName || '').toLowerCase().includes(lc));
            if (poss.length === 1) match = poss[0];
        }
        if (!match) { toast('Item not found', 'warning'); showItemSuggestions(term); return; }

        addToSalesTable(match);
        suggDiv.style.display = 'none';
        itemInputEl.value = '';
    }

    function manualTryAdd(term) {
        const lc = (term || '').toLowerCase();
        if (!lc) return;

        let match =
            items.find(x => (x.ItemCode || '').toLowerCase() === lc) ||
            items.find(x => (x.ItemName || '').toLowerCase() === lc);

        if (match) {
            addToSalesTable(match);
            suggDiv.style.display = 'none';
            itemInputEl.value = '';
            return;
        }
        showItemSuggestions(term);
    }

    /* -------- GRID OPS -------- */
    function makePriceEditable(cell) {
        cell.contentEditable = true;
        cell.classList.add('editable-price');
        currentEditingPrice = cell;
    }

    function savePrice(cell) {
        cell.contentEditable = false;
        cell.classList.remove('editable-price');

        let val = parseFloat((cell.textContent || '').replace('₨', '').trim());
        if (isNaN(val) || val < 0) {
            const orig = cell.dataset.originalPrice;
            cell.textContent = `₨${parseFloat(orig || 0).toFixed(2)}`;
        } else {
            cell.textContent = `₨${val.toFixed(2)}`;
            updateRowTotal(cell.closest('tr'));
        }

        currentEditingPrice = null;
        recalculateTotals();
    }

    function encodeItem(obj) { return encodeURIComponent(JSON.stringify(obj || {})); }

    function addToSalesTable(item) {
        const tb = document.querySelector('#salesTable tbody');
        document.getElementById('noDataRow')?.remove();

        const existing = tb.querySelector(`tr[data-item-id="${item.Id}"]`);
        if (existing) {
            const q = existing.querySelector('.qty-main');
            if (focusMode === 'price') {
                postAddFocus(existing);
            } else {
                q.value = (parseFloat(q.value) || 0) + 1;
                qtyInputChanged(q);
                postAddFocus(existing);
            }
            recalculateTotals();
            return;
        }

        const row = document.createElement('tr');
        row.dataset.itemId = item.Id;

        const originalPrice = item.PackSize ? item.UnitPrice : item.SalePrice;
        const safeItem = encodeItem(item);

        const codeSafe = (item.ItemCode || ('I' + item.Id)).replace(/[^a-zA-Z0-9_-]/g, '');

        row.innerHTML = `
        <td>${tb.rows.length + 1}</td>
        <td>${item.ItemName ?? ''}</td>
        <td><span tabindex="0" class="price-cell" data-original-price="${Number(originalPrice).toFixed(2)}">₨${Number(originalPrice).toFixed(2)}</span></td>
        <td>
          <div class="d-inline-flex gap-1 align-items-center">
            <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(this,-1)"><i class="bi bi-dash-lg"></i></button>
            <input type="number" class="qty-input qty-main" value="1" min="1" onchange="qtyInputChanged(this)" data-item="${safeItem}" />
            <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(this,1)"><i class="bi bi-plus-lg"></i></button>
          </div>
        </td>

        <td>
          <div class="d-inline-flex gap-1 align-items-center disc-percent-wrap">
            <input type="number" class="qty-input disc-percent" value="0" min="0" max="100" step="0.01"
                   onchange="discPercentChanged(this)" />
            <span class="text-muted">%</span>
          </div>

          <div class="d-inline-flex gap-1 align-items-center disc-amount-wrap">
            <input type="number" class="qty-input disc-amount" value="0" min="0" step="0.01"
                   onchange="discAmountChanged(this)" />
            <span class="text-muted">₨</span>
          </div>
        </td>

        <td>₨0.00</td>
        <td id="salePrice-${codeSafe}">₨${Number(originalPrice).toFixed(2)}</td>
        <td><button class="delete-row-btn" onclick="deleteRow(this)"><i class="bi bi-trash3"></i></button></td>`;

        tb.appendChild(row);

        const priceCell = row.querySelector('.price-cell');
        const qtyInput = row.querySelector('.qty-main');

        const discPercentEl = row.querySelector('.disc-percent');
        const discAmountEl = row.querySelector('.disc-amount');

        priceCell.addEventListener('dblclick', () => { makePriceEditable(priceCell); selectAllContent(priceCell); priceCell.focus(); });

        priceCell.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); savePrice(priceCell); qtyInput?.focus(); qtyInput?.select(); }
            else if (e.key === 'Escape') {
                e.preventDefault();
                const orig = priceCell.dataset.originalPrice;
                priceCell.textContent = `₨${parseFloat(orig || 0).toFixed(2)}`;
                savePrice(priceCell);
                focusBarcode();
            }
        });
        priceCell.addEventListener('blur', () => { if (priceCell.isContentEditable) savePrice(priceCell); });

        qtyInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (itemDiscMode === 'amount') { discAmountEl?.focus(); discAmountEl?.select?.(); }
                else { discPercentEl?.focus(); discPercentEl?.select?.(); }
            }
        });

        discPercentEl?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); focusBarcode(); } });
        discAmountEl?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); focusBarcode(); } });

        updateRowTotal(row);
        postAddFocus(row);
        recalculateTotals();
    }

    function discPercentChanged(inp) {
        inp.value = clamp(inp.value, 0, 100);
        const row = inp.closest('tr');
        updateRowTotal(row);
        recalculateTotals();
    }

    function discAmountChanged(inp) {
        let v = parseFloat(inp.value) || 0;
        if (v < 0) v = 0;
        inp.value = v;
        const row = inp.closest('tr');
        updateRowTotal(row);
        recalculateTotals();
    }

    function updateRowTotal(row) {
        if (!row) return;

        const p = parseFloat(row.querySelector('.price-cell')?.textContent.replace(/[₨,]/g, '')) || 0;
        const q = parseFloat(row.querySelector('.qty-main')?.value || 0) || 0;

        const gross = p * q;

        let discAmt = 0;
        if (itemDiscMode === 'percent') {
            const dp = clamp(row.querySelector('.disc-percent')?.value || 0, 0, 100);
            discAmt = gross * (dp / 100);
        } else {
            const da = Math.max(parseFloat(row.querySelector('.disc-amount')?.value || 0), 0);
            discAmt = Math.min(da, gross);
        }

        const net = Math.max(gross - discAmt, 0);

        const lineCell = row.querySelector('td[id^="salePrice-"]') || row.querySelector('td:nth-child(7)');
        if (lineCell) lineCell.textContent = `₨${net.toFixed(2)}`;
    }

    function qtyInputChanged(input) {
        const row = input.closest('tr');
        updateRowTotal(row);
        recalculateTotals();
    }

    function changeQty(btn, d) {
        const inp = btn.parentNode.querySelector('.qty-main');
        let v = parseFloat(inp.value || 1);
        v = Math.max(1, v + d);
        inp.value = v;
        qtyInputChanged(inp);
    }

    function deleteRow(btn) {
        btn.closest('tr').remove();
        const tb = document.querySelector('#salesTable tbody');
        if (tb.rows.length === 0) {
            const tr = document.createElement('tr'); tr.id = 'noDataRow';
            tr.innerHTML = `<td colspan="8" class="text-center text-muted py-4">No items added yet</td>`;
            tb.appendChild(tr);
        }
        recalculateTotals();
    }

    /* -------- TOTALS -------- */
    function recalculateTotals() {
        const rows = [...document.querySelectorAll('#salesTable tbody tr')].filter(r => r.id !== 'noDataRow');

        if (!rows.length) {
            document.querySelector('.gpos-total').innerText = '₨0.00';
            document.querySelector('.gpos-items').innerText = '0';
            document.querySelector('.gpos-quantity').innerText = '0';
            document.querySelector('.gpos-tax').innerText = '₨0.00';
            document.querySelector('.gpos-grand-value').innerText = '₨0.00';
            document.getElementById('invoiceDiscountComputed').innerText = '₨0.00';
            document.getElementById('sumPayable').innerText = '0.00';
            return;
        }

        let subNet = 0, qtySum = 0, lineDiscTotal = 0;

        rows.forEach(r => {
            const p = parseFloat(r.querySelector('.price-cell')?.textContent.replace(/[₨,]/g, '')) || 0;
            const q = parseFloat(r.querySelector('.qty-main')?.value || 0) || 0;

            const gross = p * q;

            let discAmt = 0;
            if (itemDiscMode === 'percent') {
                const dp = clamp(r.querySelector('.disc-percent')?.value || 0, 0, 100);
                discAmt = gross * (dp / 100);
            } else {
                const da = Math.max(parseFloat(r.querySelector('.disc-amount')?.value || 0), 0);
                discAmt = Math.min(da, gross);
            }

            const net = Math.max(gross - discAmt, 0);

            const lineCell = r.querySelector('td[id^="salePrice-"]') || r.querySelector('td:nth-child(7)');
            if (lineCell) lineCell.textContent = `₨${net.toFixed(2)}`;

            subNet += net;
            lineDiscTotal += discAmt;
            qtySum += q;
        });

        const discP = clamp(invoiceDiscountPercentEl?.value || 0, 0, 100);
        const discL = Math.max(parseFloat(invoiceDiscountAmountEl?.value || 0), 0);

        const invDiscFromP = subNet * (discP / 100);
        const invDisc = Math.min(invDiscFromP + discL, subNet);

        const taxable = Math.max(subNet - invDisc, 0);
        const tax = TAX_PERCENT > 0 ? taxable * (TAX_PERCENT / 100) : 0;
        const grand = taxable + tax;

        const totalDiscountShown = lineDiscTotal + invDisc;

        document.querySelector('.gpos-total').innerText = money(subNet);
        document.querySelector('.gpos-items').innerText = qtySum;
        document.querySelector('.gpos-quantity').innerText = rows.length;
        document.querySelector('.gpos-tax').innerText = money(tax);
        document.getElementById('invoiceDiscountComputed').innerText = money(totalDiscountShown);
        document.querySelector('.gpos-grand-value').innerText = money(grand);
        document.getElementById('sumPayable').innerText = grand.toFixed(2);
    }

    /* -------- CUSTOMER -------- */
    function toggleCustomerType() {
        const walkin = document.getElementById("walkinRadio").checked;
        document.getElementById("walkinBlock").style.display = walkin ? "block" : "none";
        document.getElementById("customerBlock").style.display = walkin ? "none" : "block";
        if (walkin) clearCustomer();
    }

    function setSelectedCustomer(sel) {
        const opt = sel.options[sel.selectedIndex];
        if (!opt.value) { clearCustomer(); return; }

        const id = parseInt(opt.getAttribute('data-id') || "0", 10);
        const pays = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(customerPayments));
        const forCust = pays.filter(p => p.CustomerId === id);

        document.getElementById("selectedCustomerBlock").style.display = "block";
        document.getElementById("customerBalance").innerText = "₨" + (forCust[0]?.Remaining || "0");
        document.getElementById("selectedCustomerId").value = parseInt(opt.value) || 0;
    }

    function clearCustomer() {
        const dd = document.getElementById("customerDropdown");
        if (dd) dd.selectedIndex = 0;
        document.getElementById("selectedCustomerBlock").style.display = "none";
        document.getElementById("selectedCustomerId").value = "";
    }

    /* -------- PAYMENT METHOD -------- */
    function setPaymentMethod(val) {
        const sel = document.getElementById('paymentMethod');
        if (sel) sel.value = val;

        document.querySelectorAll('#paymentPills .method-pill').forEach(x => x.classList.remove('active'));
        const pill = document.querySelector(`#paymentPills .method-pill[data-value="${val}"]`);
        pill?.classList.add('active');
    }

    /* -------- PAYMENT MODAL -------- */
    function openTenderModal(_, actionFn) {
        if (!hasLineItems()) return toast('Please add at least one item', 'warning');
        pendingAction = actionFn;

        const overlay = document.getElementById('paymentModalOverlay');
        overlay.style.display = 'flex';

        document.getElementById('btnPayConfirm').textContent = (actionFn === handleSaveOnly ? 'Confirm (Save)' : 'Confirm & Print');

        const method = document.getElementById('paymentMethod')?.value || 'cash';
        const iconMap = { cash: 'bi-cash', credit: 'bi-journal-text', credit_card: 'bi-credit-card', bank: 'bi-bank', online: 'bi-wifi' };
        const labelMap = { cash: 'Cash', credit: 'Credit', credit_card: 'Card', bank: 'Bank', online: 'Online' };
        document.getElementById('modalMethod').innerHTML = `<i class="bi ${iconMap[method] || 'bi-cash'}"></i> ${labelMap[method] || method}`;

        const grand = parseFloat(document.querySelector('.gpos-grand-value').textContent.replace(/[₨,]/g, '')) || 0;
        const tax = parseFloat(document.getElementById('sumTax')?.textContent?.replace(/[₨,]/g, '') || 0) || 0;
        const disc = parseFloat(document.getElementById('invoiceDiscountComputed').textContent.replace(/[₨,]/g, '')) || 0;

        document.getElementById('tenderGrandTotal').innerText = grand.toFixed(2);
        document.getElementById('rowDiscount').style.display = disc > 0 ? 'flex' : 'none';
        document.getElementById('tenderDiscount').innerText = disc.toFixed(2);
        document.getElementById('rowTax').style.display = tax > 0 ? 'flex' : 'none';
        document.getElementById('tenderTax').innerText = tax.toFixed(2);

        const ti = document.getElementById('tenderInput');
        ti.value = '';
        ti.focus();
        updateChange();
    }

    function closePaymentModal() {
        document.getElementById('paymentModalOverlay').style.display = 'none';
        focusBarcode();
    }

    function updateChange() {
        const tendered = parseFloat(document.getElementById('tenderInput').value) || 0;
        const grand = parseFloat(document.getElementById('tenderGrandTotal').innerText) || 0;
        const change = tendered - grand;
        document.getElementById('modalRemaining').textContent = (change < 0 ? Math.abs(change) : 0).toFixed(2);
        document.getElementById('tenderChangeText').textContent = (change > 0 ? change : 0).toFixed(2);
    }

    function handleTenderOk() {
        const tendered = parseFloat(document.getElementById('tenderInput').value) || 0;
        if (tendered < 0) {
            Swal.fire({ icon: 'warning', title: 'Invalid Amount', text: 'Tendered amount cannot be negative!', target: getToastTarget() });
            return;
        }
        if (typeof pendingAction === "function") { pendingAction(); pendingAction = null; }
        closePaymentModal();
    }

    /* -------- SAVE / PRINT -------- */
    async function handleSavePrint() { await saveSaleCommon(true); }
    async function handleSaveOnly() { await saveSaleCommon(false); }

    async function saveSaleCommon(printAfter) {
        const grand = parseFloat(document.querySelector('.gpos-grand-value')?.textContent.replace(/[₨,]/g, '') || 0);
        let cust = parseInt(document.getElementById("selectedCustomerId")?.value) || 0;
        let tender = parseFloat(document.getElementById("tenderInput")?.value) || 0;

        const subtotal = parseFloat(document.querySelector('.gpos-total')?.textContent.replace(/[₨,]/g, '') || 0);
        const percent = Math.max(parseFloat(invoiceDiscountPercentEl?.value || 0), 0);
        const less = Math.max(parseFloat(invoiceDiscountAmountEl?.value || 0), 0);
        const discFromP = subtotal * (percent / 100);
        const totalDisc = Math.min(discFromP + less, subtotal);

        let saleData = {
            InvoiceNumber: document.getElementById('invoiceNoValue').textContent,
            SubTotal: subtotal,
            Tax: parseFloat(document.querySelector('.gpos-tax')?.textContent.replace(/[₨,]/g, '') || 0),
            Discount: totalDisc,
            DiscountPercent: percent,
            DiscountLessAmount: less,
            SaleType: getSelectedSaleType(),
            Total: grand,
            custId: cust,
            tender_amount: tender,
            Payment: { Amount: tender, PaymentMethod: document.getElementById('paymentMethod')?.value, Change: Math.max(tender - grand, 0) },
            SaleItems: getSaleItemsFromTable()
        };

        if (!saleData.SaleItems || saleData.SaleItems.length === 0) {
            Swal.fire({ icon: 'warning', title: 'No Items Selected', text: 'Please select at least one item before proceeding!', target: getToastTarget() });
            return;
        }

        saleData = cleanSaleData(saleData);

        try {
            const endpoint = printAfter ? '/Sales/SaveSale' : '/Sales/SaveOnly';
            const token = getAntiForgeryToken();

            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token   // ✅ CSRF FIX (works with ValidateAntiForgeryToken)
                },
                body: JSON.stringify(saleData)
            });

            const rsp = await readResponseSmart(res);

            // ❌ HTTP error
            if (!res.ok) {
                // If server actually returned JSON error {Message:"..."}
                if (rsp.json && (rsp.json.Message || rsp.json.message)) {
                    toast(rsp.json.Message || rsp.json.message, 'error', 2500);
                    return;
                }
                // otherwise show raw response (HTML/stack trace etc)
                showServerError(`Save Failed (HTTP ${res.status})`, rsp.text || 'No response body');
                return;
            }

            // ✅ OK but response might be HTML/redirect -> not JSON
            const result = rsp.json;
            if (!result || typeof result !== 'object') {
                showServerError('Saved/OK but response is not JSON', `Content-Type: ${rsp.ct}\n\n${rsp.text}`);
                return;
            }

            toast(result.Message || 'Saved', 'success', 1000);

            if (printAfter && result?.id) {
                window.open(`/Sales/Receipt/${result.id}`, '_blank');
            }

            handleNewInvoice();

        } catch (e) {
            console.error(e);
            showServerError('JS/Network Error', (e && e.message) ? e.message : String(e));
        }
    }

    function getSelectedSaleType() {
        const s = document.querySelector('input[name="SaleType"]:checked');
        return s ? s.value : null;
    }

    function getSaleItemsFromTable() {
        const rows = document.querySelectorAll('#salesTable tbody tr');
        const arr = [];

        rows.forEach(r => {
            if (r.id === 'noDataRow') return;

            const priceCell = r.querySelector('.price-cell');
            const qtyInput = r.querySelector('input.qty-input.qty-main');

            const lineTd =
                r.querySelector('td.line-total') ||
                r.querySelector('td[id^="salePrice-"]') ||
                r.querySelector('td:nth-child(7)');

            const unitPrice = parseFloat((priceCell?.textContent || "0").replace(/[₨,]/g, '')) || 0;
            const qty = parseFloat(qtyInput?.value || 0) || 0;
            const gross = unitPrice * qty;

            const discP = parseFloat(r.querySelector('.disc-percent')?.value || 0) || 0;
            const discA = parseFloat(r.querySelector('.disc-amount')?.value || 0) || 0;

            let finalDiscPercent = 0;
            let finalDiscAmount = 0;

            if (itemDiscMode === 'percent') {
                finalDiscPercent = clamp(discP, 0, 100);
                finalDiscAmount = gross * (finalDiscPercent / 100);
            } else {
                finalDiscAmount = Math.min(Math.max(discA, 0), gross);
                finalDiscPercent = gross > 0 ? (finalDiscAmount / gross) * 100 : 0;
            }

            arr.push({
                ItemId: parseInt(r.dataset.itemId),
                Quantity: qty,
                UnitPrice: unitPrice,
                DiscountPercent: finalDiscPercent,
                DiscountAmount: finalDiscAmount,
                TaxAmount: 0,
                LineTotal: parseFloat((lineTd?.textContent || "0").replace(/[₨,]/g, '')) || 0
            });
        });

        return arr;
    }

    function cleanSaleData(sd) {
        if (sd.Payment) delete sd.Payment.Id;
        (sd.SaleItems || []).forEach(i => delete i.Id);
        delete sd.Id;
        return sd;
    }

    /* -------- HOLD / RETRIEVE (localStorage) -------- */
    const HOLD_KEY = 'gposHeldInvoices';

    function getAllHeld() { try { return JSON.parse(localStorage.getItem(HOLD_KEY) || '[]'); } catch { return []; } }
    function saveAllHeld(list) { localStorage.setItem(HOLD_KEY, JSON.stringify(list)); }

    function cryptoRandomId() {
        try { return [...crypto.getRandomValues(new Uint8Array(8))].map(x => x.toString(16).padStart(2, '0')).join(''); }
        catch { return String(Date.now()); }
    }

    function holdCurrentInvoice() {
        if (!hasLineItems()) return toast('No items to hold', 'warning');

        const itemsArr = getSaleItemsFromTable();
        const invoiceNumber = document.getElementById('invoiceNoValue').textContent;

        const sub = parseFloat(document.querySelector('.gpos-total').textContent.replace(/[₨,]/g, '')) || 0;
        const tax = parseFloat(document.getElementById('sumTax')?.textContent?.replace(/[₨,]/g, '') || 0) || 0;
        const grand = parseFloat(document.querySelector('.gpos-grand-value').textContent.replace(/[₨,]/g, '')) || 0;

        const invDiscPercent = clamp(invoiceDiscountPercentEl?.value || 0, 0, 100);
        const invDiscLess = Math.max(parseFloat(invoiceDiscountAmountEl?.value || 0), 0);
        const invDiscFromP = sub * (invDiscPercent / 100);
        const invDisc = Math.min(invDiscFromP + invDiscLess, sub);

        const held = {
            id: cryptoRandomId(),
            invoiceNumber,
            items: itemsArr,
            subTotal: sub,
            discount: invDisc,
            discountPercent: invDiscPercent,
            discountLessAmount: invDiscLess,
            tax: tax,
            grandTotal: grand,
            saleType: getSelectedSaleType(),
            itemDiscMode: itemDiscMode,
            heldAt: nowIso()
        };

        const list = getAllHeld();
        list.unshift(held);
        saveAllHeld(list);
        toast('Invoice held', 'success', 1200);
        handleNewInvoice();
    }

    function openRetrieveModal() {
        document.getElementById('retrieveOverlay').style.display = 'flex';
        renderHeldTable();
        document.getElementById('holdSearch').focus();
    }
    function closeRetrieveModal() { document.getElementById('retrieveOverlay').style.display = 'none'; }

    function renderHeldTable() {
        const tbody = document.getElementById('heldTbody');
        tbody.innerHTML = '';

        const list = getAllHeld();
        const q = (document.getElementById('holdSearch').value || '').trim().toLowerCase();
        const view = list.filter(h => !q || (h.invoiceNumber || '').toLowerCase().includes(q));

        document.getElementById('noHeldRow').style.display = view.length ? 'none' : 'block';

        view.forEach(h => {
            const previewNames = (h.items || [])
                .slice(0, 3)
                .map(it => {
                    const meta = (items || []).find(x => x.Id === it.ItemId);
                    return meta?.ItemName || it.ItemName || (`Item#${it.ItemId}`);
                })
                .join(', ');

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><span class="badge text-bg-light">${h.invoiceNumber}</span></td>
              <td>${h.items?.length || 0}</td>
              <td>${previewNames || '—'}</td>
              <td><strong>${money(h.grandTotal || 0)}</strong></td>
              <td>${new Date(h.heldAt).toLocaleString()}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-soft-green me-1" onclick="retrieveInvoice('${h.id}')">
                  <i class="bi bi-pencil-square"></i> Edit
                </button>
                <button class="btn btn-sm btn-soft-amber" onclick="deleteHeld('${h.id}')">
                  <i class="bi bi-trash3"></i> Delete
                </button>
              </td>`;
            tbody.appendChild(tr);
        });
    }

    function deleteHeld(id) {
        let list = getAllHeld();
        list = list.filter(x => x.id !== id);
        saveAllHeld(list);
        renderHeldTable();
        toast('Held invoice deleted', 'success', 1000);
    }

    function clearAllHeld() {
        Swal.fire({
            icon: 'warning',
            title: 'Clear all held invoices?',
            showCancelButton: true,
            confirmButtonText: 'Yes, Clear',
            target: getToastTarget()
        }).then(r => {
            if (r.isConfirmed) {
                localStorage.removeItem(HOLD_KEY);
                renderHeldTable();
                toast('All cleared', 'success', 1000);
            }
        });
    }

    function sortHeld(by) {
        let list = getAllHeld();
        if (by === 'time') list.sort((a, b) => new Date(b.heldAt) - new Date(a.heldAt));
        if (by === 'grand') list.sort((a, b) => (b.grandTotal || 0) - (a.grandTotal || 0));
        saveAllHeld(list);
        renderHeldTable();
    }

    function retrieveInvoice(id) {
        const list = getAllHeld();
        const h = list.find(x => x.id === id);
        if (!h) { toast('Not found', 'error'); return; }

        if (h.itemDiscMode) setItemDiscMode(h.itemDiscMode, false);

        const tb = document.querySelector('#salesTable tbody');
        tb.innerHTML = '';

        (h.items || []).forEach((it, idx) => {
            const meta = items.find(x => x.Id === it.ItemId) || { Id: it.ItemId, ItemCode: "", ItemName: ("Item#" + it.ItemId) };

            const row = document.createElement('tr');
            row.dataset.itemId = it.ItemId;

            const codeSafe = (meta.ItemCode || ('X' + idx)).replace(/[^a-zA-Z0-9_-]/g, '');

            const discPercent = Number(it.DiscountPercent || 0);
            const discAmount = Number(it.DiscountAmount || 0);

            row.innerHTML = `
              <td>${idx + 1}</td>
              <td>${meta.ItemName || ('Item#' + it.ItemId)}</td>
              <td><span tabindex="0" class="price-cell" data-original-price="${Number(it.UnitPrice).toFixed(2)}">₨${Number(it.UnitPrice).toFixed(2)}</span></td>
              <td>
                <div class="d-inline-flex gap-1 align-items-center">
                  <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(this,-1)"><i class="bi bi-dash-lg"></i></button>
                  <input type="number" class="qty-input qty-main" value="${Number(it.Quantity)}" min="1"
                         onchange="qtyInputChanged(this)" />
                  <button class="btn btn-sm btn-outline-secondary" onclick="changeQty(this,1)"><i class="bi bi-plus-lg"></i></button>
                </div>
              </td>

              <td>
                <div class="d-inline-flex gap-1 align-items-center disc-percent-wrap">
                  <input type="number" class="qty-input disc-percent" value="${discPercent}" min="0" max="100" step="0.01"
                         onchange="discPercentChanged(this)" />
                  <span class="text-muted">%</span>
                </div>

                <div class="d-inline-flex gap-1 align-items-center disc-amount-wrap">
                  <input type="number" class="qty-input disc-amount" value="${discAmount}" min="0" step="0.01"
                         onchange="discAmountChanged(this)" />
                  <span class="text-muted">₨</span>
                </div>
              </td>

              <td>₨${Number(it.TaxAmount || 0).toFixed(2)}</td>
              <td id="salePrice-${codeSafe}">₨${Number(it.LineTotal || (it.UnitPrice * it.Quantity)).toFixed(2)}</td>
              <td><button class="delete-row-btn" onclick="deleteRow(this)"><i class="bi bi-trash3"></i></button></td>`;

            tb.appendChild(row);

            const priceCell = row.querySelector('.price-cell');
            const qtyInput = row.querySelector('.qty-main');

            priceCell.addEventListener('dblclick', () => { makePriceEditable(priceCell); selectAllContent(priceCell); priceCell.focus(); });

            priceCell.addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); savePrice(priceCell); qtyInput?.focus(); qtyInput?.select(); }
                else if (e.key === 'Escape') { e.preventDefault(); const orig = priceCell.dataset.originalPrice; priceCell.textContent = `₨${parseFloat(orig || 0).toFixed(2)}`; savePrice(priceCell); focusBarcode(); }
            });
            priceCell.addEventListener('blur', () => { if (priceCell.isContentEditable) savePrice(priceCell); });

            const discPercentEl = row.querySelector('.disc-percent');
            const discAmountEl = row.querySelector('.disc-amount');

            qtyInput.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (itemDiscMode === 'amount') { discAmountEl?.focus(); discAmountEl?.select?.(); }
                    else { discPercentEl?.focus(); discPercentEl?.select?.(); }
                }
            });

            discPercentEl?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); focusBarcode(); } });
            discAmountEl?.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); focusBarcode(); } });

            updateRowTotal(row);
        });

        invoiceDiscountPercentEl.value = String(h.discountPercent ?? 0);
        invoiceDiscountAmountEl.value = String(h.discountLessAmount ?? 0);

        if (h.saleType === 'Return') document.getElementById('rbReturn').checked = true;
        else document.getElementById('rbSale').checked = true;

        applySaleTypeVisual();
        recalculateTotals();

        saveAllHeld(list.filter(x => x.id !== id));
        closeRetrieveModal();
        toast('Invoice retrieved', 'success', 1000);

        postAddFocus(document.querySelector('#salesTable tbody tr:last-child'));
    }

    /* -------- NEW INVOICE -------- */
    function handleNewInvoice() {
        const tb = document.querySelector('#salesTable tbody');
        tb.innerHTML = `<tr id="noDataRow"><td colspan="8" class="text-center text-muted py-4">No items added yet</td></tr>`;

        invoiceDiscountPercentEl.value = '0';
        invoiceDiscountAmountEl.value = '0';

        document.querySelector('.gpos-total').innerText = '₨0.00';
        document.querySelector('.gpos-items').innerText = '0';
        document.querySelector('.gpos-quantity').innerText = '0';
        document.querySelector('.gpos-tax').innerText = '₨0.00';
        document.querySelector('.gpos-grand-value').innerText = '₨0.00';

        document.getElementById('invoiceDiscountComputed').innerText = '₨0.00';
        document.getElementById('sumPayable').innerText = '0.00';

        document.getElementById('paymentModalOverlay').style.display = 'none';

        setPaymentMethod('cash');

        document.getElementById('invoiceNoValue').innerText = generateInvoiceNumber();



        focusBarcode();
        toast('New invoice created!', 'success', 1200);
    }

    function generateInvoiceNumber() {
        const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        invoiceCounter = (parseInt(invoiceCounter) || 0) + 1;
        return `INV-${date}-${String(invoiceCounter).padStart(4, '0')}`;
    }

    function updateLiveClock() {
        const n = new Date();
        const d = n.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: '2-digit' });
        const t = n.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('liveClock').innerText = d + " | " + t;
    }

    /* -------- SHORTCUTS -------- */
    function globalKeyHandler(e) {
        const listDiv = document.getElementById('itemSuggestions');

        if (filtered.length && listDiv.style.display === 'block') {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedIdx < filtered.length - 1) selectedIdx++;
                updateHighlight();
                return;
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedIdx > 0) selectedIdx--;
                updateHighlight();
                return;
            }

            if (e.key === 'Enter') {
                if (selectedIdx === -1 && filtered.length > 0) selectedIdx = 0;
                if (selectedIdx >= 0) { e.preventDefault(); selectItemSuggestion(selectedIdx); }
                return;
            }
            if (e.key === 'Escape') { listDiv.style.display = 'none'; filtered = []; selectedIdx = -1; return; }
        }

        if (e.key === 'F2') { e.preventDefault(); e.stopPropagation(); toggleQtyMode(); return; }
        if (e.key === 'F3') { e.preventDefault(); e.stopPropagation(); togglePriceMode(); return; }

        // ✅ important: stopPropagation too (especially F5 refresh)
        if (e.key === 'F4') { e.preventDefault(); e.stopPropagation(); openTenderModal(null, handleSavePrint); return; }
        if (e.key === 'F5') { e.preventDefault(); e.stopPropagation(); openTenderModal(null, handleSaveOnly); return; }

        if (e.key === 'F8') { e.preventDefault(); e.stopPropagation(); openTenderModal(null, handleSavePrint); return; }
        if (e.key === 'F12') { e.preventDefault(); e.stopPropagation(); handleNewInvoice(); return; }

        if (e.altKey && e.key.toLowerCase() === 'enter') { e.preventDefault(); toggleFullscreen(); return; }
        if (e.altKey && e.key.toLowerCase() === 'b') { e.preventDefault(); focusBarcode(); return; }
        if (e.altKey && e.key.toLowerCase() === 'n') { e.preventDefault(); document.getElementById('btnNewItem')?.click(); return; }
        if (e.altKey && e.key.toLowerCase() === 's') { e.preventDefault(); document.getElementById('rbSale').checked = true; applySaleTypeVisual(); return; }
        if (e.altKey && e.key.toLowerCase() === 'r') { e.preventDefault(); document.getElementById('rbReturn').checked = true; applySaleTypeVisual(); return; }

        if (e.altKey && e.key.toLowerCase() === 'p') { e.preventDefault(); setItemDiscMode('percent'); return; }
        if (e.altKey && e.key.toLowerCase() === 'a') { e.preventDefault(); setItemDiscMode('amount'); return; }

        if (e.ctrlKey && e.key.toLowerCase() === 'd') {
            e.preventDefault();
            invoiceDiscountPercentEl.focus();
            invoiceDiscountPercentEl.select();
            return;
        }
    }

    /* -------- FULLSCREEN -------- */
    function isFullscreen() { return document.fullscreenElement === posShell || document.webkitFullscreenElement === posShell; }
    function enterFullscreen() { if (posShell.requestFullscreen) posShell.requestFullscreen(); else if (posShell.webkitRequestFullscreen) posShell.webkitRequestFullscreen(); }
    function exitFullscreen() { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); }
    function toggleFullscreen() { isFullscreen() ? exitFullscreen() : enterFullscreen(); }

    function handleFsChange() {
        const i = btnFullscreen?.querySelector('i');
        if (!i) return;
        if (isFullscreen()) {
            i.classList.replace('bi-arrows-fullscreen', 'bi-fullscreen-exit');
            btnFullscreen.title = "Exit Fullscreen (Alt+Enter)";
            setTimeout(() => focusBarcode(), 50);
        } else {
            i.classList.replace('bi-fullscreen-exit', 'bi-arrows-fullscreen');
            btnFullscreen.title = "Expand (Alt+Enter)";
        }
    }

    /* -------- INIT -------- */
    document.addEventListener('DOMContentLoaded', () => {
        posShell = document.getElementById('posShell');
        btnFullscreen = document.getElementById('btnFullscreen');
        itemInputEl = document.getElementById('itemSearchInput');
        suggDiv = document.getElementById('itemSuggestions');

        invoiceDiscountPercentEl = document.getElementById('invoiceDiscountPercent');
        invoiceDiscountAmountEl = document.getElementById('invoiceDiscountAmount');

        initializeFocusMode();
        applySaleTypeVisual();

        setItemDiscMode('percent', false);
        const select = document.getElementById("paymentMethod");
        const selectedOption = select.options[select.selectedIndex];

        setPaymentMethod(selectedOption.value);
        attachScannerHandlers();

        document.getElementById('rbSale')?.addEventListener('change', applySaleTypeVisual);
        document.getElementById('rbReturn')?.addEventListener('change', applySaleTypeVisual);
        document.querySelectorAll('.form-check-input.saletype').forEach(r => r.addEventListener('click', applySaleTypeVisual));

        document.querySelectorAll('#paymentPills .method-pill').forEach(p => {
            p.addEventListener('click', () => setPaymentMethod(p.getAttribute('data-value')));
        });

        document.getElementById('btnHold')?.addEventListener('click', holdCurrentInvoice);
        document.getElementById('btnRetrieveHeld')?.addEventListener('click', openRetrieveModal);

        document.getElementById('new-btn')?.addEventListener('click', handleNewInvoice);

        document.querySelector('.saveprint-btn')?.addEventListener('click', () => openTenderModal(null, handleSavePrint));
        document.querySelector('.saveonly-btn')?.addEventListener('click', () => openTenderModal(null, handleSaveOnly));
        document.getElementById('tenderOkBtn')?.addEventListener('click', handleTenderOk);
        document.getElementById('print-btn')?.addEventListener('click', () => openTenderModal(null, handleSavePrint));

        document.getElementById('tenderInput')?.addEventListener('input', updateChange);
        document.getElementById('tenderInput')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleTenderOk(); } });
        document.getElementById('paymentModalCard')?.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleTenderOk(); } });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('paymentModalOverlay').style.display === 'flex') {
                e.preventDefault();
                closePaymentModal();
            }
        });

        document.getElementById('holdSearch')?.addEventListener('input', renderHeldTable);

        invoiceDiscountPercentEl?.addEventListener('input', () => {
            let v = parseFloat(invoiceDiscountPercentEl.value) || 0;
            if (v < 0) v = 0; if (v > 100) v = 100;
            invoiceDiscountPercentEl.value = v;
            recalculateTotals();
        });

        invoiceDiscountAmountEl?.addEventListener('input', () => {
            let v = parseFloat(invoiceDiscountAmountEl.value) || 0;
            if (v < 0) v = 0;
            invoiceDiscountAmountEl.value = v;
            recalculateTotals();
        });

        btnFullscreen?.addEventListener('click', toggleFullscreen);
        document.addEventListener('fullscreenchange', handleFsChange);
        document.addEventListener('webkitfullscreenchange', handleFsChange);

        // ✅ capture = true so F5 refresh block works everywhere
        window.addEventListener('keydown', globalKeyHandler, true);

        document.getElementById('invoiceNoValue').innerText = generateInvoiceNumber();

        updateLiveClock();
        setInterval(updateLiveClock, 1000);

        recalculateTotals();
        setTimeout(() => focusBarcode(), 50);
    });
</script>

<script>
    const invoiceNo = '@((searchSale)?.InvoiceNumber ?? "")';

        if (invoiceNo !== "") {
            document.getElementById("invoiceNoValue").textContent = invoiceNo;
        }

        const saleType = '@((searchSale)?.SaleType ?? "Sale")';

        if (saleType === "Return") {
            document.getElementById("rbReturn").checked = true;
        } else {
            document.getElementById("rbSale").checked = true;
        }


    function setSelectedCustomer(select) {
        const customerId = select.value;

        if (!customerId) return;

        document.getElementById("selectedCustomerId").value = customerId;

        document.getElementById("customerBalance").textContent = '@(searchSale?.Customers?.OpeningBalance)';
    }

    const hasCustomer = @((searchSale?.Customers != null).ToString().ToLower());
    const selectedCustomerId = '@(searchSale?.Customers?.Id)';

    if (hasCustomer) {
        // Select Registered
        document.getElementById("customerRadio").checked = true;
        document.getElementById("walkinRadio").checked = false;

        // Show customer block
        document.getElementById("customerBlock").style.display = "block";

        // Set dropdown value
        const ddl = document.getElementById("customerDropdown");
        ddl.value = selectedCustomerId;

        // Set hidden field
        document.getElementById("selectedCustomerId").value = selectedCustomerId;

        // Trigger change handler
        if (ddl.value) {
            setSelectedCustomer(ddl);
        }
    }

    const paymentMethod = '@(searchSale?.Payment?.PaymentMethod ?? "cash")';

    const select = document.getElementById("paymentMethod");

    // Remove selected from all options
    Array.from(select.options).forEach(opt => opt.selected = false);

    // Select matching option
    const match = Array.from(select.options)
        .find(opt => opt.value === paymentMethod.toLowerCase());

    if (match) {
        match.selected = true;
    }


    const pills = document.querySelectorAll("#paymentPills .method-pill");

    pills.forEach(pill => {
        pill.classList.remove("active");

        if (pill.dataset.value === paymentMethod.toLowerCase()) {

            pill.classList.add("active");
        }
    });

</script>

