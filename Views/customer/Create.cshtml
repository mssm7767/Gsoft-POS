@model GSoftPosNew.Models.Customer
@using System.Collections.Generic
@using GSoftPosNew.Models

@{
    ViewData["Title"] = "Add / Edit Customer";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var isEdit = Model != null && Model.Id > 0;
    var customers = ViewBag.CustomerList as List<GSoftPosNew.Models.Customer> ?? new List<GSoftPosNew.Models.Customer>();
}

<link href="~/css/customer.css" rel="stylesheet" asp-append-version="true" />

<!-- ✅ Center success toast (1 second) -->
@if (TempData["Success"] != null)
{
    <div id="successToast" class="sms-message sms-success">
        <i class="fa fa-check-circle me-2"></i> @TempData["Success"]
    </div>
}
@if (TempData["DeleteSuccess"] != null)
{
    <div id="deleteToast" class="sms-message sms-danger">
        <i class="fa fa-trash-alt me-2"></i> @TempData["DeleteSuccess"]
    </div>
}

<!-- Error toast -->
@if (TempData["Error"] != null)
{
    <div id="errorToast" class="sms-message sms-error">
        <i class="fa fa-times-circle me-2"></i>
        @TempData["Error"]
    </div>
}

<!-- Breadcrumb Bar -->
<div class="breadcrumb-bar d-flex align-items-center mb-3 p-3 rounded shadow-sm"
     style="background: linear-gradient(90deg,#17408d 40%,#68eacc 100%);">
    <a asp-controller="Dashboard" asp-action="Index"
       class="breadcrumb-link text-white fw-semibold me-2" style="text-decoration:none;">
        <i class="fa fa-arrow-left me-2"></i> Dashboard
    </a>
    <i class="fa fa-chevron-right mx-2 separator-icon text-white-50"></i>
    <h4 class="breadcrumb-title m-0 text-white">@ViewData["Title"]</h4>
</div>

<div class="container-fluid py-3">
    <div class="row g-3">

        <!-- LEFT: ADD / EDIT CUSTOMER (THODA CHHOTA) -->
        <div class="col-12 col-lg-5 col-xl-5">
            <div class="form-card h-100">
                <div class="form-card-header">
                    <i class="fa fa-user-plus fa-lg"></i>
                    <span>@(isEdit ? "Edit Customer" : "Add New Customer")</span>
                </div>

                <div class="pt-3">
                    @using (Html.BeginForm(isEdit ? "Edit" : "Create",
                                        "Customer",
                                        FormMethod.Post,
                                        new { enctype = "multipart/form-data" }))
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(m => m.Id)

                        <!-- ✅ Validation summary -->
                        @Html.ValidationSummary(true, "", new { @class = "text-danger mb-2" })

                        <div class="row g-3">
                            <!-- Customer Name -->
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fa fa-user text-primary me-1"></i>Customer Name *
                                </label>
                                @Html.TextBoxFor(m => m.CustomerName, new { @class = "form-control", placeholder = "Full name", id = "CustomerName" })
                                @Html.ValidationMessageFor(m => m.CustomerName, "", new { @class = "text-danger" })
                            </div>

                            <!-- Father Name -->
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fa fa-user-friends text-info me-1"></i>Father Name (optional)
                                </label>
                                @Html.TextBoxFor(m => m.FatherName, new { @class = "form-control", placeholder = "Father/Guardian name" })
                            </div>

                            <!-- NIC -->
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fa fa-id-card text-success me-1"></i>NIC (optional)
                                </label>
                                @Html.TextBoxFor(m => m.NIC, new { @class = "form-control", placeholder = "NIC / CNIC" })
                            </div>

                            <!-- Contact Number -->
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fa fa-phone text-warning me-1"></i>Contact Number *
                                </label>
                                @Html.TextBoxFor(m => m.ContactNumber, new { @class = "form-control", placeholder = "03xx-xxxxxxx" })
                                @Html.ValidationMessageFor(m => m.ContactNumber, "", new { @class = "text-danger" })
                            </div>

                            <!-- Opening Balance -->
                            <div class="col-md-4">
                                <label class="form-label">
                                    <i class="fa fa-wallet text-primary me-1"></i>Opening Balance (optional)
                                </label>
                                @Html.TextBoxFor(m => m.OpeningBalance,
                                new { @class = "form-control", type = "number", step = "0.01", placeholder = "0.00" })
                        </div>

                        <!-- Address 1 -->
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fa fa-map-marker-alt text-danger me-1"></i>Address Line 1 *
                            </label>
                            @Html.TextAreaFor(m => m.Address1,
                                                        new { @class = "form-control", rows = 2, placeholder = "Street, City" })
                            @Html.ValidationMessageFor(m => m.Address1, "", new { @class = "text-danger" })
                        </div>

                        <!-- Address 2 -->
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fa fa-map-marked-alt text-success me-1"></i>Address Line 2 (optional)
                            </label>
                            @Html.TextAreaFor(m => m.Address2,
                                                        new { @class = "form-control", rows = 2, placeholder = "Apartment, Landmark" })
                        </div>

                        <!-- Email -->
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fa fa-envelope text-warning me-1"></i>Email (optional)
                            </label>
                            @Html.TextBoxFor(m => m.Email,
                                                        new { @class = "form-control", type = "email", placeholder = "name@example.com" })
                        </div>

                        <!-- Website -->
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fa fa-globe text-info me-1"></i>Website (optional)
                            </label>
                            @Html.TextBoxFor(m => m.Website,
                                                        new { @class = "form-control", placeholder = "https://example.com" })
                        </div>

                        <!-- Username -->
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fa fa-user text-primary me-1"></i> User Name (optional)
                            </label>
                            @Html.TextBoxFor(m => m.UserName,
                                                        new { @class = "form-control", placeholder = "Enter username" })
                        </div>

                        <!-- Password -->
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fa fa-lock text-danger me-1"></i> Password (optional)
                            </label>
                            @Html.PasswordFor(m => m.Password,
                                                        new { @class = "form-control", placeholder = "Enter password" })
                        </div>
                    </div>

                    <!-- Picture upload -->
                    <div class="mt-3">
                        <label class="btn btn-outline-primary rounded-pill px-4 shadow-sm">
                            <i class="fa fa-image me-1"></i> Upload Picture (optional)
                            <input type="file" name="PictureFile" accept=".jpg,.jpeg,.png" hidden />
                        </label>
                    </div>

                    <!-- Buttons -->
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div>
                            <a class="btn btn-light border rounded-pill shadow-sm"
                               title="Clear form"
                               href="@Url.Action("Create", "Customer")">
                                <i class="fa fa-broom me-1"></i> Clear Form
                            </a>
                        </div>
                        <div class="text-end">
                            @if (isEdit)
                                {
                                    <button type="submit" class="btn btn-success btn-lg rounded-pill shadow me-2">
                                        <i class="fa fa-save me-1"></i> Update Customer
                                    </button>
                                    <a class="btn btn-secondary btn-lg rounded-pill shadow me-2"
                                       href="@Url.Action("Create", "Customer")">
                                        <i class="fa fa-times me-1"></i> Cancel
                                    </a>
                                }
                                else
                                {
                                    <button type="submit" class="btn btn-success btn-lg rounded-pill shadow me-2">
                                        <i class="fa fa-save me-1"></i> Save Customer
                                    </button>
                                    <button type="button" class="btn btn-warning btn-lg rounded-pill shadow me-2" disabled>
                                        <i class="fa fa-edit me-1"></i> Edit
                                    </button>
                                }
                                <button type="button" class="btn btn-info btn-lg rounded-pill shadow"
                                        onclick="window.print();">
                                    <i class="fa fa-print me-1"></i> Print
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- RIGHT: CUSTOMER LIST (THODA BARA) -->
        <div class="col-12 col-lg-7 col-xl-7">
            <div class="list-card h-100">
                <div class="form-card-header" style="background: linear-gradient(92deg, #474bff 60%, #38e4ae 100%);">
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="fa fa-list fa-lg me-2"></i>
                        <span class="fw-bold">All Customers</span>
                    </div>

                    <!-- Search (WIDTH ZIADA) -->
                    <div class="ms-auto" style="min-width:280px; max-width:380px; width:100%;">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-white">
                                <i class="fa fa-search"></i>
                            </span>
                            <input id="customerSearch" type="text" class="form-control"
                                   placeholder="Search name / contact / address">
                            <button id="clearSearch" type="button"
                                    class="btn btn-outline-light border-0 ms-1" title="Clear">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pt-3">
                    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
                        <table class="table table-striped mb-0 align-middle" id="customersTable" tabindex="0">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Father</th>
                                    <th>NIC</th>
                                    <th>Contact</th>
                                    <th>Balance</th>
                                    <th class="text-end" style="width:120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (customers.Any())
                                {
                                    foreach (var c in customers)
                                    {
                                        var editUrl = Url.Action("Edit", "Customer", new { id = c.Id });
                                        <tr data-id="@c.Id"
                                            data-edit-url="@editUrl"
                                            data-customer-name="@c.CustomerName"
                                            data-customer-contact="@c.ContactNumber"
                                            data-customer-address="@c.Address1">
                                            <td>@c.CustomerName</td>
                                            <td>@c.FatherName</td>
                                            <td>@c.NIC</td>
                                            <td>@c.ContactNumber</td>
                                            <td>@c.OpeningBalance</td>
                                            <td class="text-end">
                                                <!-- Edit -->
                                                <a class="btn btn-sm btn-outline-primary me-1"
                                                   title="Edit" href="@editUrl">
                                                    <i class="fa fa-pen"></i>
                                                </a>

                                                <!-- Delete -->
                                                <form method="post"
                                                      action="@Url.Action("Delete","Customer", new { id = c.Id })"
                                                      class="d-inline"
                                                      onsubmit="return confirm('Delete this customer: @c.CustomerName ?');">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit"
                                                            class="btn btn-sm btn-outline-danger" title="Delete">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">No customers found.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            /* ===== Focus on CustomerName ===== */
            const nameInput = document.getElementById('CustomerName');
            if (nameInput) {
                nameInput.focus();
                if (nameInput.select) nameInput.select();
            }

            /* ===== Center toasts (Success / Delete / Error) ===== */
            const successToast = document.getElementById('successToast');
            const deleteToast = document.getElementById('deleteToast');
            const errorToast = document.getElementById('errorToast');

            if (successToast) {
                setTimeout(() => {
                    successToast.classList.add('hide');
                    setTimeout(() => {
                        successToast.style.display = 'none';
                        if (nameInput) {
                            nameInput.focus();
                            if (nameInput.select) nameInput.select();
                        }
                    }, 300);
                }, 1000); // 1 second
            }

            if (deleteToast) {
                setTimeout(() => {
                    deleteToast.classList.add('hide');
                    setTimeout(() => {
                        deleteToast.style.display = 'none';
                        if (nameInput) {
                            nameInput.focus();
                            if (nameInput.select) nameInput.select();
                        }
                    }, 300);
                }, 1000);
            }

            if (errorToast) {
                setTimeout(() => {
                    errorToast.classList.add('hide');
                    setTimeout(() => {
                        if (errorToast && errorToast.parentNode) {
                            errorToast.parentNode.removeChild(errorToast);
                        }
                    }, 400);
                }, 1500);
            }

            /* ===== LIVE SEARCH + KEYBOARD NAV ===== */
            var search = document.getElementById('customerSearch');
            var clearBtn = document.getElementById('clearSearch');
            var table = document.getElementById('customersTable');
            var tbody = table ? table.querySelector('tbody') : null;

            function allRows() {
                return Array.from(document.querySelectorAll('#customersTable tbody tr'));
            }
            function visibleRows() {
                return allRows().filter(function (r) { return r.style.display !== 'none'; });
            }
            function getSelectedIndex() {
                var rowsV = visibleRows();
                var sel = document.querySelector('#customersTable tbody tr.row-selected');
                return sel ? rowsV.indexOf(sel) : -1;
            }
            function clearSelection() {
                allRows().forEach(function (r) { r.classList.remove('row-selected'); });
            }
            function selectRow(row) {
                if (!row || row.style.display === 'none') return;
                clearSelection();
                row.classList.add('row-selected');
                row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            function selectByIndex(idx) {
                var rowsV = visibleRows();
                if (!rowsV.length) return;
                if (idx < 0) idx = 0;
                if (idx >= rowsV.length) idx = rowsV.length - 1;
                selectRow(rowsV[idx]);
            }
            function openEditSelected() {
                var sel = document.querySelector('#customersTable tbody tr.row-selected');
                if (sel && sel.dataset.editUrl) window.location = sel.dataset.editUrl;
            }

            function applyFilter() {
                var q = (search && search.value || '').toLowerCase().trim();
                allRows().forEach(function (r) {
                    var text = (
                        (r.dataset.customerName || '') + ' ' +
                        (r.dataset.customerContact || '') + ' ' +
                        (r.dataset.customerAddress || '')
                    ).toLowerCase();
                    r.style.display = text.indexOf(q) >= 0 ? '' : 'none';
                    if (r.style.display === 'none') r.classList.remove('row-hover', 'row-selected');
                });
                clearSelection();
                selectByIndex(0);
            }

            if (search) search.addEventListener('input', applyFilter);
            if (clearBtn) {
                clearBtn.addEventListener('click', function () {
                    search.value = '';
                    applyFilter();
                    search.focus();
                });
            }

            if (tbody) {
                tbody.addEventListener('click', function (e) {
                    if (e.target.closest('a,button,form')) return;
                    var tr = e.target.closest('tr');
                    if (!tr || tr.parentNode !== tbody) return;
                    selectRow(tr);
                    if (table) table.focus();
                });

                tbody.addEventListener('dblclick', function (e) {
                    if (e.target.closest('a,button,form')) return;
                    var tr = e.target.closest('tr');
                    if (!tr || tr.parentNode !== tbody) return;
                    selectRow(tr);
                    openEditSelected();
                });
            }

            if (table) {
                table.setAttribute('tabindex', '0');
                setTimeout(function () {
                    table.focus();
                    selectByIndex(getSelectedIndex() === -1 ? 0 : getSelectedIndex());
                }, 50);

                table.addEventListener('keydown', function (e) {
                    var key = e.key;
                    if (key === 'ArrowDown') {
                        e.preventDefault();
                        var idx = getSelectedIndex();
                        selectByIndex(idx + 1);
                    } else if (key === 'ArrowUp') {
                        e.preventDefault();
                        var idx = getSelectedIndex();
                        selectByIndex(idx - 1);
                    } else if (key === 'Enter') {
                        e.preventDefault();
                        openEditSelected();
                    } else if (key === 'Escape') {
                        clearSelection();
                    }
                });
            }

            applyFilter();
        });
    </script>
}

<style>
    .form-card,
    .list-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 16px rgba(44, 196, 197, 0.09), 0 1.5px 4px rgba(32, 66, 102, 0.07);
        padding: 1.2rem 1.6rem;
        margin-bottom: 1rem;
    }

    .form-card-header {
        background: linear-gradient(92deg, #18608c 60%, #89f7fe 100%);
        color: #fff;
        padding: 0.75rem 1.2rem;
        border-radius: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        font-size: 1.05rem;
        letter-spacing: 0.4px;
    }

    .form-label {
        font-weight: 500;
        font-size: 0.99rem;
        margin-bottom: 0.25rem;
        color: #243b53;
        letter-spacing: 0.02rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .form-control {
        border-radius: 9px !important;
        box-shadow: 0 1px 4px rgba(32, 66, 102, 0.04);
        border: 1px solid #dceef8;
        font-size: 0.98rem;
        padding: 7px 12px;
    }

        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 2px #71eeb888;
            background: #f2fffa;
        }

    /* Center SMS popup */
    .sms-message {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 14px 26px;
        border-radius: 14px;
        box-shadow: 0 4px 18px rgba(0,0,0,0.35);
        font-size: 1rem;
        font-weight: 600;
        z-index: 5000;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 220px;
    }

        .sms-message.hide {
            opacity: 0;
        }

    .sms-success {
        background: #1e7e34;
        color: #ffffff;
    }

    .sms-danger {
        background: #b91c1c;
        color: #ffffff;
    }

    .sms-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    #customersTable tbody tr {
        cursor: pointer;
    }

        #customersTable tbody tr:hover,
        #customersTable tbody tr.row-hover {
            background-color: #eaffea !important;
            transition: background-color .12s ease;
        }

        #customersTable tbody tr.row-selected,
        #customersTable tbody tr.row-selected > td {
            background-color: #c9f7c9 !important;
            box-shadow: inset 0 0 0 2px rgba(40,167,69,.35) !important;
        }

    #customersTable:focus {
        outline: 2px solid rgba(40,167,69,.35);
        outline-offset: 2px;
    }

    @@media (max-width: 768px) {
        .form-card, .list-card {
            padding: 1rem 0.8rem;
        }

        .form-card-header {
            font-size: 0.95rem;
        }
    }</style>
