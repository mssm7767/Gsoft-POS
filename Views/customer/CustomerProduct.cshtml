@{
    ViewData["Title"] = "My Products";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
    /* ===== PRODUCT LIST ===== */
    .product-list-item {
        background: #ffffff;
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        transition: 0.2s;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }

        .product-list-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.09);
        }

    .product-thumb {
        width: 80px;
        height: 80px;
        border-radius: 10px;
        object-fit: cover;
        margin-bottom: 10px;
    }

    .qty-badge {
        min-width: 60px;
        text-align: center;
    }

    #scanner {
        width: 100%;
        max-width: 480px;
        margin: 12px auto;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
    }

    .qty-input, .shop-input, .desc-input {
        width: 100%;
        min-width: 100px;
    }

    /* ===== RESPONSIVE ===== */
    @@media (max-width: 768px) {
        .product-list-item

    {
        flex-direction: column !important;
        text-align: center;
        padding: 15px !important;
    }

    .product-thumb {
        width: 100px !important;
        height: 100px !important;
    }

    }

    /* ===== TABLE ===== */
    .table-responsive {
        overflow-x: auto;
    }

    .btn {
        white-space: nowrap;
    }


    /* Table heading font size */
    #saleTable thead th {
        font-size: 0.9rem; /* smaller font for headings */
    }

    /* Prevent table heading text from wrapping */
    #saleTable thead th {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis; /* show ... if too long */
        font-size: 0.9rem; /* your reduced font size */
    }

    /* Optional: reduce font size on small screens */
    @@media (max-width: 576px) {
        #saleTable thead th

    {
        font-size: 0.8rem;
    }

    }
</style>

<div class="container-fluid py-4">

    <!-- PAGE TITLE -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary">
            <i class="fa-solid fa-box-user"></i> My Purchased Products
        </h3>

        <div class="mt-2 mt-md-0">
            <button class="btn btn-dark" id="scanBtn">
                <i class="fa-solid fa-barcode"></i> Scan Product Barcode
            </button>
        </div>
    </div>

    <!-- SCANNER -->
    <div id="scannerWrapper" style="display:none;" class="text-center mb-3">
        <div id="scanner"></div>
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-danger" id="stopScanner">Stop Scanner</button>
        </div>
    </div>

    <!-- PRODUCT LIST -->
    <!-- PRODUCT LIST -->
    <div id="productList" class="row g-3">
        @if (ViewBag.CustomerItems != null)
        {
            foreach (var item in ViewBag.CustomerItems)
            {
                <div class="col-12">
                    <div class="product-list-item"
                         data-itemId="@item.ItemId"
                         data-customerId="@item.CustomerId"
                         data-name="@item.ItemName"
                         data-price="@item.Price"
                         data-date="@(item.PurchaseDate?.ToString("yyyy-MM-dd") ?? "")"
                         data-code="@item.ItemCode"
                         data-quantity="@item.Quantity">

                        <img src="@Url.Content("~" + item.ImagePath)" class="product-thumb me-3" />

                        <div class="flex-grow-1 d-flex flex-column justify-content-center">
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <h5 class="fw-semibold mb-0">@item.ItemName</h5>
                                <span class="badge rounded-pill bg-primary px-3 py-2 qty-badge">
                                    Qty: @item.Quantity
                                </span>
                            </div>
                            <p class="text-muted mb-1">Purchased: @item.PurchaseDate</p>
                            <p class="fw-bold text-success mb-0">Rs. @item.Price</p>
                        </div>
                    </div>
                </div>
            }
        }
    </div>


    <!-- SALE TABLE -->
    <h5 class="mt-4">Sale Items</h5>
    <div class="table-responsive">
        <table class="table table-bordered" id="saleTable">
            <thead class="table-light">
                <tr>
                    <th>Item Name</th>
                    <th>Item Code</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Shop Name</th>
                    <th>Description</th>
                    <th>Remove</th>
                </tr>
            </thead>
            <tbody>
                <!-- dynamically added rows -->
            </tbody>
        </table>
    </div>

    <div class="mt-2">
        <button class="btn btn-success" id="submitSale">Submit Sale</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let html5QrCode;
    const scanBtn = document.getElementById('scanBtn');
    const scannerWrapper = document.getElementById('scannerWrapper');
    const stopScannerBtn = document.getElementById('stopScanner');
    const saleTableBody = document.querySelector('#saleTable tbody');

    function playBeep() {
        const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        audio.play().catch(err => console.warn(err));
    }

    scanBtn.addEventListener('click', async () => {
        scannerWrapper.style.display = 'block';
        if (html5QrCode) { try { await html5QrCode.stop(); } catch(e){} html5QrCode.clear(); }
        html5QrCode = new Html5Qrcode("scanner");
        const config = { fps: 10, qrbox: { width: 250, height: 150 } };

        try {
            await html5QrCode.start({ facingMode: { exact: "environment" } }, config,
                qrCodeMessage => handleScannedCode(qrCodeMessage),
                () => {});
        } catch {
            try {
                await html5QrCode.start({ facingMode: "environment" }, config,
                    qrCodeMessage => handleScannedCode(qrCodeMessage),
                    () => {});
            } catch {
                alert('Unable to start camera.');
            }
        }
    });

    stopScannerBtn.addEventListener('click', async () => {
        if (html5QrCode) { try { await html5QrCode.stop(); } catch(e){} html5QrCode.clear(); }
        scannerWrapper.style.display = 'none';
    });

    function handleScannedCode(code){
        try{ if(html5QrCode){ html5QrCode.stop().catch(()=>{}); html5QrCode.clear(); } } catch{}
        scannerWrapper.style.display = 'none';
        const normalized = (code||'').trim();
        const rows = document.querySelectorAll('.product-row');
        let found = null;

        for(const r of rows){ if((r.dataset.code||'')===normalized){ found=r; break; } }
        if(!found){ for(const r of rows){ if((r.dataset.code||'').length && normalized.includes(r.dataset.code)){ found=r; break; } } }
        if(!found){ alert('Product not found: '+normalized); return; }

        const product = {
            id: found.dataset.itemid,
            customerId: found.dataset.customerid,
            name: found.dataset.name,
            code: found.dataset.code,
            price: found.dataset.price,
            qty: 1
        };

        playBeep();
        addProductToSaleTable(product);
    }

    function addProductToSaleTable(product){
        let existingRow = Array.from(saleTableBody.children).find(tr => tr.dataset.code===product.code);
        if(existingRow){
            let qtyInput = existingRow.querySelector('.qty-input');
            qtyInput.value = parseInt(qtyInput.value)+1;
            qtyInput.focus();
            return;
        }

        const tr = document.createElement('tr');
        tr.dataset.code = product.code;
        tr.dataset.id = product.id;
        tr.dataset.customerid = product.customerId;
        tr.classList.add('sale-row');
        tr.innerHTML = `
            <td>${product.name}</td>
            <td>${product.code}</td>
            <td>${product.price}</td>
            <td><input type="number" class="form-control qty-input" value="${product.qty}" min="1" /></td>
            <td><input type="text" class="form-control shop-input" placeholder="Shop Name" /></td>
            <td><input type="text" class="form-control desc-input" placeholder="Description" /></td>
            <td><button type="button" class="btn btn-sm btn-danger remove-btn">Remove</button></td>
        `;

        tr.querySelector('.qty-input').focus();
        tr.querySelector('.remove-btn').addEventListener('click', ()=> tr.remove());

        saleTableBody.appendChild(tr);
    }

    document.getElementById('submitSale').addEventListener('click', () => {
        const saleData = Array.from(document.querySelectorAll('.sale-row')).map(row => ({
            ItemId: parseInt(row.dataset.id),
            CustomerId: parseInt(row.dataset.customerid),
            ItemCode: row.dataset.code,
            Quantity: parseInt(row.querySelector('.qty-input').value),
            ShopName: row.querySelector('.shop-input').value,
            Description: row.querySelector('.desc-input').value
        }));

        fetch('/Customer/SellProductsBatch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(saleData)
        })
        .then(res => { if (!res.ok) throw new Error('Server error'); return res.json(); })
        .then(data => {
            Swal.fire({ icon: 'success', title: 'Sale Submitted!', text: 'Your sale has been recorded.', timer: 2000, showConfirmButton: false });
            setTimeout(() => window.location.reload(), 2000);
        })
        .catch(err => Swal.fire({ icon: 'error', title: 'Error!', text: err.message }));
    });
</script>
