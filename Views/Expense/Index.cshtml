@model List<GSoftPosNew.Models.Expense>

@{
    ViewData["Title"] = "Expense List";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-5">
    <div class="card border-0 shadow-lg rounded-4">
        <div class="card-header bg-gradient bg-primary text-white d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0 fw-semibold">
                <i class="fa fa-list me-2"></i> Expense List
            </h5>
            <div>
                <a asp-action="Create" class="btn btn-light btn-sm fw-semibold">
                    <i class="fa fa-plus-circle me-1"></i> Add Expense
                </a>
            </div>
        </div>

        <!-- Success Alert -->
        @if (TempData["Message"] != null)
        {
            <div class="alert alert-success text-center m-3" id="success-alert">
                <i class="fa fa-check-circle"></i> @TempData["Message"]
            </div>
        }

        <div class="card-body">
            <!-- Filter Section -->
            <form method="get" asp-action="Index" class="row g-3 align-items-end mb-3">
                <div class="col-md-4">
                    <label for="CategoryFilter" class="form-label fw-semibold">Filter by Category</label>
                    <select id="CategoryFilter" name="categoryId" class="form-select">
                        <option value="">-- All Categories --</option>
                        @foreach (var category in ViewBag.Categories as List<ExpenseCategory>)
                        {
                            var isSelected = ViewBag.SelectedCategoryId != null && ViewBag.SelectedCategoryId == category.Id;
                            @Html.Raw($"<option value='{category.Id}' {(isSelected ? "selected" : "")}>{category.CategoryName}</option>")
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="fromDate" class="form-label fw-semibold">From Date</label>
                    <input type="date" class="form-control" id="fromDate" name="fromDate"
                           value="@(ViewBag.FromDate != null ? ((DateTime)ViewBag.FromDate).ToString("yyyy-MM-dd") : "")" />
                </div>

                <div class="col-md-3">
                    <label for="toDate" class="form-label fw-semibold">To Date</label>
                    <input type="date" class="form-control" id="toDate" name="toDate"
                           value="@(ViewBag.ToDate != null ? ((DateTime)ViewBag.ToDate).ToString("yyyy-MM-dd") : "")" />
                </div>
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-filter me-1"></i> Apply
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="fa fa-sync-alt me-1"></i> Reset
                    </a>
                </div>
            </form>

            <!-- Expense Table -->
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle text-sm">
                        <thead class="table-primary text-center">
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Reference #</th>
                                <th>Expense For</th>
                                <th class="text-end">Amount (Rs)</th>
                                <th>Note</th>
                                <th>Created By</th>
                                <th style="width:120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>@item.ExpenseDate.ToString("yyyy-MM-dd")</td>
                                    <td>@item.ExpenseCategory?.CategoryName</td>
                                    <td>@item.ReferenceNumber</td>
                                    <td>@item.ExpenseFor</td>
                                    <td class="text-end fw-semibold">@item.Amount.ToString("N2")</td>
                                    <td>@item.Note</td>
                                    <td>@item.CreatedBy</td>
                                    <td class="text-center">
                                        <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-warning me-1" title="Edit">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-sm btn-outline-danger" 
                                           onclick="return confirm('Are you sure you want to delete this expense?');" title="Delete">
                                            <i class="fa fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="fw-bold">
                            <tr>
                                <td colspan="4" class="text-end">Total:</td>
                                <td class="text-end">@ViewBag.TotalAmount.ToString("N2")</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Pagination -->
                <nav aria-label="Expense pagination" class="mt-3">
                    <ul class="pagination justify-content-center">
                        @{
                            int currentPage = ViewBag.CurrentPage;
                            int totalPages = ViewBag.TotalPages;
                            int prevPage = currentPage - 1;
                            int nextPage = currentPage + 1;
                        }

                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", new { categoryId = ViewBag.SelectedCategoryId, fromDate = ViewBag.FromDate?.ToString("yyyy-MM-dd"), toDate = ViewBag.ToDate?.ToString("yyyy-MM-dd"), page = prevPage })">
                                &laquo;
                            </a>
                        </li>

                        @for (int i = 1; i <= totalPages; i++)
                        {
                            <li class="page-item @(i == currentPage ? "active" : "")">
                                <a class="page-link"
                                   href="@Url.Action("Index", new { categoryId = ViewBag.SelectedCategoryId, fromDate = ViewBag.FromDate?.ToString("yyyy-MM-dd"), toDate = ViewBag.ToDate?.ToString("yyyy-MM-dd"), page = i })">
                                    @i
                                </a>
                            </li>
                        }

                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("Index", new { categoryId = ViewBag.SelectedCategoryId, fromDate = ViewBag.FromDate?.ToString("yyyy-MM-dd"), toDate = ViewBag.ToDate?.ToString("yyyy-MM-dd"), page = nextPage })">
                                &raquo;
                            </a>
                        </li>
                    </ul>
                </nav>
            }
            else
            {
                <div class="alert alert-info text-center">
                    <i class="fa fa-info-circle"></i> No expenses found.
                </div>
            }
        </div>
    </div>
</div>

<!-- Auto-hide success alert -->
<script>
    setTimeout(() => {
        const alertBox = document.getElementById("success-alert");
        if (alertBox) {
            alertBox.style.transition = "opacity 0.5s ease";
            alertBox.style.opacity = "0";
            setTimeout(() => alertBox.remove(), 500);
        }
    }, 2500);
</script>
